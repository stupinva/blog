<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="pppd,gprs,bluetooth,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2009-05-04 -->
		<title>Настройка GPRS (Sony Ericsson K530i) в Linux (Debian) через Bluetooth-контроллер</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка GPRS (Sony Ericsson K530i) в Linux (Debian) через Bluetooth-контроллер</h1>

		<p>В предыдущей статье я настроил доступ в Internet по GPRS через USB-кабель телефона. В той статье также описана настройка доступа через Bluetooth-интерфейс.</p>

		<p>28 апреля я из чистого интереса к новым технологиям решил купить Bluetooth-контроллер. Я прошёлся по сайтам местных магазинов и выписал все Bluetooth-контроллеры, которые были в наличии. Их было довольно много и естественно я не знал, какой из них мне выбрать. Выбирать по внешнему виду, цвету и цене было бы глупо. Хотя, я думаю, большинство покупателей интересуют только эти характеристики :)</p>

		<p>Я пошёл другим путём и решил ознакомиться с матчастью. После нескольких часов гугления характеристик контроллеров и чтения статей по Bluetooth вообще, я определился, каким должен быть контроллер, который я хочу купить. Он должен быть:</p>

		<ol>
			<li>Первого класса. Устройства первого класса имеют самый мощный передатчик, который в условиях прямой видимости, наименьшей радиозашумлённости среды должен обеспечивать связь на расстоянии до 100м. В домашних условиях, когда имеются стены, перекрытия, работают радио и электроприборы, дальность связи может падать до десятков метров, однако устройства второго или третьего класса в таких условиях обеспечивают ещё меньшую дальность радиосвязи.</li>

			<li>Поддерживать стандарт Bluetooth 2.0 как минимум. Данный стандарт позволяет осуществлять обмен данными на скорости до 3 мегабит в секунду. Опять же, скорость обмена во многом определяется наличием перекрытий, дальностью между источником и приёмником, от зашумлённости радиосреды, от наличия в зоне радиосвязи других Bluetooth-устройств и их активности, а также снижается из-за накладных расходов на передачу служебной информации.</li>

			<li>Иметь интерфейс USB 2.0. В принципе, USB 2.0 отличается от USB 1.0 (или 1.1) наличием дополнительной скорости приёма-передачи - 25-480 мегабит в секунду, поэтому для обслуживания радиопередатчика, работающего на скорости 3 мегабита в секунду было бы достаточно и разъёма USB 1.0 (1.1), но душе было угодно пользоваться именно USB 2.0 :)</li>

			<li>Поддерживать как можно больше Bluetooth-профилей. Bluetooth-профиль - это разновидность сервиса, который может поддерживать Bluetooth-устройство. Это могут быть сервисы передачи файлов (OBEX), модемный сервис (DUN), передача звуковой информации (A2DP) и тому подобные сервисы. Самое главное - должны поддерживаться синхронный (SCO) и асинхронный (ACL) режимы передачи данных. Синхронный режим предназначен для передачи аудио-информации, передаваемые пакеты в нём не подтверждаются, поэтому потерянные при передаче данные не передаются повторно. В асинхронном режиме осуществляется подтверждение приёма информации, этот режим ориентирован на передачу разнородных данных.</li>

			<li>Должен работать в Linux. Тут всё понятно и без слов.</li>
		</ol>

		<p>Больше всего по этим параметрам мне приглянулся контроллер Tekram TM-308, который я и приобрёл в тот же день.</p>

		<p>Итак, вставляем Bluetooth-контроллер в USB-разъём. Устанавливаем служебные программы для работы с Bluetooth-устройствами:</p>

		<pre class="console"># aptitude install bluez-utils</pre>

		<p>И подгружаем модуль ядра для работы с Bluetooth-устройствами:</p>

		<pre class="console"># modprobe hci_usb</pre>

		<p>Открываем на редактирование файл /etc/bluetooth/hcid.conf и приводим его к следующему виду:</p>

		<pre class="code">options {
  autoinit yes;
  security auto;
  pairing multi;
  passkey "<b>1234</b>";
}</pre>

		<p>Где <b>1234</b> - PIN-код, который будет использоваться для получения доступа к компьютеру. Это может быть довольно длинный пароль из латинских букв в разном регистре, цифр и знаков препинания.</p>

		<p>Запускаем службу Bluetooth:</p>

		<pre class="console"># /etc/init.d/bluetooth start</pre>

		<p>Теперь нужно найти телефон. Активируем Bluettoth на телефоне. Запускаем поиск Bluetooth-устройств, находящихся поблизости:</p>

		<pre class="console">$ hcitool scan</pre>

		<p>Должно найтись устройство, соответствующее вашему телефону. На телефоне можно выставить Bluetooth-имя устройства. Если вы не выставляли его сами, то скорее всего именем будет модель телефона.</p>

		<p>Выписываем MAC-адрес, соответствующий телефону. MAC-адрес моего телефона - <b>00:21:9E:1D:A5:17</b>, далее в статье будет фигурировать он.</p>

		<p>Запускаем перечислтель профилей Bluetooth, поддерживаемых устройством.</p>

		<pre class="console">$ sdptool browse <b>00:21:9E:1D:A5:17</b></pre>

		<p>В выдаче нужно найти номер канала, соответствующего профилю DUN или Dialup Networking. Если вы не нашли профиль DUN или Dialup Networking, то можно воспользоваться профилем NAP или PAN, хотя он предназначен для создания локальной сети из нескольких Bluetooth-устройств.</p>

		<p>Теперь приведём файл /etc/bluetooth/rfcomm.conf в соответствии с найденными MAC-адресом и каналом. У меня получилось вот так:</p>

		<pre class="code"><b>rfcomm0</b> {
  bind yes;
  device <b>00:21:9E:1D:A5:17</b>;
  channel <b>2</b>;
  comment "Dial-up networking gateway";
}</pre>

		<p>Где <b>00:21:9E:1D:A5:17</b> - MAC-адрес телефона, а <b>2</b> - номер профиля DUN.</p>

		<p>Проводим первичное подключение к телефону с помощью команды:</p>

		<pre class="console">$ rfcomm connect <b>0</b> <b>00:21:9E:1D:A5:17</b> <b>2</b></pre>

		<p>Где <b>0</b> - номер устройства /dev/<b>rfcomm0</b>, <b>00:21:9E:1D:A5:17</b> - MAC-адрес телефона и <b>2</b> - номер канала DUN.</p>

		<p>После выполнения этой команды телефон запросит разрешение на подключение со стороны компьютера. Нужно ввести PIN-код, который мы прописали в соответствие телефону в файле /etc/bluetooth/hcid.conf и указать опцию - "разрешать автоматическое подключение".</p>

		<p>Теперь осталось исправить название устройства в файле /etc/ppp/peers/megafon и прописать вместо оставшегося там с прошлой статьи устройства ttyACM0 устройство <b>rfcomm0</b>.</p>

		<p>Теперь можно установить GPRS-подключение в Интернет:</p>

		<pre class="console"># pon megafon</pre>

		<p>Отключиться можно как и прежде:</p>

		<pre class="console"># poff megafon</pre>

		<p>Использованные пр подготовке статьи материалы:</p>

		<ol>
			<li><a href="http://ru.wikipedia.org/wiki/Bluetooth">Bluetooth - Википедия</a> - статья в Википедии, где описаны классы и профили Bluetooth</li>

			<li><a href="http://ru.wikibooks.org/wiki/Подключение_GPRS/EDGE_в_GNU/Linux">Подключение GPRS/EDGE в GNU/Linux</a> - статья, по которой была написана моя прошлая заметка</li>

			<li><a href="../k530i-gprs/">Настройка GPRS (Sony Ericsson K530i) в Linux (Debian)</a> - моя прошлая заметка</li>

			<li><a href="http://subscribe.ru/archive/industry.mcomm.gsmr/200808/14001306.html">Bluesnarfing</a> - взлом Bluetooth-устройств с помощью направленной антенны</li>
		</ol>

		<p>P.S. Следует заметить, что из той же статьи на википедии явно видно, что защита соединения паролем по сути бесполезна. Она может остановить непрофессионала, однако профессионал, хорошо разбирающийся в Bluetooth, сможет в считанные секунды подобрать пароль, защищающий подключение. Это следует хорошо понимать. Главной защитой здесь может быть только достаточно большое расстояние между злоумышленником и вашими Bluetooth-устройствами. Однако опять же, судя по статье по последней ссылке, взломщики весьма изобретательны и уже существуют направленные Bluetooth-антенны, позволяющие при соответствующей наводке устанавливать связь с Bluetooth-устройствами на значительные расстояния до нескольких сотен метров.</p>

		<p>P.P.S. Одним из интересных и, на мой взгляд, спорных моментов Bluetooth-стека в Linux, является жёсткая привязка к подсистеме D-Bus. В FreeBSD и NetBSD такой привязки нет.</p>

		<p>Одной из особенностей современных операционных систем на базе Linux является довольно интересное противоречие подходов к разработке системы. Существует как бы два лагеря разработчиков Linux: условно назовём их системщиками и прикладниками. Системщики хорошо помнят ценности Unix и продолжают вести разработки в духе Unix, прикладники по большей части духа Unix не чувствуют и делают в основном так, чтобы было не хуже чем в Windows. Работая с Linux'ом можно понять, что существует два Linux'а: пропитанный Unix-традициями консольный неразговорчивый Linux-раб и гламурный и дружественный Linux-приятель. Если вы знаете Linux только со стороны Gnome или KDE, в большинстве случаев можно с большой уверенностью сказать, что собственно Linux вы и не знаете - вам знакома лишь его оболочка, которая совершенна ему чужда.</p>

		<p>В последнее время наблюдается взаимопроникновение этих двух подходов разработки. Одним из таких сигналов является привязка подсистемы D-Bus к Bluetooth-стеку. Другим характерным сигналом является привязка X-сервера к уровню абстракции от оборудования HAL, тоже работающему только совместно с D-Bus. Проблема в том, что прикладники постепенно портят всё то, что нравится в Linux системщикам. Следует заметить, что эта тема волнует не меня одного. Например прямо на этой неделе в рассылке russian-debian уже поднималась эта тема: </p>

		<p><a href="http://www.mail-archive.com/debian-russian@lists.debian.org/msg92522.html">xserver-xorg и hal</a></p>

		<p>Эта тенденция довольно печальна и периодически заставляет задумываться о необходимости поиска и освоения "более других" систем...</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка GPRS (Sony Ericsson K530i) в Linux (Debian) через Bluetooth-контроллер">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
