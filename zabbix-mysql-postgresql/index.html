<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="pgloader,jessie,zabbix,postgresql,debian,linux,mysql,php-fpm" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2015-07-12 -->
		<title>Миграция Zabbix с MySQL на PostgreSQL</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Миграция Zabbix с MySQL на PostgreSQL</h1>

		<p>Периодически замечал в iotop на своём домашнем компьютере, что самую высокую нагрузку по вводу-выводу создаёт MySQL. В интернете встречал мнения, что PostgreSQL по сравнению с MySQL более стабильно ведёт себя в условиях дефицита производительности дисковой подсистемы. Больше всего MySQL на этом компьютере нагружался Zabbix'ом, поэтому ради эксперимента решил попробовать перевести Zabbix на использование PostgreSQL.</p>

		<p>Довольно долго я пытался экспортировать данные из MySQL при помощи штатного инструмента mysqldump в виде, пригодном для последующего экспорта в PostgreSQL. У этой утилиты имеется опция, позволяющая экспортировать в формате, совместимом с PostgreSQL. Несколько дополнительных опций, чтобы отключить директивы, отключить создание таблиц, добавить явные имена колонок в запросы INSERT, позволили получить результат с виду пригодный для импорта в PostgreSQL.</p>

		<p>Тут, однако, возникла проблема. Данные таблиц в дампе шли в порядке, соответствюущем алфавитному порядку имён таблиц. Это вызывало проблемы с обработкой внешних ключей. Почему-то на тот момент я не догадался заглянуть в файл scheme.sql и создавал схему базы данных сразу с ограничениями и внешними ключами. Для решения этой проблемы я написал скрипт, который брал информацию о внешних ключах из базы данных information_schema и сортировал таблицы так, чтобы ссылающиеся таблицы шли после тех, на которые они ссылаются. Экспортировал данные я именно в этом порядке.</p>

		<p>Однако когда проблема с внешними ключами была решена не самым простым путём, всплыло несколько досадных мелочей:</p>

		<ul>
			<li>в полученном дампе внутри одинарных кавычек двойные кавычки экранировались обратным слэшем, в то время как PostgreSQL принимал их без экранирования,</li>

			<li>одинарные кавычки в тех же строках тоже экранировались обратным слэшем, но PostgreSQL ждал, что они просто будут продублированы,</li>

			<li>двоичные данные сохранялись в виде закавыченной последовательности байтов, в то время как PostgreSQL ждал двоичные данные в виде шестнадцатеричных цифр с префиксом 0x.</li>
		</ul>

		<p>Попытки воспользоваться sed'ом для исправления недостатков не привели к успеху и я решил попробовать pgloader.</p>

		<p>После продолжительных мучений с документацией pgloader и PostgreSQL в поисках правильной обработки зависимостей внешних ключей, я наконец-то догадался заглянуть в файл schema.sql и поделил его на две части. После этого pgloader отработал без запинки. Получившимся рецептом миграции и спешу поделиться.</p>

		<p>Стоит отметить, что такой прямолинейный способ миграции не подойдёт, если база данных очень большая или на диске нет места для второй копии базы данных. В этом случае нужно думать о поэтапной миграции, так чтобы минимизировать простой системы мониторинга и суметь справиться с недостатком места на дисках.</p>

		<h2>1. Установка пакетов</h2>

		<p>Установим СУБД, если она ещё не установлена:</p>

		<pre class="console"># apt-get install postgresql</pre>

		<p>Установим пакет pgloader, с помощью которого будем переносить содержимое базы из MySQL в PostgreSQL:</p>

		<pre class="console"># apt-get install pgloader</pre>

		<p>Доустановим пакет для работы веб-интерфейса с СУБД PostgreSQL:</p>

		<pre class="console"># apt-get install php5-pgsql</pre>

		<p>Чтобы новый модуль можно было использовать из PHP, перезапустим php5-fpm:</p>

		<pre class="console"># systemctl restart php5-fpm</pre>

		<h2>2. Подготовка СУБД</h2>

		<p>Правим файл конфигурации аутентификации пользователей /etc/postgresql/9.4/pg_hba.conf, заменяя первую строку на вторую:</p>

		<pre class="code"><strike>local   all             all                                     peer</strike>
local   all             all                                     md5</pre>

		<p>По умолчанию, при подключении к UNIX-сокету, PostgreSQL определяет учётную запись, под которой работает подключившийся процесс и автоматически создаёт подключение от имени одноимённого пользователя из СУБД. Пароль при этом не запрашивается. Меняя эту строчку, мы будем требовать у подключившегося процесса явным образом указать имя пользователя СУБД и его пароль.</p>

		<p>После этого перезапустим сервер базы данных, чтобы новые настройки вступили в силу:</p>

		<pre class="console"># systemctl restart postgresql</pre>

		<p>Теперь из сеанса пользователя root заходим под пользователем postgres:</p>

		<pre class="console"># su - postgres</pre>

		<p>От имени пользователя postgres создаём пользователя базы данных с именем zabbix:</p>

		<pre class="console">$ createuser -P zabbix</pre>

		<p>Ключ -P означает, что будет запрошен пароль нового пользователя.</p>

		<p>От имени пользователя postgres создаём саму базу данных с именем zabbix, владеть которой будет только что созданный пользователь с именем zabbix:</p>

		<pre class="console">$ createdb -E UTF-8 -O zabbix zabbix</pre>

		<p>Опция -E UTF-8 означает, что текстовая информация в базе данных будет храниться в кодировке UTF-8, а опция -O задаёт пользователя, который будет владельцем базы данных.</p>

		<h2>3. Подготовка к переносу данных</h2>

		<p>Теперь возьмём файл database/postgresql/schema.sql, имеющийся в дистрибутиве Zabbix и поделим его на две части. В первой части будут запросы, создающие таблицы (CREATE TABLE), а во второй - создающие внешние ключи и ограничения (ALTER TABLE). Назовём эти файлы schema1.sql и schema2.sql</p>

		<p>Создадим файл zabbix.load, содержащий настройки для переноса данных:</p>

		<pre class="code">LOAD DATABASE
  FROM mysql://zabbix:zabbix_password@localhost/zabbix
  INTO postgresql://zabbix:zabbix_password@localhost/zabbix

WITH include no drop,
     truncate,
     create no tables,
     create no indexes,
     no foreign keys,
     reset sequences,
     data only

SET maintenance_work_mem TO '128MB',
    work_mem to '12MB'

BEFORE LOAD EXECUTE schema1.sql

AFTER LOAD EXECUTE schema2.sql;</pre>

		<p>Подготовим пакет с Zabbix-сервером, работающим с PostgreSQL или подключим репозиторий с этим пакетом. Как это сделать - решайте сами.</p>

		<h2>4. Перенос данных</h2>

		<p>Перед переносом данных остановим Zabbix-сервер:</p>

		<pre class="console"># systemctl stop zabbix-server</pre>

		<p>Закроем доступ к веб-интерфейсу Zabbix, остановив php5-fpm (можно просто запретить доступ к веб-интерфейсу Zabbix через настройки nginx):</p>

		<pre class="console"># systemctl stop php5-fpm</pre>

		<p>Теперь приступим к собственно переносу данных (в текущем каталоге должны быть подготовленные ранее файлы schema1.sql, schema2.sql, zabbix.load):</p>

		<pre class="console">$ pgload zabbix.load</pre>

		<p>Пока данные переносятся, удалим старый Zabbix-сервер для MySQL:</p>

		<pre class="console"># dpkg -r zabbix-server-mysql</pre>

		<p>Установим Zabbix-сервер для PostgreSQL :</p>

		<pre class="console"># dpkg -i zabbix-server-pgsql_2.4.5-1+jessie_amd64.deb</pre>

		<p>Теперь, если данные уже перенеслись, можно запускать новый Zabbix-сервер:</p>

		<pre class="console"># systemctl start zabbix-server</pre>

		<p>Отредактируем файл /etc/zabbix/web/zabbix.conf.php, заменив первую строчку на вторую:</p>

		<pre class="code"><strike>$DB['TYPE']     = 'MYSQL';</strike>
$DB['TYPE']     = 'POSTGRESQL';</pre>

		<p>Запускаем php5-fpm (или открываем доступ к веб-интерфейсу Zabbix через настройки nginx):</p>

		<pre class="console"># systemctl start php5-fpm</pre>

		<h2>5. Проверка результата</h2>

		<p>Заглядываем в журналы Zabbix-сервера /var/log/zabbix/zabbix_server.log и заходим в веб-интерфейс Zabbix, проверяя, что всё работает нормально.</p>

		<p>Кстати, наблюдение за нагрузкой на дисковую подсистему по такому не совсем чёткому параметру как iowait, показало, что нагрузка действительно упала:</p>

		<img src="zabbix_postgresql.png" />

		<p><a href="mailto:vladimir@stupin.su?subject=Миграция Zabbix с MySQL на PostgreSQL">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
