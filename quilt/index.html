<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="quilt,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2019-12-22 -->
		<title>Использование quilt для подготовки заплат</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Использование quilt для подготовки заплат</h1>

		<p>В прошлом я уже описывал несколько заплаток, которые накладываю на Zabbix для решения различных проблем:</p>

		<ul>
			<li><a href="../zabbix220/">Установка и настройка Zabbix 2.2.0 в Debian Wheezy</a></li>

			<li><a href="../zabbix-manual-close-troubles/">Исправление ручного закрытия проблем в Zabbix 3.4</a></li>
		</ul>

		<p>Кроме этих описанных заплаток имеется ещё несколько специфичных заплаток, которые следаны для интеграции Zabbix со сторонними системами и нигде не описаны, т.к. вряд-ли кого-то заинтересуют.</p>

		<p>Кроме того, накладывать заплатки приходится не только на сам Zabbix, но и на связанные с ним библиотеки:</p>

		<ul>
			<li><a href="../zabbix-libiksemel-trouble/">Пересборка libiksemel для решения проблемы JABBER tls handshake failed в Zabbix</a></li>

			<li><a href="../net-snmp-snmpv3-trouble/">Стандарт SNMPv3 и суровая действительность USM_TIME_WINDOW</a></li>
		</ul>

		<p>Правки приходится делать в разных пакетах, не только связанных непосредственно с Zabbix, из-за чего я даже завёл репозиторий для доработанных пакетов. В заметке <a href="../aptly/">Создание своего репозитория Debian при помощи aptly</a> можно найти ещё несколько примеров доработанных пакетов, доработке некоторых из которых были посвящены отдельные заметки.</p>

		<p>Количество специфичных заплаток для Zabbix, с которыми приходится работать, со временем только увеличивается. Если aptly помогает упорядочить работу с большим количеством нестандартных пакетов, то quilt помогает упорядочить работу с большим количеством заплаток одного и того же пакета.</p>

		<p>quilt формирует из заплаток стек, позволяя легко вносить обновления в любую из заплаток стека. Для обновления заплатки, погребённой под более поздними, можно отменить изменения, вносимые в исходный код заплатками, лежащими сверху, внести изменения в исходный код, обновить текущую заплатку, а потом снова наложить на код все вышестоящие заплатки.</p>

		<p>Ниже кратко описаны основные команды quilt, которые могут пригодиться для управления заплатками.</p>

		<p>Создаём новую заплатку:</p>

		<pre class="console">$ quilt new permit-edit-maintenances</pre>

		<p>Добавляем в заплатку файлу, которые собираемся менять:</p>

		<pre class="console">$ quilt add frontends/php/maintenance.php
$ quilt add frontends/php/include/classes/api/services/CMaintenance.php</pre>

		<p>Посмотреть список файлов, содержимое которых будет отслеживаться в заплате, можно при помощи команды:</p>

		<pre class="console">$ quilt files</pre>

		<p>Чтобы изменения в файлах не отслеживались в заплате, можно воспользоваться такой командой:</p>

		<pre class="console">$ quilt remove config.guess config.sub database/mysql/create.sql database/postgresql/create.sql database/sqlite3/create.sql</pre>

		<p>Редактируем файлы:</p>

		<pre class="console">$ vim frontends/php/maintenance.php
$ vim frontends/php/include/classes/api/services/CMaintenance.php</pre>

		<p>Посмотреть получившуюся заплатку можно при помощи следующей команды:</p>

		<pre class="console">$ quilt diff</pre>

		<p>Сохранить получившуюся заплатку в каталог debian/patches можно при помощи следующей команды:</p>

		<pre class="console">$ quilt refresh</pre>

		<p>Список всех заплаток можно посмотреть при помощи команды:</p>

		<pre class="console">$ quilt series</pre>

		<p>Текущая редактируемая заплата в выведенном списке будет подсвечена.</p>

		<p>При необходимости редактировать не последнюю заплатку, можно перемещаться по списку заплат. Для перемещения по списку на предыдущую заплату можно воспользоваться командой:</p>

		<pre class="console">$ quilt pop</pre>

		<p>Для применения текущей заплаты и для перехода к следующей по списку можно воспользоваться командой:</p>

		<pre class="console">$ quilt push</pre>

		<p>Импорт заплатки из внешнего источинка осуществяется следующим образом:</p>

		<pre class="console">$ quilt import zabbix3_4_12_permit_edit_maintenances.patch</pre>

		<p>Сразу после импорта заплатку нужно применить:</p>

		<pre class="console">$ quilt push</pre>

		<p>Не стоит продолжать импорт заплаток без применения, т.к. применяться они будут в обратном порядке - послденяя импортированная будет первой применённой. Это сбивает с толку и может вызывать проблемы, если заплатки зависят друг от друга.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Использование quilt для подготовки заплат">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
