<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="zabbix,freebsd,iostat" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2017-05-28 -->
		<title>Статистика ввода-вывода iostat во FreeBSD через Zabbix</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Статистика ввода-вывода iostat во FreeBSD через Zabbix</h1>

		<p>Для оценки производительности дисковой подсистемы FreeBSD можно воспользоваться утилитой iostat. Однако полную картину нагрузки на дисковую подсистему можно получить только собирая статистику за достаточно долгий срок. Как минимум это сутки, а лучше всего собрать статистику за неделю. По недельной статистике можно легко найти периоды максимальной нагрузки и связать их с периодически выполняющимися в системе задачами. Имея статистику за неделю, можно подобрать оптимальное время запуска процедуры резервного копирования. В этой статье речь пойдёт о том, как собирать статистику от утилиты iostat в Zabbix.</p>

		<p>Для начала изучим документацию на саму команду iostat из состава FreeBSD. Простой вызов команды iostat отображает статистику дисковых устройств вместе со статистикой процессора и терминала. К счастью, у команды iostat имеется несколько опций, полезных для наших целей:</p>

		<ul>
			<li>-d - отображать только статистику по дисковым устройствам,</li>

			<li>-x - отобразить расширенную статистику,</li>

			<li>-I - отображать счётчики нарастающим итогом, а не среднюю статистику за период времени.</li>
		</ul>

		<p>Последняя опция - самая полезная. В интернете можно встретить шаблоны, в которых для сбора статистики команда iostat запускается на определённый интервал времени. У такого подхода есть как минимум два недостатка. Во-первых, в промежутках между запусками iostat статистика не собирается. Во-вторых, из-за того, что команда выполняется долго, используют промежуточный файл, в который периодически сохраняют собранную статистику, а потом извлекают из этого файла с помощью команд grep или awk. В общем, увидев в какой-нибудь очередной статье в интернете такой способ съёма статистики, я морщусь и перехожу к другой статье.</p>

		<p>Команда iostat, вызванная со всеми этими опциями, выведет примерно такой результат:</p>

		<pre class="console"># iostat -dxI
extended device statistics  
device     r/i   w/i    kr/i    kw/i wait svc_t  %b  
mfid0    6994332913.0 13128877288.0 544161035422.5 493573917948.0    0   5.1  18</pre>

		<p>Смысл столбцов такой:</p>

		<ul>
			<li>device - имя файла устройства в файловой системе /dev,</li>

			<li>r/i - количество операций чтения за период времени,</li>

			<li>w/i - количество операций записи за период времени,</li>

			<li>kr/i - прочитано килобайт за период времени,</li>

			<li>kw/i - записано килобайт за период времени,</li>

			<li>wait - длина очереди транзакций,</li>

			<li>svc_t - средняя длительность транзакций в миллисекундах,</li>
			<li>%b - процент времени, когда на устройстве была одна или более невыполненных транзакций.</li>
		</ul>

		<p>Несмотря на то, что указана опция -I, предписывающая выводить накопленные значения счётчиков, числа в последних трёх колонках являются текущими средними значениями. Если судить по страницам руководства на официальном сайте, эти колонки стали показывать накопленные значения счётчиков только начиная с FreeBSD 10: <a href="https://www.freebsd.org/cgi/man.cgi?query=iostat&amp;apropos=0&amp;sektion=0&amp;manpath=FreeBSD+10.0-RELEASE&amp;arch=default&amp;format=html">FreeBSD 10.0-RELEASE iostat(8)</a>. У меня FreeBSD 10 пока нигде нет, поэтому отладить шаблон для соответствующих версий iostat пока возможности не было.</p>

		<p>Добавим в файл конфигурации Zabbix-агента /usr/local/etc/zabbix24/zabbix_agentd.conf следующие строки:</p>

		<pre class="code">UserParameter=iostat.discovery,iostat -dxI | awk 'BEGIN { printf "{\"data\":["; } { if (NR &gt; 3) printf ","; if (NR &gt; 2) printf "{\"{#DEVNAME}\":\"" $1 "\"}"; } END { printf "]}"; }'
UserParameter=iostat.read.ops[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print $$2; }'
UserParameter=iostat.write.ops[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print $$3; }'
UserParameter=iostat.read.bytes[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print 1024 * $$4; }'
UserParameter=iostat.write.bytes[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print 1024 * $$5; }'
UserParameter=iostat.queue.length[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print $$6; }'
UserParameter=iostat.transactions.duration[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print $$7; }'
UserParameter=iostat.busy.duration[*],/usr/sbin/iostat -dxI | awk '$$1 == "$1" { print $$8; }'</pre>

		<p>После внесения изменений в файл конфигурации Zabbix-агента, не забудьте его перезапустить:</p>

		<pre style="background-color: black; color: white"># /usr/local/etc/rc.d/zabbix_agentd restart</pre>

		<p>Я подготовил два варианта шаблона:</p>

		<ul>
			<li><a href="Template_App_iostat_FreeBSD.xml">Template_App_iostat_FreeBSD.xml</a> - шаблон с элементами данных типа "Zabbix-агент"</li>

			<li><a href="Template_App_iostat_FreeBSD_Active.xml">Template_App_iostat_FreeBSD_Active.xml</a> - шаблон с элементами данных типа "Zabbix-агент (активный)"</li>
		</ul>

		<p>В шаблоне имеется правило низкоуровневого обнаружения, которое находит все дисковые устройства, статистику по которым выдаёт iostat:</p>

		<img src="iostat_lld.png" />

		<p>Для каждого найденного устройства создаётся семь элементов данных, соответствующих колонкам из вывода iostat:</p>

		<img src="iostat_itemprototypes.png" />

		<p>Страница последних данных для одного из дисков выглядят следующим образом:</p>

		<img src="iostat_lastdata.png" />

		<p>Элемент данных с названием "Загрузка диска" показывает процент времени, в течение которого диск занимается обработкой хотя бы одной транзакции.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Статистика ввода-вывода iostat во FreeBSD через Zabbix">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
