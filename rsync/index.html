<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="rsync,debian" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2012-05-17 -->
		<title>Настройка rsync-сервера и использование rsync-клиента</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка rsync-сервера и использование rsync-клиента</h1>

		<p>Интересная заметка, которая по каким-то причинам до сих пор не попала в блог. В примере настройки rsync-сервера приводится реальный файл конфигурации зеркала репозиториев Debian, который я в прошлом на общественных началах держал для пользователей Уфанета. Потом Уфанет поднял собственное зеркало репозиториев, да и появились дешёвые безлимитные тарифы, поэтому моё зеркало потеряло смысл.</p>

		<h2>1. Настройка rsync-сервера</h2>

		<p>Для настройки rsync-сервера нужно установить пакет rsync:</p>

		<pre class="console"># apt-get install rsync</pre>

		<p>Затем, прописать опции командной строки, с которыми будет запускаться rsync-сервер в файл /etc/default/rsync. В данном файле можно задать следующие опции:</p>

		<ul>
			<li>
				<p><b>RSYNC_ENABLE</b> - настройка автозапуска сервера при загрузке операционной системы. Переменная принимает следующие значения:</p>

				<ul>
					<li><b>false</b> - запретить запуск сервера rsync,</li>

					<li><b>true</b> - запускать самостоятельный сервер rsync,</li>

					<li><b>inetd</b> - запускать сервер rsync при необходимости из супер-сервера inetd.</li>
				</ul>
			</li>

			<li><b>RSYNC_CONFIG_FILE</b> - задаёт место расположения файла конфигурации. По умолчанию этим файлом является /etc/rsyncd.conf</li>

			<li>
				<p><b>RSYNC_OPTS</b> - задаёт дополнительные опции командной строки для запуска rsync-сервера.</p>

				<p>Например, можно задать опцию "--address=123.45.67.89" (по умолчанию - все локальные адреса), чтобы указать на каком адресе следует принимать соединения и/или опцию "--port=8730" (по умолчанию - 873), чтобы указать на каком порту следует принимать соединения.</p>
			</li>

			<li><b>RSYNC_NICE</b> - задаёт приоритет процесса в планировщике задач.</li>
		</ul>

		<p>Создать файл конфигурации rsync-сервера /etc/rsync.conf:</p>

		<pre class="code">uid = rsyncd
gid = mirror
max connections = 50
read only = yes
list = yes
syslog facility = local5
dont compress = *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz *.rar *.mp3
use chroot = yes
outgoing chmod = Fu=rw,g=rw,o=,Du=rwx,g=rx,o=

[debian]
        path = /home/mirror/debian/
        comment = Debian Lenny i386 and amd64 repository

[debian-cd]
        path = /home/mirror/debian-cd/
        comment = Debian Lenny i386 and amd64 DVD images</pre>

		<p>Описание указанных опций:</p>

		<ul>
			<li><b>uid</b> - идентификатор пользователя, от имени которого будет работать rsync-сервер,</li>

			<li><b>gid</b> - идентификатор группы, от имени которой будет работать rsync-сервер,</li>

			<li>max connections - максимальное количество одновременных подключений к rsync-серверу. Все подключения сверх указанного лимита будут отброшены.</li>

			<li><b>read only</b> - разрешать клиентам только чтение,</li>
			<li><b>list</b> - разрешать клиентам получать список файлов. Если запретить просмотр списка файлов, то клиенты смогут получить файл только зная его точное имя,</li>

			<li><b>syslog facility</b> - уровень отладочных сообщений для демона syslog,</li>

			<li><b>dont compress</b> - указывает шаблоны имён файлов, содержимое которых не нужно сжимать при передаче. Здесь полезно указать уже сжатые файлы, повторное сжатие которых не даст никакой выгоды, а только потратит ресурсы системы - это большинство аудио-, видео-файлов, большинство графических файлов, архивы.</li>

			<li><b>use chroot</b> - указывает, должен ли rsync сервер в целях обеспечения большей безопасности, менять корневой каталог на указанный в path.</li>

			<li><b>outgoing chmod</b> - задаёт права доступа к отдаваемым файлам. Поскольку протокол rsync позволяет вместе с содержимым файлов передавать права доступа к ним и идентификаторы владельца и группы, можно задать особые права доступа, которые будут заменять реальные права доступа к данному файлу или каталогу при его передаче по сети.</li>

		</ul>

		<p>В квадратных скобках задаётся имя секции. Каждая секция обязана иметь собственный параметр path. Дополнительно в ней могут быть переопределены значения глобальных опций.</p>

		<p>После изменения опций, если ваш rsync-сервер будет работать в самостоятельном режиме, нужно перезапустить его:</p>

		<pre class="console"># /etc/init.d/rsync restart</pre>

		<h2>2. Использование rsync-клиента</h2>

		<p>Для установки rsync-клиента нужно установить пакет rsync:</p>

		<pre class="console"># apt-get install rsync</pre>

		<p>Чтобы начать копирование с rsync-сервера, можно воспользоваться подобной командой:</p>

		<pre class="console">$ rsync -avv rsync://anonymous@mirror.yandex.ru:873/debian/ debian/</pre>

		<p>Или проще:</p>

		<pre class="console">$ rsync -avv rsync://mirror.yandex.ru/debian/ debian/</pre>

		<p>rsync-клиент может работать не только с rsync-сервером, он может работать и через ssh-подключение с теми машинами, где установлен rsync:</p>

		<pre class="console">$ rsync -avv user@computer:/home/mirror/debian/ debian/</pre>

		<p>При этом он по сравнению с командой scp будет иметь следующие преимущества:</p>

		<ul>
			<li>не будет копировать те файлы, временная отметка об изменении которых совпадает с временной меткой об изменении локальной копии файла,</li>

			<li>умеет докачивать недокачанные фрагменты файла,</li>

			<li>при всём при этом умеет проверять идентичность файлов с помощью хэш-функции, при необходимости докачивая отдельные блоки файла, результат вычисления хэш-функции для которых отличается.</li>
		</ul>

		<p>Также rsync можно использовать для копирования локальных файлов:</p>

		<pre class="console">$ rsync -avv /home/mirror/debian/ debian/</pre>

		<p>По сравнению с командой cp будет иметь следующие преимущества:</p>

		<ul>
			<li>не будет копировать те файлы, временная отметка об изменении которых совпадает с временной меткой об изменении копии файла,</li>

			<li>умеет копировать ссылки, устройства,</li>

			<li>копирует права доступа к файлам,</li>

			<li>при запуске от имени пользователя root будет копировать принадлежность файлов пользователям и группам.</li>
		</ul>

		<p>При копировании можно задавать шаблоны включения и исключения файлов из процесса копирования, имеется масса других возможностей.</p>

		<p>При синхронизации на Samba-ресурс или файловую систему FAT может случиться, что копируются не только изменённые файлы, а половина всех файлов плюс изменившиеся. Это связано с тем, что в файловой системе FAT исторически под хранение секунд отводилось лишь 5 бит. В 5 битах можно хранить не более 32 разных значений, поэтому секунды хранятся с округлением до чётного значения. Из-за этого rsync может решить, что файл изменился, хотя разница между отметками времени двух файлов составляет 1 секунду. Чтобы rsync не обращал внимание на разницу в одну секунду, следует указать ему дополнительную опцию --modify-window=1:</p>

		<pre class="console">$ rsync -avv --modify-window=1 /home/fileserv1/ /home/fileserv2/</pre>

		<p>За более подробной информацией по программе rsync можно обратиться к системным страницам руководства rsync(1) и rsync.dconf(5) или к их переводам на русский язык <a href="http://www.opennet.ru/man.shtml?topic=rsync&amp;category=1&amp;russian=0">rsync(1)</a> и <a href="http://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=rsyncd.conf&amp;category=5">rsyncd.conf(5)</a>.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка rsync-сервера и использование rsync-клиента">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
