<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="кодировки,mysql" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2012-08-26 -->
		<title>Проблема с кодировками в MySQL</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Проблема с кодировками в MySQL</h1>

		<p>Не смотря на то, что в настоящее время почти повсеместно используется кодировка UTF-8, ещё случаются иногда курьёзные случаи с кодировками.</p>

		<p>Недавно столкнулся с проблемой такого рода. Сервер базы данных работал в latin1. Кодировка базы данных и всех её таблиц - UTF-8. На веб-сервере работало приложение на PHP, которое само по себе оперировало информацией в базе данных тоже в кодировке UTF-8. Беда в том, что в переменных окружения веб-сервера тоже стояла кодировка latin1. Сервер базы данных общался с клиентом базы данных, думая что оба они работают с информацией в кодировке latin1, хотя по факту информация была в UTF-8. Соответственно, никаких проблем не наблюдалось до тех пор, пока к серверу баз данных не подключился клиент, который захотел общаться в кодировке, отличной от latin1. Клиент получал что угодно, но только не текст в запрошенной кодировке.</p>

		<p>Чтобы исправить ситуацию, в веб-приложении пришлось сразу после подключения к базе данных задавать желаемую кодировку запросом "SET CHARACTER SET 'UTF8'". Осталось перекодировать данные.</p>

		<p>Сначала снимем дамп с базы данных, запросив данные в кодировке latin1. На самом деле они сольются в той кодировке, которой пользовалось веб-приложение. В данном случае это UTF-8.</p>

		<pre class="console">$ mysqldump --default-character-set=latin1 -uroot -p base | grep -vE "^\/\*" &gt; base.sql</pre>

		<p>Из дампа попутно удаляются все строки, начинающиеся с символов "/*" - это директивы, задающие настройки кодировок при импорте-экспорте.</p>

		<p>Теперь запустим консольный клиент, и создадим пустую базу данных в кодировке UTF-8:</p>

		<pre class="console">$ mysql -uroot -p
&gt; create database base2 charset utf8;</pre>

		<p>Осталось выбрать кодировку, в которой хранится информация в дампе и залить в новую базу данных ранее сохранённый дамп. В нашем случае это опять UTF-8.</p>

		<pre class="console">&gt; charset utf8;
&gt; use base2;
&gt; source base.sql</pre>

		<p>Теперь можно выбирать в клиенте ту кодировку, которая стоит в терминале, и видеть текст. В моём случае в терминале была настроена кодировка KOI8-R:</p>

		<pre class="console">&gt; charset koi8r;
&gt; select * from table_name limit 10;</pre>

		<p>Если всё сделано правильно, можно повторить восстановление дампа уже в основную базу и удалить тестовую базу данных:</p>

		<pre class="console">&gt; drop database base;
&gt; create database base charset utf8;
&gt; charset utf8;
&gt; source base.sql
&gt; drop database base2;</pre>

		<p><a href="mailto:vladimir@stupin.su?subject=Проблема с кодировками в MySQL">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
