<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="lightdm,linux,debian,wheezy,vnc,rdp" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2013-12-08 -->
		<title>Настройка сервера VNC и RDP совместно с LightDM</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка сервера VNC и RDP совместно с LightDM</h1>

		<p>VNC-сервер можно использовать одним из двух способов: подключаться к уже открытому X-сеансу или открывать новый сеанс для каждого подключившегося пользователя. В этой заметке будет рассмотрен второй вариант, напоминающий режим работы терминального сервера.</p>

		<p>Всё оказалось довольно просто: дисплейный менеджер LightDM умеет работать совместно с VNC-сервером, позволяя авторизоваться в системе и начать новый X-сеанс.</p>

		<h2>1. Установка и настройка VNC-сервера</h2>

		<p>Для начала устанавливаем пакет с VNC-сервером TightVNCServer:</p>

		<pre class="console"># apt-get install tightvncserver</pre>

		<p>В файле конфигурации /etc/lightdm/lightdm.conf находим секцию VNCServer и приводим её к следующему виду:</p>

		<pre class="code">[VNCServer]
enable=true
port=5900
width=1024
height=768
depth=8</pre>

		<p>Смысл всех настроек очевиден:</p>

		<ul>
			<li><b>enable</b> включает возможность подключиться к LightDM по протоколу VNC,</li>

			<li><b>port</b> задаёт номер TCP-порт, на котором VNC-сервер будет ожидать подключений,</li>

			<li><b>width</b> задаёт ширину экрана для VNC-сервера,</li>

			<li><b>height</b> задаёт высоту экрана для VNC-сервера,</li>

			<li><b>depth</b> задаёт глубину цвета для точки - 8 бит, 16 бит, 24 бита,</li>
		</ul>

		<p>Осталось перезапустить дисплейный менеджер LightDM. Учтите, что при перезапуске LigthDM будут завершены все открытые X-сеансы, поэтому лучше завершить их вручную и выполнить следующую команду из текстовой консоли:</p>

		<pre class="console"># /etc/init.d/lightdm restart</pre>

		<p>Теперь LightDM будет ожидать подключений на TCP-порту 5900 и при подключении клиента будет запускать VNC-сервер. Узнать, какой VNC-сервер будет запускаться, можно при помощи следующей команды:</p>

		<pre class="console"># update-alternatives --list vncserver</pre>

		<p>Выбрать используемый VNC-сервер можно при помощи следующей команды:</p>

		<pre class="console"># update-alternatives --config vncserver</pre>

		<p>Если в системе установлен только один VNC-сервер, будет использоваться он. При удалении используемого VNC-сервера система переключится на использование другого.</p>

		<p>Лучше использовать клиент наиболее совместимый с сервером. В нашем случае - это TightVNCViewer из пакета xtightvncviewer. VNC-сервер одновременно будет выступать в роли X-сервера, который будет взаимодействовать с LightDM. При подключении мы увидим обычный экран LightDM с указанным разрешением и глубиной цвета, в котором можно ввести имя пользователя и пароль для создания нового X-сеанса.</p>

		<h2>2. Установка и настройка RDP-прокси</h2>

		<p>Для подключения к компьютеру с VNC-сервером по протоколу RDP можно установить и настроить специальный прокси-сервер XRDP, который принимает подключения по протоколу RDP, а сам устанавливает подключения по протоколу VNC к VNC-серверу (на самом деле в данном случае соединения будет принимать LightDM, запуская для их обслуживания VNC-сервер). Прокси будет одновременно выступать в роли RDP-сервера и VNC-клиента.</p>

		<p>Установим пакет с прокси:</p>

		<pre class="console"># apt-get install xrdp</pre>

		<p>Приведём файл конфигурации /etc/xrdp/xrdp.ini к следующему виду:</p>

		<pre class="code">[globals]
bitmap_cache=yes
bitmap_compression=yes
port=3389
crypt_level=low
channel_code=1

[xrdp1]
name=default
lib=libvnc.so
username=
password=
ip=127.0.0.1
port=5900</pre>

		<p>На самом деле этот RDP-прокси может выступать и в роли RDP-клиента, может устанавливать подключения к произвольным компьютерам в сети, самостоятельно запускать X-серверы и использовать различные схемы аутентификации. В данном случае из файла конфигурации удалены все остальные варианты подключения и добавлен только один вариант с названием default, который позволяет подключиться к VNC-серверу, запущенному на том же компьютере, что и сам RDP-прокси. Подключение будет устанавливаться на TCP-порт 5900, а RDP-прокси не будет спрашивать у пользователя имя и пароль.</p>

		<p>Теперь перезапустим прокси, чтобы настройки вступили в силу:</p>

		<pre class="console"># /etc/init.d/xrdp restart</pre>

		<p>Теперь можно подключаться к VNC-серверу при помощи обычного RDP-клиента из Windows. При этом можно не думать об установке VNC-клиента, который не всегда может оказаться под рукой во "враждебной" среде Windows :)</p>

		<p>Вот снимок экрана при подключении по VNC при помощи Remmina:</p>

		<img src="remmina-vnc.png" />

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка сервера VNC и RDP совместно с LightDM">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
