<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="jessie,sip,debian,linux,asterisk" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2016-04-03 -->
		<title>Соединение двух Asterisk через SIP</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Соединение двух Asterisk через SIP</h1>

		<p>В прошлой заметке <a href="../asterisk-sip-part2/">Шаблоны и настройка звонков между SIP-клиентами в Asterisk</a> мы научились соединять между собой абонентов одной станции. В этот раз попробуем настроить связь между двумя станциями Asterisk, чтобы дать возможность общаться между собой их абонентам. Для этого я воспользовался настольным компьютером и ноутбуком. Соответственно, в описании ниже они называются desktop и notebook.</p>

		<p>Прежде чем соединять телефонные станции между собой, продумаем номерной план. Для телефонов на станции desktop я решил использовать четырёхзначные номера, начинающиеся с единицы. Для телефонов на станции notebook я решил использовать четырёхзначные номера, начинающиеся с двойки. В дальнейшем такое правило позволит нам настроить маршрутизацию звонков между телефонными станциями.</p>

		<h2>1. Контекст для тестовых номеров</h2>

		<p>В прошлых заметках были настроены тестовые номера 5XX. Выделим их в отдельную секцию с именем test. Откроем файл номерного плана /etc/asterisk/extensions.conf на телефонной станции desktop и сформируем такую секцию:</p>

		<pre class="code">[test]

exten =&gt; 500,1,Playback(demo-echotest)
same  =&gt;     n,Echo()
same  =&gt;     n,Playback(demo-echodone)

exten =&gt; 501,1,MusicOnHold()

exten =&gt; 502,1,SayDigits(${CALLERID(num)})

exten =&gt; 503,1,SayNumber(${CALLERID(num)})

exten =&gt; 504,1,SayNumber(${CALLERID(num)})
same  =&gt;     n,Wait(1)
same  =&gt;     n,SayDigits(${CALLERID(num)})</pre>

		<p>Чтобы с телефонов, подключенных к станции desktop, по-прежнему можно было позвонить на тестовые номера, добавим в контекст internal строчку, подключающую контекст test:</p>

		<pre class="code">[internal]
include =&gt; test

exten =&gt; _1XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>На станции notebook в файле номерного плана /etc/asterisk/extensions.conf контекст internal при этом выглядит так:</p>

		<pre class="code">[internal]

exten =&gt; _2XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>Как обычно, чтобы новый номерной план вступил в силу, выполним команду:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<h2>2. Создание учётных записей</h2>

		<p>Откроем файл /etc/asterisk/sip.conf на станции desktop и добавим туда шаблон учётных записей SIP для телефонных станций и саму учётную запись SIP на основе этого шаблона, через которую телефонная станция desktop будет принимать звонки от телефонной станции notebook:</p>

		<pre class="code">[asterisk_sip](!)
language=ru
type=friend
context=stations
host=dynamic
insecure=invite,port
trunk=yes

[notebook](asterisk_sip)
secret=notebook_password
deny=0.0.0.0/0.0.0.0
permit=169.254.254.4</pre>

		<p>Телефонная станция notebook сможет зарегистрироваться только с IP-адреса 169.254.254.4. Входящие звонки будут попадать в контекст stations. Звонящей телефонной станции нужно будет авторизоваться только при регистрации, а авторизация при поступлении запросов invite проверяться не будет (insecure=invite,port). Это значит, что с удалённой телефонной станции могут поступать звонки от телефонов, отсутствующих на локальной телефонной станции. Эта настройка очень важная. Если её пропустить, входящие звонки будут отбрасываться как неавторизованные, поскольку будут поступать не от имени удалённой телефонной станции, для которой создана учётная запись, а от имени телефона, подключенного к ней.</p>

		<p>Теперь откроем файл /etc/asterisk/sip.conf на станции notebook и впишем туда следующие симметричные настройки:</p>

		<pre class="code">[asterisk_sip](!)
language=ru
type=friend
context=stations
host=dynamic
insecure=invite,port
trunk=yes

[desktop](asterisk_sip)
secret=desktop_password
deny=0.0.0.0/0.0.0.0
permit=169.254.254.1</pre>

		<p>Теперь выполним на обеих телефонных станциях следующую команду, чтобы на них появились учётные записи SIP:</p>

		<pre class="console"># asterisk -rx 'sip reload'</pre>

		<h2>3. Входящие звонки с удалённых станций</h2>

		<p>Звонки, поступающие от удалённых станций будут попадать в контексты stations. Удалённые станции должны иметь возможность дозвониться на номера местной станции. Впишем в файл /etc/asterisk/extensions.conf на станции desktop соответствующий контекст:</p>

		<pre class="code">[stations]
include =&gt; test

exten =&gt; _1XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>Соответственно, чтобы абоненты удалённых станций могли позвонить абонентам станции notebook, впишем в файл /etc/asterisk/extensions.conf на станции notebook симметричный контекст:</p>

		<pre class="code">[stations]

exten =&gt; _2XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>Как можно увидеть, тестовые номера 5XX будут обслуживаться станцией desktop.</p>

		<p>Выполним на обеих станциях команды, которые создадут на них контексты stations:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<h2>4. Взаимная регистрация телефонных станций</h2>

		<p>Теперь заставим обе телефонные станции подключиться друг к другу. Для этого впишем в секцию globals в файле /etc/asterisk/sip.conf на станции desktop такие настройки:</p>

		<pre class="code">register =&gt; desktop:desktop_password@169.254.254.4/notebook</pre>

		<p>Эта строчка предписывает зарегистрироваться на станции notebook под именем desktop и с паролем desktop_password. Установленное SIP-подключение будет называться notebook. Это название в дальнейшем можно будет использовать в номерном плане для вызова абонентов, подключенных к станции notebook.</p>

		<p>Теперь впишем в секцию globals в файле /etc/asterisk/sip.conf на станции notebook симметричные настройки:</p>

		<pre class="code">register =&gt; notebook:notebook_password@169.254.254.1/desktop</pre>

		<p>Выполним на обеих телефонных станциях команду, после которой станции должны будут зарегистрироваться друг на друге:</p>

		<pre class="console"># asterisk -rx 'sip reload'</pre>

		<p>Чтобы проверить, зарегистрировалась ли эта станция на удалённой, можно воспользоваться такой командой:</p>

		<pre class="console"># asterisk -rx 'sip show registry'</pre>

		<p>Чтобы проверить, зарегистрировалась ли удалённая станция на этой, пригодится такая команда:</p>

		<pre class="console"># asterisk -rx 'sip show peers'</pre>

		<h2>5. Исходящие звонки на удалённые станции</h2>

		<p>Вся необходимая подготовка уже выполнена, осталось только объяснить обеим станциям, звонки на какие телефонные номера нужно направлять через SIP-подключение к другой станции.</p>

		<p>Откроем файл /etc/asterisk/extensions.conf на станции desktop и приведём контекст internal к следующему виду:</p>

		<pre class="code">[internal]
include =&gt; test

exten =&gt; _1XXX,1,Dial(SIP/${EXTEN})

exten =&gt; _2XXX,1,Dial(SIP/notebook/${EXTEN})</pre>

		<p>Из этого контекста видно, что звонки на тестовые номера и номера 1XXX будут обрабатываться самой станцией desktop, а звонки на номера 2XXX будут направляться через SIP-подключение, помеченное как notebook. Там они попадут в контекст stations, в котором предписывается направлять вызовы SIP-абонентам самой станции notebook.</p>

		<p>Откроем файл /etc/asterisk/extensions.conf на станции notebook и приведём контекст internal к такому виду:</p>

		<pre class="code">[internal]
exten =&gt; _5XX,1,Dial(SIP/desktop/${EXTEN})

exten =&gt; _1XXX,1,Dial(SIP/desktop/${EXTEN})

exten =&gt; _2XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>Звонки на номера 2XXX будут обрабатываться внутри самой станции notebook, а звонки на тестовые номера 5XX и номера 1XXX будут направляться через SIP-подключение, названное desktop. То есть - будут отправляться на станцию desktop, где так же попадут в контекст stations. Там же уже прописано, как нужно обрабатывать входящие звонки на эти номера.</p>

		<p>Осталось перезагрузить номерные планы на обеих станциях:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<p>Теперь можно пробовать звонить.</p>

		<h2>6. Возможные проблемы</h2>

		<p>Я лично при настройке этой конфигурации столкнулся с двумя проблемами.</p>

		<p>Первая проблема заключалась в том, что при поступлении звонка с удалённой станции, звонок отклонялся как неавторизованный. Выглядело это как отказ станции desktop принимать звонок с номера 2000, принадлежащего станции notebook (и наоборот):</p>

		<pre class="console">[Mar 15 20:33:41] NOTICE[17686][C-00000077] chan_sip.c: Failed to authenticate device &lt;sip:2000@169.254.254.4&gt;;tag=as6c5edf7c</pre>

		<p>Со стороны звонящей станции (notebook) эта же ошибка выглядела следующим образом:</p>

		<pre class="console">[Mar 15 20:33:41] WARNING[1146][C-00000000] chan_sip.c: Received response: "Forbidden" from '&lt;sip:2000@169.254.254.4&gt;;tag=as6c5edf7c'</pre>

		<p>Решается эта проблема прописыванием опции insecure=invite,port в настройки SIP-подключения для удалённой станции в файле /etc/asterisk/sip.conf</p>

		<p>Вторая проблема была довольно специфичной. При удачном звонке с телефонного аппарата, обслуживаемого одной станцией, на телефонный аппарат, обслуживаемый другой станцией, напрочь отсутствовал звук. Я сразу подумал, что не проходит трафик RTP и проверил, на всякий случай, настройки фаерволлов на обеих станциях. Но с фаерволлом оказалось всё в порядке. Потом попытался поймать RTP-трафик сниффером, но не смог. И уже только потом сообразил, что телефонные шлюзы отправляют голосовой трафик другу напрямую. Такая особенность была мне известна, но в тот момент она вылетела у меня из головы. Я вспомнил, что на коммутаторе настроена изоляция портов. Несмотря на то, что оба голосовых шлюза были в одной VLAN на соседних портах, трафик напрямую между портами не ходил, пока я не разрешил портам общаться между собой.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Соединение двух Asterisk через SIP">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
