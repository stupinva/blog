<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="nat,ipfw,freebsd" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2008-06-23 -->
		<title>DNAT с помощью ipfw и natd</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>DNAT с помощью ipfw и natd</h1>

		<p>Коротко о сути того, что нужно было сделать.</p>

		<p>Один корпоративный сайт, находящийся вне нашего филиала, доступен через интернет и по корпоративной сети. В интернете этот сайт имеет белый IP, а в корпоративной сети - серый. Соответственно трафик по интернет-сети оплачивается помегабайтно, а по корпоративной сети бесплатен.</p>

		<p>Пользователи, подключающиеся по VPN к нашей сети имеют два DNS, один - провайдера, второй выдаётся VPN-сервером. Провайдерский DNS возвращает белый IP этого сайта, поэтому VPN-клиенты пытаются обращаться к сайту именно по белому IP. Нужно, чтобы они обращались по серому IP.</p>

		<p>Отказаться от провайдерского DNS сложновато: он выдаётся автоматом и используется для установки соединения с VPN-сервером по его имени.</p>

		<p>Был придуман костыль: на VPN-сервере настроить DNAT, чтобы заменять белый IP на серый.</p>

		<p>Под Linux и iptables это настраивается элементарно, однако с FreeBSD, ipfw и natd пришлось немного попариться.</p>

		<p>В итоге получились следующие правила, с дополнительным экземпляром natd:</p>

		<pre class="code">${fwcmd} add divert 7667 tcp from <b>VPN_сеть</b> to <b>белый_IP</b> 443
${fwcmd} add divert 7667 tcp from <b>серый_IP</b> 443 to <b>VPN_сеть</b>
${natd} -p 7667 -n <b>интерфейс_серый</b> -redirect_port tcp <b>серый_IP</b>:443 <b>белый_IP</b>:443</pre>

		<ul>
			<li><b>VPN_сеть</b> - диапазон IP-адресов, выдающийся VPN-клиентам,</li>

			<li><b>белый_IP</b> - белый IP корпоративного сайта,</li>

			<li><b>серый_IP</b> - серый IP корпоративного сайта,</li>

			<li><b>интерфейс_серый</b> - интерфейс VPN-сервера, обращённый в сеть с серым IP корпоративного сервера.</li>
		</ul>

		<p>Суть правил в следующем:</p>

		<p>В первом правиле отбираются пакеты, идущие от VPN-клиентов к белому IP корпоративного сервера и отправляются в специально обученный natd.</p>

		<p>Во втором правиле отбираются ответные пакеты, то есть идущие от серого IP корпоративного сервера к VPN-клиентам и тоже направляются в специально обученный экземпляр natd.</p>

		<p>В третьей строчке запускается специально обученный экземпляр natd. Он заменяет адрес назначения с белого на серый IP у пакетов, идущих от VPN-клиентов к корпоративному сайту. Для возвратных пакетов, идущих от корпоративного сайта к VPN-клиентам, осуществляется обратное преобразование, адрес корпоративного сайта с серым IP заменяется на адрес с белым IP.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=DNAT с помощью ipfw и natd">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
