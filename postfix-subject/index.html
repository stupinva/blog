<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="wheezy,postfix,linux,debian" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2017-03-19 -->
		<title>Смена темы письма в Postfix</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Смена темы письма в Postfix</h1>

		<p>В одной из прошлых заметок <a href="../postfix-relay/">Postfix как локальный SMTP-ретранслятор</a> я описал настройки почтового сервера, выступающего в роли почтового клиента для другого сервера. Эту конфигурацию я использую для отправки служебных писем со своих серверов.</p>

		<p>Часто письма с разных серверов приходят от одного и того же отправителя, с одной и той же темой. Если ни в теме письма, ни в его теле явным образом не упоминается сервер, с которого было отправлено письмо, то обычно приходится смотреть заголовки письма, чтобы определить, с какого из серверов оно на самом деле было отправлено.</p>

		<p>Чтобы решить эту проблему и облегчить себе работу, я решил настроить все свои серверы так, чтобы Postfix добавлял в тему отправляемого письма имя сервера.</p>

		<p>Сделать это просто. Для начала нужно установить пакет postfix-pcre:</p>

		<pre class="console"># apt-get install postfix-pcre</pre>

		<p>Далее, добавим в файл /etc/postfix/main.cf одну строчку:</p>

		<pre class="code">header_checks = pcre:/etc/postfix/rewrite_subject</pre>

		<p>Теперь нужно создать файл /etc/postfix/rewrite_subject и поместить в него правило, которое будет добавлять в тему письма дополнительный текст с именем сервера. Например, вот так:</p>

		<pre class="code">/^Subject: (.*)$/ REPLACE Subject: $1 (from server.domain.tld)</pre>

		<p>Текст "/^Subject: (.*)$/" является регулярным выражением в стиле Perl. Это регулярное выражение будет совпадать со строкой заголовка, начинающейся с текста "Subject: ". Текст "(.*)" совпадает с любой темой письма и будет запомнен в переменной $1.</p>

		<p>Действие "REPLACE" говорит о том, что нужно произвести замену текста.</p>

		<p>Строка "Subject: $1 (from server.domain.tld)" содержит в текст, который заменит совпавшую строчку. При этом вместо переменной $1 будет подставлено её значение. Если имя переменной не отделено от остального текста пробельными символами, тогда её имя следует записывать в виде ${1}</p>

		<p>Итак, осталось перезапустить почтовый сервер:</p>

		<pre class="console"># /etc/init.d/postfix restart</pre>

		<p>Проверить, добавляется ли текст к теме письма можно следующим образом:</p>

		<pre class="console"># mail -s test box@mailserver.tld
test
.</pre>

		<p>При этом в почтовом ящике должно появиться письмо с темой "test (from server.domain.tld)".</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Смена темы письма в Postfix">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
