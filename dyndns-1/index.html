<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="dns,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2008-08-19 -->
		<title>Настройка DynDNS на Debian</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка DynDNS на Debian</h1>

		<p>Давно хотел застолбить себе домен, пусть даже и третьего уровня, чтобы можно было без лишних проблем легко попадать на свой домашний Linux-сервер.</p>

		<p>Проблемы состоят во-первых в том, что у этого сервера не постоянный IP-адрес, он выдаётся при подключении по PPTP. А во-вторых, на безлимитном тарифе провайдер не предоставляет услугу постоянного IP-адреса.</p>

		<p>До сих пор обходился самописным скриптом, который автоматически при поднятии линка заливает текстовый файл с IP-адресом по FTP на бесплатный веб-хостинг.</p>

		<h2>1. Регистрация на сервисе DynDNS</h2>

		<p>После непродолжительного гугления на тему динамических DNS, был найден сервис <a href="http://www.dyndns.com/">http://www.dyndns.com/</a>. Долго откладывал настройку, но сейчас решил настроить и описать процесс.</p>

		<p>На этом сайте можно заказать за деньги DNS-хостинг, мониторинг серверов и многие другие услуги. Есть также бесплатный DNS-сервис, ограниченный 864000 запросами к DNS в месяц и бесплатный домен третьего уровня, позволяющий производить динамические обновления зоны.</p>

		<p>Для начала регистрируемся на сайте и подтверждаем регистрацию по почте.</p>

		<p>Выбираем доменное имя второго уровня, где будем размещать свою зону. Полный список доменов второго уровня, в которых Вы можете застолбить свой домен третьего уровня, можно посмотреть здесь: <a href="http://www.dyndns.com/services/dns/dyndns/domains.html">http://www.dyndns.com/services/dns/dyndns/domains.html</a> Я выбрал домен homelinux.org.</p>

		<p>Затем подписываемся на услугу Dynamic DNS, где выбираем тип узла - custom.</p>

		<p>На этом сайт можно покинуть, больше он нам не понадобится.</p>

		<h2>2. Настройка ddclient с помощью мастера настройки</h2>

		<p>Устанавливаем ddclient:</p>

		<pre class="console"># aptitude install ddclient</pre>

		<p>Сразу во время установки запускается мастер настройки ddclient с ncurses-интерфейсом:</p>

		<p>1. Выбираем сервис, на котором зарегистрировали учётную запись. Я выбрал www.dyndns.com</p>

		<img src="dd1.png" />

		<p>2. Вводим имя домена, который выбрали при регистрации на DynDNS:</p>

		<img src="dd3.png" />

		<p>3. Вводим имя пользователя, с которым регистрировались на сервисе DynDNS:</p>

		<img src="dd5.png" />

		<p>4. Пароль для этой учётной записи:</p>

		<img src="dd7.png" />

		<p>5. Указываем имя интерфейса, к IP-адресу которого будет привязываться выбранное доменное имя. Можно оставить это поле пустым, тогда IP-адрес будет определяться автоматически, исходя из того, какой IP-адрес был использован клиентом при подключении к сервису.</p>

		<img src="dd9.png" />

		<p>6. Здесь можно указать, будет ли запускаться ddclient при запуске PPP-соединений и отключаться при закрытии PPP-соединений.</p>

		<img src="dd11.png" />

		<p>7. Если выбрать запуск ddclient в режиме демона, он будет автоматически запускаться при загрузке системы и работать постоянно. Если вы выбрали этот режим, то в предыдущем пункте можно отключить запуск демона при поднятии PPP-канала связи.</p>

		<img src="dd13.png" />

		<p>Если вы ошиблись в настройках, запустить мастер настройки ddclient снова можно в любое время, для этого можно воспользоваться следующей командой:</p>

		<pre class="console"># dpkg-reconfigure ddclient</pre>

		<h2>3. Конфигурационные файлы и настройка без мастера</h2>

		<p>Все указанные мной настройки уместились в двух файлах. /etc/ddclient.conf:</p>

		<pre class="code"># Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

pid=/var/run/ddclient.pid
protocol=dyndns2
use=if, if=
server=members.dyndns.org
login=www2
password='password'
ufadeb.homelinux.org</pre>

		<p>В этом файле можно указать имя интерфейса, имя и пароль учётной записи на DynDNS и доменное имя, которые вы выбрали при регистрации.</p>

		<p>И второй файл - /etc/default/ddclient:</p>

		<pre class="code"># Configuration for ddclient scripts
# generated from debconf on Срд Фев 25 20:17:16 YEKT 2009
#
# /etc/default/ddclient

# Set to "true" if ddclient should be run every time a new ppp connection is
# established. This might be useful, if you are using dial-on-demand
run_ipup="true"

# Set to "true" if ddclient should run in daemon mode
run_daemon="false"

# Set the time interval between the updates of the dynamic DNS name in seconds.
# This option only takes effect if the ddclient runs in daemon mode.
daemon_interval="300"</pre>

		<p>В нём можно указать режимы запуска и период обновления информации:</p>

		<ol>
			<li>run_ipup соответствует запуску демона при установлении PPP-подключения и его остановке при разрыве PPP-подключения, принимает два значения - true (запускать) и false (не запускать),</li>

			<li>run_daemon - запускать ddclient в режиме демона (true) или нет (false),</li>

			<li>daemon_interval - интервал обновления привязки доменного имени и IP-адреса в секундах (300 - 5 минут).</li>
		</ol>

		<h2>4. Более сложный случай настройки</h2>

		<p>Мне понадобился несколько более экзотический случай настройки: мне нужно обновлять две доменные записи и привязывать их к двум интерфейсам. С помощью мастера настройки и обычных режимов работы ddclient, предусмотренных скриптами в /etc/init.d/ddclient это настроить нельзя. Поэтому я настроил немного по-другому.</p>

		<p>Нужно прописать в файле конфигурации обычные настройки для одного домена, но указать их два. Для каждого домена обновлять записи следует из командной строки, указывая название интерфейса и доменное имя, для которых производится обновление. Теоретически можно было бы вызывать эти скрипты единожды при поднятии PPP-интерфейсов, однако на практике такая схема обновления записей себя не оправдала: если ddclient не срабатывал сразу при поднятии интерфейса, то новых попыток обновить адрес не предпринималось до тех пор, пока PPP-соединение не будет переподключено вновь. Если каждое обновление записей в DynDNS требует личного контроля, автоматизацией это не назовёшь. Поэтому был выбран другой вариант - обновление записей по cron'у.</p>

		<p>Сначала я отключил режим демона и режим запуска для PPP-соединений:</p>

		<pre class="code">run_ipup="false"
run_daemon="false"
daemon_interval="1m"</pre>

		<p>Настроил в файле /etc/ddclient.conf два доменных имени:</p>

		<pre class="code">pid=/var/run/ddclient.pid
protocol=dyndns2
server=members.dyndns.org
login=www2
password='password'
ufadeb.homelinux.org
stupin.homelinux.org</pre>

		<p>И настроил запуск ddclient по cron'у каждую минуту:</p>

		<pre class="console"># crontab -e</pre>

		<p>Добавив в таблицу две строчки:</p>

		<pre class="code">*   *  *   *   *     /usr/sbin/ddclient -file /etc/ddclient.conf -host stupin.homelinux.org -use if -if ppp0
*   *  *   *   *     /usr/sbin/ddclient -file /etc/ddclient.conf -host ufadeb.homelinux.org -use if -if ppp1</pre>

		<p>Интерфейсы ppp0 и ppp1 всегда привязаны к определённым соединениям с помощью опции unit демона pppd.</p>

		<p>Теперь можно перезапустить демон cron, чтобы он заново считал свои настройки (хотя вроде бы и так он перечитывает их каждую минуту):</p>

		<pre class="console"># /etc/init.d/cron restart</pre>

		<p>ddclient хранит текущие настройки в файле /var/cache/ddclient/ddclient.cache, иногда для того, чтобы принудительно обновить настройки на DynDNS-сервере может потребоваться удалить этот файл (ddclient не отправляет запрос на обновление, если текущие настройки интерфейсов совпадают с сохранёнными в этом файле).</p>

		<p>Последнее обновление 25 февраля 2009 года.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка DynDNS на Debian">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
