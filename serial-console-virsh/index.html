<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="getty,stretch,virt-manager,kvm,virsh,systemd,debian,linux,grub2" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2019-09-08 -->
		<title>Настройка текстового терминала для использования в virsh</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка текстового терминала для использования в virsh</h1>

		<p>Ранее я описывал установку и настройку virt-manager - графической программы для администрирования виртуальных машин, работающих под управлением KVM, Xen и других гипервизоров. Для управления начинкой виртуальных машин, как правило, достаточно SSH. Однако, виртуальная машина может оказаться не доступной по SSH из-за неполадок в работе сети или ошибок в сетевых настройках самой виртуальной машины. В таком случае можно подключиться к консоли виртуальной машины, однако и virt-manager может оказаться не доступным. Вместо virt-manger можно попробовать воспользоваться virsh, но как попасть в текстовую консоль виртуальной машины, если она не была настроена заранее?</p>

		<p>Чтобы подстелить соломки, можно заранее настроить текстовую консоль в каждой из виртуальных машин. В случае недоступности виртуальной машины по сети или отсутствии virt-manager на ближайшем компьютере достаточно будет подключиться по SSH к компьютеру, на котором работает гипервизор, на нём запустить virsh, а оттуда уже попасть в консоль виртуальной машины. Займёмся настройкой.</p>

		<h2>1. Настройка виртуальной машины</h2>

		<p>Запускаем от пользователя root команду virsh:</p>

		<pre class="console"># virsh</pre>

		<p>В запущенной оболочке virsh проверяем, есть ли у виртуальной машины текстовый терминал (вместо &lt;vm&gt; нужно указать имя виртуальной машины):</p>

		<pre class="console">ttyconsole &lt;vm&gt;</pre>

		<p>Если команда ничего не вывела, значит виртуального терминала нет и его нужно настроить. Для этого отредактируем конфигурацию виртуальной машины, выполнив в оболочке virsh команду:</p>

		<pre class="console">edit &lt;vm&gt;</pre>

		<p>Если в файле есть секция console, имеющая такой вид:</p>

		<pre class="code">&lt;console type='pty'&gt;
  &lt;target type='virtio' port='0'/&gt;
&lt;/console&gt;</pre>

		<p>То её нужно привести её к следующему виду:</p>

		<pre class="code">&lt;serial type='pty'&gt;
  &lt;target port='0'/&gt;
&lt;/serial&gt;
&lt;console type='pty'&gt;
  &lt;target type='serial' port='0'/&gt;
&lt;/console&gt;</pre>

		<p>Если же секцию console найти не удалось, то нужно вставить указанный фрагмент вовнутрь секции devices.</p>

		<p>Дальше нужно остановить виртуальную машину и запустить её снова. Для этого в оболочке virsh можно выполнить следующие две команды:</p>

		<pre class="console">shutdown &lt;vm&gt;
start &lt;vm&gt;</pre>

		<p>После пересоздания виртуальной машины, в ней появится последовательное устройство.</p>

		<h2>2. Настройка демона терминала getty</h2>

		<p>Когда виртуальная машина запустится, нужно зайти в неё через графическую консоль (или через SSH) и выполнить две команды, которые включат терминал на виртуальном последовательном порту:</p>

		<pre class="console"># systemctl enable serial-getty@ttyS0.service
# systemctl start serial-getty@ttyS0.service</pre>

		<p>После этого появится возможность подключиться к этому терминалу через virsh, при помощи команды следующего вида:</p>

		<pre class="console">console &lt;vm&gt;</pre>

		<p>Однако, этим терминалом можно будет пользоваться только после загрузки системы. Нельзя будет увидеть ни меню загрузчика, ни сообщения, выводимые ядром операционной системы в процессе его загрузки. Чтобы терминалом можно было воспользоваться до загрузки операционной системы, нужно настроить консоль в загрузчике и в ядре.</p>

		<h2>3. Настройка консоли в GRUB 2 и Linux</h2>

		<p>Поскольку загрузчик передаёт опции ядру, то для настройки консоли в загрузчике и в ядре Linux понадобится отредактировать только конфигурацию загрузчика.</p>

		<p>Для настройки консоли в загрузчике, нужно в файле /etc/default/grub добавить или заменить следующие опции:</p>

		<pre class="code">GRUB_TERMINAL="serial console"
GRUB_SERIAL_COMMAND="serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1"</pre>

		<p>Мне потребовалось поискать в интернете примеры настройки, при которых консоль на последовательном порту не вызывала бы отключение графической консоли. Указанный выше вариант позволяет пользоваться меню GRUB и через последовательную консоль, и через графическую.</p>

		<p>Для настройки консоли в ядре Linux нужно в том же файле /etc/default/grub найти опцию GRUB_CMDLINE_LINUX и добавить в неё следующие опции ядра:</p>

		<pre class="code">console=tty0 console=ttyS0,115200n8</pre>

		<p>В моём случае никаких опций ядру не передавалось, поэтому строчка приняла следующий вид:</p>

		<pre class="code">GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200n8"</pre>

		<p>Теперь нужно применить изменения в конфигурации GRUB при помощи следующей команды:</p>

		<pre class="console"># update-grub</pre>

		<h2>4. Результат</h2>

		<p>Для того, чтобы убедиться в работоспособности консоли, можно подключиться к графической консоли и консоли на последовательном порту виртуальной машины и отправить её в перезагрузку. В моём случае меню загрузчика в обеих консолях выглядело следующим образом:</p>

		<img src="virsh-console.png" />

		<img src="virtmanager-console.png" />

		<p>Ниже показан процесс загрузки системы на обеих консолях:</p>

		<video controls width="640">
			<source src="vm-console.mp4" type="video/mp4" />
			Извините, ваш браузер не поддерживает воспроизведение этого видеоролика.
		</video>

		<h2>5. Использованные материалы</h2>

		<ul>
			<li><a href="https://ubuntuforums.org/showthread.php?t=1159220&amp;p=7285601#post7285601">KVM/libvirt VM console access?</a></li>

			<li><a href="https://wiki.archlinux.org/index.php/working_with_the_serial_console">Working with the serial console</a></li>

			<li><a href="https://www.altlinux.org/Grub#%D0%9A%D0%B0%D0%BA_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D1%8C_%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%83_%D1%81_%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%BC_%D0%BF%D0%BE%D1%80%D1%82%D0%BE%D0%BC?">Grub. Как включить работу с последовательным портом?</a></li>
		</ul>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка текстового терминала для использования в virsh">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
