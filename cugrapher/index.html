<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="netflow,CUGrapher,CUFlow,fprobe,flow-tools,linux,debian,flowscan" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2012-01-27 -->
		<title>Настройка fprobe, flow-capture, flowscan, CUFlow и CUGrapher</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка fprobe, flow-capture, flowscan, CUFlow и CUGrapher</h1>

		<p>В прошлом уже приходилось пользоваться всей этой честной компанией, а сейчас выдался случай вспомнить.</p>

		<p>Что всё это такое?</p>

		<p>fprobe - это сенсор NetFlow, который собирает статистику по пакетам, проходящим через определённый интерфейс или все интерфейсы сразу. После заполнения буфера сенсор отправляет накопленную информацию коллектору NetFlow в виде UDP-пакета.</p>

		<p>flow-capture - это коллектор NetFlow из пакета flow-tools, который ловит UDP-пакеты, агрегирует информацию из них и периодически складывает информацию в файл. В пакете flow-tools есть ещё масса полезных инструментов, с помощью которых можно разнообразным образом обрабатывать собранную информацию.</p>

		<p>flowscan - Perl-скрипт, который работает в связке с одним или несколькими из трёх модулей отчётов: CUFlow, CampusIP, SubNetIO. Мы будем использовать модуль отчёта CUFlow, который находится в пакете flowscan-cuflow. Совместно они извлекают информацию из файлов с сохранёнными NetFlow-потоками и делают две вещи: аккумулируют статистику по трафику в файлы в формате RRD, а также создают HTML-файлы со статистикой самых активных узлов за последние 5 минут и за весь период наблюдения. Созданные RRD- и HTML-файлы складываются в указанные каталоги.</p>

		<p>CUGrapher - CGI Perl-скрипт из пакета flowscan-cugrapher, который строит графики по RRD-файлам, созданным flowscan/CUFlow.</p>

		<p>Итак, приступим к настройке. Для начала, установим необходимые пакеты:</p>

		<pre class="console"># apt-get install fprobe flow-tools flowscan flowscan-cuflow flowscan-cugrapher</pre>

		<p>Настроим сенсор fprobe. Для этого в файле /etc/default/fprobe пропишем строки:</p>

		<pre class="code">INTERFACE="any"
FLOW_COLLECTOR="localhost:9001"
OTHER_ARGS="-fip"</pre>

		<p>Строчка <b>INTERFACE</b> указывает, что следует перехватывать трафик на всех доступных интерфейсах.</p>

		<p><b>FLOW_COLLECTOR</b> указывает IP-адрес и порт, на котором коллектор будет принимать UDP-пакеты.</p>

		<p><b>OTHER_ARGS</b> указывает прочие опции. В данном случае указан фильтр, отбирающий только IP-пакеты (ARP-пакеты учитываться не будут).</p>

		<p>Теперь нужно настроить коллектор flow-capture. Для этого в файл /etc/flow-tools/flow-capture.conf пропишем следующую строку:</p>

		<pre class="code">-w /var/flow/ufa -n 287 -N 0 0/127.0.0.1/9001</pre>

		<p>В этом файле каждая строчка настраивает отдельный коллектор, так что если потребуется настроить два или три коллектора - достаточно просто добавить дополнительные строчки.</p>

		<p>Опция <b>-w</b> указывает, куда будут складываться файлы.</p>

		<p>Опция <b>-n</b> задаёт количество ротаций в день (287 соответствует 288 файлам в день или одному файлу в 5 минут).</p>

		<p>Опция <b>-N</b> задаёт структуру каталогов для хранения файлов (0 соответствует настройке без использования вложенных каталогов - все файлы складываются прямо в указанный каталог).</p>

		<p>Последняя опция указывает, что NetFlow пакеты будут приниматься с любого адреса на адрес 127.0.0.1 на UDP-порт 9001.</p>

		<p>Создадим каталог для файлов:</p>

		<pre class="console"># mkdir /var/flow</pre>

		<p>Теперь можно запустить коллектор:</p>

		<pre class="console"># /etc/init.d/flow-capture start</pre>

		<p>С настройкой коллектора покончили, теперь будем настраивать flowscan. Для этого отредактируем файл /etc/flowscan/flowscan.cf таким образом, чтобы он принял следующий вид:</p>

		<pre class="code">FlowFileGlob /var/flow/ufa/ft-*
ReportClasses CUFlow
WaitSeconds 300
Verbose 1</pre>

		<p>Настройка <b>FlowFileGlob</b> задаёт шаблон для файлов, которые необходимо обрабатывать.</p>

		<p>В настройке <b>ReportClasses</b> через запятую указываются используемые модули отчётов.</p>

		<p>Настройка <b>WaitSeconds</b> задаёт интервал времени в секундах, через который указанный шаблон будет проверяться на соответствие файлам.</p>

		<p>Настройка <b>Verbose</b> задаёт выдачу диагностических сообщений (для начала рекомендую оставить её включенной).</p>

		<p>Стоит отметить, что по умолчанию flowscan удаляет обработанные файлы. Если они вам нужны, создайте в каталоге с файлами подкаталог saved, тогда flowscan будет перемещать обработанные файлы в него. Так как я собираюсь использовать эти файлы для самых разных целей, я создаю этот каталог:</p>

		<pre class="console"># mkdir /var/flow/ufa/saved</pre>

		<p>Теперь нужно настроить модуль отчёта CUFlow. Его настройки находятся в файле /etc/flowscan/CUFlow.cf и у меня они приняли следующий вид:</p>

		<pre class="code">Subnet 192.168.80.0/24
Subnet 192.168.81.0/24
Subnet 92.50.0.1/32

Network 192.168.80.0/24 lan
Network 192.168.81.0/24 vpn

OutputDir /var/cuflow

Multicast

Scoreboard 10 /var/www/cuflow/ /var/www/cuflow/topten.html

AggregateScore 10 /var/cuflow/agg.dat /var/www/cuflow/overall.html

Router 127.0.0.1 ufa

Service 20-21/tcp ftp
Service 22/tcp ssh
Service 25/tcp smtp
Service 53/udp,53/tcp dns
Service 80/tcp,81/tcp http
Service 110/tcp pop3
Service 443/tcp https
Service 1433/udp,1433/tcp ms-sql
Service 3389/tcp ms-rdp
Service 4899/udp,4899/tcp radmin

Protocol 1 icmp
Protocol 6 tcp
Protocol 17 udp
Protocol 47 gre

#TOS 0 normal
#TOS 1-255 other
#ASNumber 1 Genuity</pre>

		<p>Настройка <b>Subnet</b> указывает сети, которые считаются локальными. Эти сети используются для определения типа трафика: входящий или исходящий.</p>

		<p>В настройках <b>Network</b> указываются сети, для которых будут создаваться отдельные RRD-файлы.</p>

		<p>Настройка <b>OutputDir</b> задаёт каталог, в который будут складываться RRD-файлы.</p>

		<p>Если необходимо учитывать мультикаст-трафик, укажите опцию <b>Multicast</b>.</p>

		<p>Настройка <b>Scoreboard</b> задаёт количество адресов в хит-параде интенсивности трафика за последние 5 минут, каталог, где будут храниться отчёты за произвольные 5 минут и файл, в котором будет храниться отчёт за последнюю пятиминутку.</p>

		<p>Аналогично, настройка <b>AggregateScore</b> задаёт количество адресов в хит-параде интенсивности трафика за всю историю наблюдений, dat-файл, где будут храниться суммированные данные и HTML-файл с хитпарадом за всю историю наблюдений.</p>

		<p>В настройке <b>Router</b> можно указать один или несколько IP-адресов (через запятую), соответствующих адресам, с которых сенсоры NetFlow отправляют информацию. Информация с этих сенсоров будет собираться в отдельный RRD-файл.</p>

		<p>В настройке <b>Service</b> задаются номера портов протоколов UDP и TCP, которые будут учитываться в отдельном RRD-файле.</p>

		<p>Настройка <b>Protocol</b> имеет аналогичный смысл, но распространяется уже на протоколы.</p>

		<p>Настройка <b>TOS</b> позволяет вести учёт пакетов по классам обслуживания в отдельном RRD-файле. Такая информация мне не интересна, поэтому соответствующие строчки я закоментировал.</p>

		<p>Настройка <b>ASNumber</b> позволяет вести статистику по трафику номерам автономных систем в сетях с маршрутизацией BGP (Интернет). У каждого провайдера есть по крайней мере один номер автономной системы, так что можно учитывать статистику по трафику по направлению от и к определённым провайдерам. fprobe не предоставляет такую информацию, да она и не интересна мне, поэтому эту опцию я тоже закоментировал.</p>

		<p>Теперь нужно создать каталоги для хранения RRD-файлов и HTML-отчётов:</p>

		<pre class="console"># mkdir /var/cuflow /var/www/cuflow</pre>

		<p>Каталоги готовы, можно делать тестовый запуск flowscan:</p>

		<pre class="console"># flowscan</pre>

		<p>flowscan должен начать обрабатывать доступные файлы из каталога /var/flow/ufa. По завершении обработки он уснёт на указанные нами в настройках 300 секунд, после чего его можно прервать нажатием Ctrl-C. В каталоге /var/cuflow должны появиться RRD-файлы, а в каталоге /var/www/cuflow - файлы topten.html и overall.html, а также каталоги с файлами подобными topten.html за предыдущие пятиминутки наблюдений.</p>

		<p>Если у вас настроен веб-сервер, вы можете зайти на него при помощи браузера и посмотреть HTML-файлы.</p>

		<img src="topten.png" />

		<img src="overall.png" />

		<p>Если flowscan во время обработки файлов будет выдавать предупреждения вроде этого:</p>

		<pre class="code">Use of uninitialized value in numeric gt (&gt;) at /usr/share/perl5/HTML/Table.pm line 2685.</pre>

		<p>Не беспокойтесь, программа работает штатно.</p>

		<p>Осталось настроить CUGrapher. Его настройки хранятся в файле  /etc/flowscan/CUGrapher.cf и у меня они выглядят следующим образом:</p>

		<pre class="code">OutputDir /var/cuflow
Organization My Insurance Company

Width 1024
Height 320

DefaultGraph report=bits&amp;hours=12&amp;imageType=png&amp;width=1024&amp;height=320&amp;duration=&amp;router=all&amp;all_all_services=1&amp;router=ufa&amp;title=Well+Known+Protocols%2FServices&amp;legend=1

AggregateScore /var/www/cuflow/overall.html
Scoreboard /var/www/cuflow/topten.html</pre>

		<ul>
			<li><b>OutputDir</b> - каталог, где хранятся RRD-файлы.</li>

			<li><b>Organization</b> - название вашей компании.</li>

			<li><b>Width</b> и <b>Height</b> - ширина и высота графика в пикселях.</li>

			<li><b>DefaultGraph</b> - адрес страницы с графиком по умолчанию. Достаточно зайти на страницу, перейти на нужный график и скопировать в эту опцию текст из адресной строки браузера после знака ?. Также можно удалить из строки опцию &amp;showmenu=1.</li>

			<li><b>AggregateScore</b> - местоположение файла overall.html</li>

			<li><b>Scoreboard</b> - местоположение файла topten.html</li>
		</ul>

		<p>Можно зайти браузером по адресу /cgi-bin/CUGrapher.pl и смотреть графики.</p>

		<img src="cugrapher.png" />

		<p>Кое-какие предупреждения и пояснения.</p>

		<ol>
			<li>fprobe перехватывает весь трафик, проходящий через все интерфейсы компьютера, поэтому для высоконагруженных серверов или маршрутизаторов такое решение непригодно.</li>

			<li>flowscan/CUFlow/CUGrapher избыточны в ситуациях, когда нужно всего лишь наблюдать за графиком загрузки интерфейса. Для таких простых задач существуют более простые программы.</li>

			<li>flowscan/CUFlow/CUGrapher - это относительно старые программы, поэтому не ждите от них красоты и удобства.</li>
		</ol>

		<p>Статья написана по мотивам статьи Игоря Чубина <a href="http://xgu.ru/wiki/NetFlow">NetFlow</a>. Некоторые моменты переосмыслены. Переосмысление в основном заключается в том, что в Debian теперь все пакеты из комплекта flowscan/CUFlow/CUGrapher обновлены до их последних версий, поэтому скачивать и обновлять ничего не нужно. Также переосмыслен способ настройки CUGrapher, у которого для настройки есть собственный конфигурационный файл.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка fprobe, flow-capture, flowscan, CUFlow и CUGrapher">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
