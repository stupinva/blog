<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="grub2,windows,linux,debian" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2011-11-11 -->
		<title>Перенос Windows XP на другой диск средствами Linux</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Перенос Windows XP на другой диск средствами Linux</h1>

		<p>Для начала хочу предупредить, что это не точная инструкция как и что делать. Это описание ключевых моментов, для правильного применения которых нужно ещё приложить собственную голову. Если вы не уверены в своих силах, то лучше воспользуйтесь специализированными программами (Acronis True Image или Norton Ghost), а не этим способом, который описывает только средства из Linux.</p>

		<p>Перенос средствами Linux оказался не настолько простым делом, как это могло показаться первоначально. Не буду рассказывать обо всём, что мне довелось попробовать и на какие грабли наступить, я просто резюмирую весь полученный опыт.</p>

		<p>У меня стоит загрузчик GRUB2, но почему-то не стояло очень важного компонента - os-prober. Он умеет при подсовывании ему дискового раздела определять, что за операционная система там стоит. Его наличие позволит упростить настройку GRUB2. Также, поскольку мы будем переносить систему Windows XP с раздела NTFS на раздел NTFS, нам потребуется пакет ntfsprogs. Ну и если у вас ещё нет раздела на диске, в который вы хотите перенести Windows, вам могут потребоваться fdisk и/или parted. Полезным может оказаться и модуль ntfs-3g для монтирования NTFS-раздела в режиме записи.</p>

		<pre class="console"># apt-get install os-prober ntfsprogs hexedit</pre>

		<p>Останавливаться на создании раздела для Windows я не стану, т.к. это дело тривиальное и, на мой взгляд, не требующее объяснений.</p>

		<p>Первым делом скопируем NTFS-раздел. Делается это командой ntfsclone:</p>

		<pre class="console"># ntfsclone --overwrite /dev/sdb3 /dev/sda1</pre>

		<p>/dev/sda1 - это исходный раздел с Windows,</p>

		<p>/dev/sdb3 - это целевой раздел, на который мы переносим систему.</p>

		<p>БУДЬТЕ ВНИМАТЕЛЬНЫ, ничего не перепутайте! Посмотреть, какие разделы есть на дисках, можно с помощью команды:</p>

		<pre class="console"># fdisk -l</pre>

		<p>Если возникают сомнения, смонтируйте разделы и убедитесь в том, что вы точно знаете, с какого на какой раздел нужно перенести систему. У меня таких проблем не было, т.к. диска было всего два, на одном из дисков было аж 6 разделов, а на другом - только 1, поэтому перепутать их было трудно.</p>

		<p>После клонирования мы получим раздел в точности повторяющий исходный. Ловушка заключается в том, что загрузчик Windows, располагающийся в начале раздела (NTFS Boot Record), содержит в себе информацию о геометрии диска, положении раздела и о серийном номере этого раздела.</p>

		<p>На данном этапе мне помогла статья <a href="http://jalada.co.uk/2010/10/26/relocating-windows-to-a-new-hard-drive.html">Relocating Windows to a new Hard Drive</a>, в которой есть ссылка на исходный текст простенькой программы, которая исправляет загрузчик NTFS так, чтобы он узнал о новой геометрии диска. Эту программу я на всякий случай скопировал себе и разместил тут: <a href="ntfsreloc.c">ntfsreloc.c</a></p>

		<p>Соберём её (для этого может потребоваться установить компилятор языка Си, который у меня уже стоял, т.к. я иногда на нём пишу сам):</p>

		<pre class="console">$ gcc -o ntfsreloc ntfsreloc.c</pre>

		<p>Теперь её нужно запустить:</p>

		<pre class="console"># ntfsreloc -w -p /dev/sdb3</pre>

		<p>Затем нужно смонтировать диск и исправить в файле boot.ini в корневом каталоге номер раздела, с которого будет грузиться Windows. Раньше у меня это был раздел №1, а теперь - №3.</p>

		<pre class="code">[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(<b>3</b>)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(<b>3</b>)\WINDOWS="Microsoft Windows XP Professional RU" /noexecute=optin /fastdetect</pre>

		<p>Теперь нужно исправить карту дисков GRUB, которая находится в файле /boot/grub/device.map:</p>

		<pre class="code">(fd0)   /dev/fd0
(hd0)   /dev/disk/by-id/ata-WDC_WD10EADS-65L5B1_WD-WCAU4A888959
(hd1)   /dev/disk/by-id/ata-ST34313A_6CR0J30R</pre>

		<p>Диском (hd0) должен быть тот, на который мы переносим систему. Или можно исправить номер диска в файле boot.ini Windows, так чтобы номер загрузочного диска совпадал с номером диска в device.map. Полезно также перед этим настроить привязку дисков в /etc/fstab к UUID раздела или к метке раздела, чтобы в случае путаницы с номерами дисков Linux всё-таки загрузился. Практически во всех современных системах Linux это уже так, т.к. с заменой драйвера IDE на унифицированный драйвер дисков, номер, под которым определится диск, стал непредсказуем.</p>

		<p>Дальше нужно обновить конфигурацию GRUB2:</p>

		<pre class="console"># update-grub</pre>

		<p>И можно перезагружаться. При первой загрузке нам потребуются оба диска, т.к. в реестре Windows сохранилась привязка к идентификатору прежнего диска. После загрузки системы запускаем regedit и редактируем раздел HKEY_LOCAL_MACHINE\SYSTEM\MountedDevices. В нём нужно поменять буквы дисков C и того, который по содержимому идентичен диску C. У меня это были диски C и D. Сделал я это в три приёма:</p>

		<ul>
			<li>C -&gt; Z</li>

			<li>D -&gt; C</li>

			<li>Z -&gt; D</li>
		</ul>

		<p>После этого завершаем работу, отключаем старый диск и пробуем загрузиться снова. Если всё было сделано правильно, система загрузится с нового диска.</p>

		<p>Я таким образом смог отключить противно свистящий старый диск, на котором у меня стоял Windows XP. Сама эта заметка является, по сути, продолжением предыдущей: <a href="../fancontrol/">Настройка fancontrol - демона управления вентиляторами компьютера</a>.</p>

		<p>Желаю вам удачного переноса Windows!</p>

		<p>P.S. 21 декабря 2013 года. Вместо программы ntfsreloc можно воспользоваться программой partclone.ntfsfixboot из пакета partclone. В этом случае вместо команды</p>

		<pre class="console"># ntfsreloc -w -p /dev/sdb3</pre>

		<p>можно воспользоваться командой</p>

		<pre class="console"># partclone.ntfsfixboot -w /dev/sdb3</pre>

		<p><a href="mailto:vladimir@stupin.su?subject=Перенос Windows XP на другой диск средствами Linux">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
