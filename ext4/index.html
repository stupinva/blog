<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="clonezilla,ext4,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2013-02-10 -->
		<title>Переход на ext4</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Переход на ext4</h1>

		<p>Опустим обсуждения о том, зачем вам может понадобиться ext4 вместо ext3, решайте за себя сами. Меня привлекла лишь функция онлайн-дефрагментации, поэтому решил попробовать, тем более что из детских штанишек эта файловая система, вроде как, уже вышла.</p>

		<p>Конвертировать можно только не смонтированные файловые системы, поэтому понадобится LiveCD или загрузочная флешка с каким-нибудь подходящим Linux'ом. Мне приглянулся Clonezilla, т.к. он основывается на Debian и в целом предназначен для работ подобного рода - разметки дисков, клонирования файловых систем и т.п.</p>

		<p>Скачиваем дистрибутив Clonezilla со страницы <a href="http://clonezilla.org/downloads.php">http://clonezilla.org/downloads.php</a>. Есть два варианта - скачать образ компакт-диска, или скачать архив для записи на флешку. С образом компакт-диска всё ясно - нужно просто скачать его и записать на диск. С архивом для записи на флешку всё немного сложнее - нужно разметить флешку, смонтировать её, распаковать на неё содержимое архива и запустить скрипт инсталляции.</p>

		<p>Отформатируем раздел флешки:</p>

		<pre class="console"># mkfs.vfat -F 32 /dev/sdb1</pre>

		<p>Смонтируем раздел, перейдём в него и распакуем в него архив:</p>

		<pre class="console"># mount /dev/sdb1 /mnt/usb1
# cd /mnt/usb1
# unzip /home/stupin/Downloads/clonezilla-live-2.0.1-15-amd64.zip</pre>

		<p>Теперь осталось сделать флешку загрузочной. Для этого перейдём в каталог со скриптом установки и запустим скрипт:</p>

		<pre class="console"># cd /mnt/usb1/utils/linux
# bash makeboot.sh /dev/sdb1</pre>

		<p>Осталось отмонтировать флешку:</p>

		<pre class="console"># umount /dev/sdb1</pre>

		<p>Теперь нужно загрузить компьютер с флешки (или с компакт-диска) и перейти в режим командной строки.</p>

		<p>Для конвертирования файловых систем из ext3 в ext4 нам нужны привилегии суперпользователя. Повысим привилегии пользователя, под которыми нас пустили в систему:</p>

		<pre class="console">$ sudo su -</pre>

		<p>Теперь вводим пару команд для каждой файловой системы, которую нужно конвертировать (у меня это разделы sda2 и sda6):</p>

		<pre class="console"># tune2fs -O extents,uninit_bg,dir_index /dev/sda2
# fsck -pf /dev/sda2</pre>

		<p>Первая команда отрабатывает довольно быстро, вторая же выполняется долго. На разделе размером 852 гигабайта вторая команда у меня работала полчаса.</p>

		<p>Теперь можно, хотя и совершенно не обязательно, дефрагментировать файловые системы с помощью команд:</p>

		<pre class="console"># mount /dev/sda2 /mnt
# e4defrag /dev/sda2</pre>

		<p>Команда дефрагментации требует, чтобы дефрагментируемая файловая система была смонтирована. У меня дефрагментация выполнялась в несколько раз дольше, чем конвертирование.</p>

		<p>Настало время поправить настройки системы, чтобы она правильно загрузилась.Во-первых, нужно поправить тип файловой системы в файле /etc/fstab. Для этого смонтируем корневой раздел системы и заменим ext3 на ext4 для каждого сконвертированного раздела:</p>

		<pre class="console"># mount /dev/sda2 /mnt
# vi /mnt/etc/fstab</pre>

		<p>Если был сконвертирован раздел с корневой файловой системой, то нужно ещё внести изменения в файл настройки загрузчика GRUB, добавив к опциям загрузки ядра текст rootfstype=ext4:</p>

		<pre class="console"># vi /mnt/boot/grub/grub.cfg</pre>

		<p>Теперь можно отмонтировать файловые системы и выполнить перезагрузку с жёсткого диска:</p>

		<pre class="console"># reboot</pre>

		<p>Загрузившись с жёсткого диска, первым делом нужно сделать настройки GRUB'а постоянными. Для этого откроем файл с настройками GRUB, добавим в опцию GRUB_CMDLINE_LINUX текст rootfstype=ext4 и перегенерируем, на всякий случай, файл конфигурации загрузчика:</p>

		<pre class="console"># vi /etc/defaults/grub
# update-grub</pre>

		<h2>Ссылки:</h2>

		<ol>
			<li><a href="http://welinux.ru/post/298/">How-to`s — Ускоряем debian</a></li>

			<li><a href="http://clonezilla.org/liveusb.php">Clonezilla Live on USB flash drive or USB hard drive</a></li>
		</ol>

		<p><a href="mailto:vladimir@stupin.su?subject=Переход на ext4">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
