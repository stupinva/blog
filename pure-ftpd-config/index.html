<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="pure-ftpd,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2008-10-04 -->
		<title>Замена pure-ftpd-wrapper на pure-config в Debian</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Замена pure-ftpd-wrapper на pure-config в Debian</h1>

		<p>Продолжаю переносить статьи со старого блога. К статье могу добавить комментарий, что в принципе установка pure-ftpd из deb-src была сделана с одной лишь целью - ознакомиться с технологией. pure-ftpd можно просто поставить двоичным пакетом, а из тарболла с исходниками просто взять нужный нам wrapper и настроить скрипт в /etc/init.d на использование этого wrapper'а.</p>

		<p>Перепробовал я под FreeBSD много разных FTP-серверов:</p>

		<ol>
			<li>родной bsdftpd, просто и со вкусом, ненужно заморачиваться с установкой, уже присутствует в самой системе;</li>

			<li>он же, но споддержкой SSL и TSL - bsdftpd-ssl, после предыдущего практически не нужно ничего перенастраивать, но сразу добавляются шифрованные варианты протокола;</li>

			<li>proftpd с конфигурационным файлом, подобным оному в Apache, гибко, но тяжело. К тому же в своё время без сторонних патчей прикрутить русскую локаль было невозможно (только не кидайте камнями, типа это не по стандарту: оно бывает нужно, а добавить эту возможность в виде опции разработчики поленились);</li>

			<li>vsftpd, легко и безопасно,s но почему-то тоже не прижился.</li>
		</ol>

		<p>В поисках совершенства начал использовать Debian.</p>

		<p>Человек я ленивый, а во FreeBSD тупо обновить систему с накатом обновлений безопасности сложновато:</p>

		<ol>
			<li>
				<p>сама система - cvsup, make buildworld, make buildkernel, make installkernel, перезагрузка, смотрим как работает свежее ядро, затем make installworld;</p>
				<p>можно и проще freebsd_update, но если ядро собрано своё - опять-таки ядро придётся пересобирать;</p>
			</li>

			<li>дерево портов cvsup или portsnap;</li>

			<li>проверка уязвимых установленных пакетов portaudit;</li>
			<li>установка свежих пакетов или установка из портов: portupgrade;</li>

			<li>исправление возможных глюков из-за обновлённых версий программ (конфиги поправить, запускные скрипты).</li>
		</ol>

		<p>Некоторые пакеты не работают правильно, пока их не пересобирёшь из портов (бывало такое, бывало)! На это опять-таки нужно тратить время, ресурсы системы (а машинки бывают очень слабенькие - компиляция среднего размера пакетов может идти часами), или извращаться с монтированием удалённых каталогов, компилировать на более мощной системе.</p>

		<p>В Debian тупо:</p>

		<pre class="console"># apt-get update
# apt-get upgrade</pre>

		<p>И все обновления безопасности стоят в системе, конфигов править не нужно! Можно легко сопровождать таким способом десятки серверов, полезно лишь поставить на одну из машинок apt-cacher, чтобы не грузить почём зря официальные зеркала.</p>

		<p>А учитывая, что в Debian есть достойная замена портам - deb-src, то жить становится значительно легче. И собственноручно собранные пакеты можно зафиксировать в системе, чтобы они не обновлялись вместе с остальными:</p>

		<pre class="console"># dpkg --get-selections \* &gt; selections.txt</pre>

		<p>Изменяем в selections.txt в строчке с названием пакета слово "install" на слово "hold".</p>

		<pre class="console"># dpkg --set-selections &lt; selections.txt</pre>

		<p>Захотелось мне поставить в качестве FTP-сервера pure-ftpd под Debian. Из достоинств: поддержка авторизации PAM (можно на свой вкус настроить на использование любых модулей), дедовский Unix (по файлам /etc/passwd, /etc/shadow, /etc/group), по собственной базе данных puredb, по базам данных в mysql и postgres, настройка дисковых квот, смена корня, ограничение пропускной способности и количества одновременных клиентов, поддержка различных кодовых страниц для конвертирования имён файлов и многое другое.</p>

		<p>Поставил, да вот незадача, у разработчиков Debian весьма нетрадиционное представление об удобстве его настройки. Поскольку pure-ftpd настраивается запуском с нужными опциями, а опций очень много, то хорошие люди придумали т.н. "wrapper", программу которая читает конфигурационный файл и запускает демон с нужными опциями. Так вот, в Debian кому-то очень понравилось хранить значения ключей настройки в отдельных файлах с соответствующими именами в каталоге /etc/pure-ftpd/conf/. Меня эта идея не вдохновила и я решил сменить перловый скрипт pure-ftpd-wrapper на стандартный pure-config.pl, идущий в комплекте с исходниками pure-ftpd.</p>

		<p>Устанавливаем пакеты, необходимые для установки из исходников (возможно я пропустил ещё какие-то нужные пакеты):</p>

		<pre class="console"># apt-get install dpkg-dev
# apt-get install fakeroot</pre>

		<p>Скачиваем и распаковываем исходники pure-ftpd:</p>

		<pre class="console"># apt-get source pure-ftpd</pre>

		<p>Переходим в каталог с исходниками:</p>

		<pre class="console"># cd pure-ftpd-1.0.21</pre>

		<p>Устанавливаем пакеты, необходимые для построения пакета pure-ftpd из исходников:</p>

		<pre class="console"># apt-get build-dep pure-ftpd</pre>

		<p>Строим пакет:</p>

		<pre class="console"># dpkg-buildpackage -rfakeroot -us -uc</pre>

		<p>Как вариант, можно воспользоваться скриптами в каталоге с распакованным pure-ftpd:</p>

		<pre class="console"># debian/rules build
# debian/rules binary</pre>

		<p>Выходим из каталога с исходниками:</p>

		<pre class="console"># cd ..</pre>

		<p>И попадаем в каталог, где лежат свежепостроенные пакеты. Устанавливаем пакет pure-ftpd_1.0.21-8_i386.deb:</p>

		<pre class="console"># dpkg -i pure-ftpd_1.0.21-8_i386.deb</pre>

		<p>Эта же технология применяется для установки любого пакета, если Вы хотите его настроить особым образом на этапе компиляции: наложить дополнительные патчи, изменить константы в исходных текстах, скомпилировать с дополнительными опциями или без ненужных.</p>

		<p>Далее, копируем новый скрипт в систему:</p>

		<pre class="console"># cp pure-ftpd-1.0.21/configuration-file/pure-config.pl /usr/sbin/pure-ftpd-config</pre>

		<p>И устанавливаем права на выполнение:</p>

		<pre class="console"># chmod a+x /usr/sbin/pure-ftpd-config</pre>

		<p>Теперь удаляем всё из каталога /etc/pure-ftpd/:</p>

		<pre class="console"># rm -R /etc/pure-ftpd/*</pre>

		<p>И копируем сюда пример конфигурационного файла:</p>

		<pre class="console"># cp pure-ftpd-1.0.21/configuration-file/pure-ftpd.conf /etc/pure-ftpd/</pre>

		<p>Исправляем скрипт запуска /etc/init.d/pure-ftpd, заменяем строчку:</p>

		<pre class="code">WRAPPER=/usr/sbin/pure-ftpd-wrapper</pre>

		<p>На нашу:</p>

		<pre class="code">WRAPPER=/usr/sbin/pure-ftpd-config</pre>

		<p>Добавляем после этого строчку:</p>

		<pre class="code">CONFIG=/etc/pure-ftpd/pure-ftpd.conf</pre>

		<p>Заменяем в секциях case start и restart|force-reload:</p>

		<pre class="code">--exec $WRAPPER -- $SUFFIX</pre>

		<p>на</p>

		<pre class="code">--exec $WRAPPER $CONFIG -- $SUFFIX</pre>

		<p>Я собираюсь запускать pure-ftpd как самостоятельный сервер, поэтому меняю настройки запуска по-умолчанию в файле /etc/default/pure-ftpd-common:</p>

		<p>Заменяю</p>

		<pre class="code">STANDALONE_OR_INETD=inetd</pre>

		<p>на</p>

		<pre class="code">STANDALONE_OR_INETD=standalone</pre>

		<p>На этом пока что всё. К сожалению по этому серверу на русском языке очень мало информации, есть несколько how-to, но это не документация.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Замена pure-ftpd-wrapper на pure-config в Debian">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
