<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="capabilities,ping,linux,перевод,posix" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2018-03-18 -->
		<title>Джим Макдоннелл. Linux Capabilities и ping, 2016</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Джим Макодннел. Linux Capabilities и ping, 2016</h1>

		<p>Перевод статьи: <a href="http://unixetc.co.uk/2016/05/30/linux-capabilities-and-ping/">Linux Capabilities and Ping</a></p>

		<p>Автор: Джим Макдоннелл (Jim McDonnell)</p>

		<p>Если вы используете свежую версию Linux (время написания заметки - май 2016), вы могли столкнуться с ошибкой утилиты ping:</p>

		<pre class="console">$ ping somehost
ping: icmp open socket: Operation not permitted</pre>

		<p>Так происходит, потому что двоичный файл ping больше не устанавливается с правами setuid. Он не имеет необходимых привилегий для открытия сокета и завершается аварийно. Это легко исправить при помощи команды:</p>

		<pre class="console">$ sudo setcap cap_net_raw+p /bin/ping</pre>

		<p>Предполагается, что двоичный файл ping находится в /bin/ping. Теперь он работает:</p>

		<pre class="console">$ ping somehost
PING somehost (123.123.123.123) 56(84) bytes of data.
64 bytes from 123.123.123.123: icmp_seq=1 ttl=53 time=9.14 ms</pre>

		<p>Вы только что добавили возможность - capability к двоичному файлу ping, что дало ping право открыть raw-сокет, который позволил выполнить проверку доступности удалённой системы.</p>

		<h2>1. Linux Capabilities - возможности Linux</h2>

		<p>Возможности Linux позволяют точно управлять видами привилегий, которые может использовать процесс или поток. Традиционно имелось только два уровня привилегий: root и не-root. Процесс, выполняющийся от имени root или суперпользователя, может выполнять с системой любые действия. Процесс, выполняющийся от имени других пользователей, может получить доступ только к тем файлам, которыми он владеет или к которым предоставлен доступ.</p>

		<p>Ранее, до появления возможностей, ping и другие системные инструменты устанавливались с флагом setuid, позволяющим им работать от имени пользователя root. Вот так:</p>

		<pre class="console">$ ls -l /bin/ping
-rwsr-xr-x 1 root root 44168 May 7 2014 /bin/ping</pre>

		<p>Символ "s" в строке разрешений соответствует флагу setuid, который означает, что ping будет выполняться с правами пользователя root, даже если он запущен обычным пользователем. Ping требует для работы повышенных привилегий. Вот несколько других программ, которые в Red Hat 6.5 по умолчанию устанавливаются с флагом setuid, который предписывает системе запускать их с правами root:</p>

		<pre class="console">$ find /bin -perm +4000 -ls
652330 76 -rwsr-xr-x 1 root root 77336 Aug 6 2013 /bin/mount
656520 32 -rwsr-x--- 1 root fuse 32336 Nov 3 2011 /bin/fusermount
652317 36 -rwsr-xr-x 1 root root 36488 Sep 17 2013 /bin/ping6
652333 56 -rwsr-xr-x 1 root root 53472 Aug 6 2013 /bin/umount
652316 40 -rwsr-xr-x 1 root root 40760 Sep 17 2013 /bin/ping
651661 36 -rwsr-xr-x 1 root root 34904 Oct 17 2013 /bin/su</pre>

		<h2>2. Опасность программ с флагом setuid</h2>

		<p>Механизм setuid отлично работает и широко распространён. Однако, он обладает низкой безопасностью. Процесс с флагом setuid во время работы получает гораздо больше привилегий, чем ему требуется на самом деле. Утилите ping требуется лишь открыть raw-сокет и права root, полученные ей через флаг setuid, позволяют это сделать, но также дают ей много других прав, которые ей не требуются. Если двоичный файл ping, например, был заменён взломанной версией, то код злоумышленника будет запущен с полными правами суперпользователя.</p>

		<p>Это одна из причин, по которой предпочтительнее использовать возможности Linux, нежели флаг setuid. Вот почему они с каждым выпуском Linux стали использоваться всё шире.</p>

		<h2>3. Наборы возможностей</h2>

		<p>Выше двоичному файлу ping были выданы права, которые называются cap_net_raw. сap_net_raw - это одна из большого количества возможностей, которых, согласно <a href="http://linux.die.net/man/7/capabilities">странице руководства</a>, насчитывается 38 штук.</p>

		<p>Каждый поток или процесс, обладает тремя наборами связанных с ним возможностей: Permitted - разрешённые, Inheritable - наследуемые и Effective - действующие. В примере выше, символы "+p" в команде "setcap cap_net_raw+p /bin/ping" добавили возможность cap_net_raw к набору разрешённых возможностей двоичного файла ping, которые означают, что последующий процесс (или поток) ping получит соответствующие права. Соотношения наборов возможностей, файлов и потоков, объясняются на соответствующей странице руководства.</p>

		<h2>4. CAP_NET_RAW</h2>

		<p>Возникает вопрос. Если ping для работы требуется определённая возможность или флаг setuid, почему тогда они не требуются другим сетевым утилитам, таким как ssh, ftp, wget и т.д.? И тем более, браузерам вроде Firefox и Safari? Разве им не требуется тоже открывать сетевые сокеты? Да, требуется, но не такие сокеты.</p>

		<p>Давайте воспользуемся <a href="http://unixetc.co.uk/2012/10/28/profiling-and-tracing-processes-in-linux/">strace</a> и посмотрим, как ping открывает сокет:</p>

		<pre class="console">$ strace -e socket ping 192.168.1.254
socket(PF_INET, SOCK_RAW, IPPROTO_ICMP) = 3
...</pre>

		<p>ping открывает сокет типа SOCK_RAW.</p>

		<p>Попробуем сделать то же самое с FTP и увидим, что он не открывает сокет типа SOCK_RAW. Он использует сокет типа SOCK_STREAM:</p>

		<pre class="console">$ strace -e socket ftp 192.168.1.254
socket(PF_INET, SOCK_STREAM, IPPROTO_IP) = 3
ftp: connect: Connection refused</pre>

		<p>Как и ожидалось. SOCK_STREAM создаёт полное транспортно-ориентированное подключение через сокет TCP для длительной связи. С другой стороны, SOCK_RAW просто даёт доступ к нижестоящему уровню IP, позволяя ping отправлять пакеты <a href="https://ru.wikipedia.org/wiki/ICMP">ICMP</a> напрямую.</p>

		<p>Таким образом, CAP_NET_RAW позволяет открывать сокет типа SOCK_RAW, но не требуется для сокетов SOCK_STREAM.</p>

		<h2>5. ping в различных дистрибутивах Linux</h2>

		<p>Утилита ping полезна для пользователей, администраторов и разработчиков. В действительности, нет никакого смысла давать к ней доступ только пользователю root. Некоторые дистрибутивы согласны с этим мнением и в них необходимые возможности назначены ping по умолчанию. В более старых выпусках зачастую в ядре имеется поддержка возможностей, но ping не настроен для их использования.</p>

		<p>Выпуски, в которых утилите ping уже предоставлены возможности:</p>

		<ul>
			<li>Red Hat 7.0, где утилите ping предоставлены возможности cap_net_admin,cap_net_raw+ep</li>

			<li>Raspbian (Debian 8 Jessie) в выпуске мая 2016 года (но не в феврале 2016)</li>
		</ul>

		<p>Выпуски, в которых возможности не установлены:</p>

		<ul>
			<li>Red Hat 6.5</li>

			<li>SLES 12 (getcap/setcap по умолчанию не установлены)</li>

			<li>Ubuntu 14.04/Mint 17</li>
		</ul>

		<h2>6. Благодарности</h2>

		<p>При написании этой статьи была использована информация из <a href="http://linux-audit.com/linux-capabilities-hardening-linux-binaries-by-removing-setuid/">Linux Audit</a>.</p>

		<h2>7. Примечания переводчика</h2>

		<p>Этот перевод сделан вдогонку к прошлой статье <a href="../uwsgi-capabilities/">Пересборка uwsgi с поддержкой Linux Capabilities</a>. Пока искал документацию о том, как скрестить uwsgi и POSIX Capabilities, наткнулся на эту статью. Сразу добавил ссылку в закладки, чтобы впоследствии перевести. Кстати, описанная в этой статье ошибка попадалась коллегам на работе. Я посоветовал просто принудительно переустановить пакет командой apt-get --reinstall install ping и это помогло. Причины были мне понятны, но вот о существовании команд для раздачи "возможностей" я не подозревал: мне почему-то казалось, что программы самостоятельно запрашивают необходимые им привилегии у ядра операционной системы.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Джим Макдоннелл. Linux Capabilities и ping, 2016">Написать автору перевода</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
