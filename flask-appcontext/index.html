<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="python,перевод,flask" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2013-04-14 -->
		<title>Армин Роначер. Контекст приложения Flask, 2012</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Армин Роначер. Контекст приложения Flask, 2012</h1>

		<p>Перевод статьи: <a href="http://flask.pocoo.org/docs/appcontext/">The Application Context</a></p>

		<p>Автор: Армин Роначер (Armin Ronacher)</p>

		<p>Новинка версии 0.9</p>

		<p>Одно из проектных решений Flask заключается в том, что есть два разных "состояния", в которых выполняется код. Состояние настройки приложения, которое подразумевается на уровне модуля. Оно наступает в момент, когда создаётся экземпляр объекта Flask, и заканчивается когда поступает первый запрос. Пока приложение находится в этом состоянии, верно следующее:</p>

		<ul>
			<li>программист может безопасно менять объект.</li>

			<li>запросы ещё не обрабатывались.</li>

			<li>у вас имеется ссылка на объект приложения, чтобы изменить его, нет необходимости пользоваться каким-либо посредником для того, чтобы получить ссылку на созданный или изменяемый объект приложения.</li>
		</ul>

		<p>Напротив, во время обработки запроса верны следующие правила:</p>

		<ul>
			<li>пока активен запрос, объекты локального контекста (flask.request и другие) указывают на текущий запрос.</li>

			<li>любой код может в любое время может заполучить эти объекты.</li>
		</ul>

		<p>Есть и третье состояние, которое располагается между ними. Иногда можно работать с приложением так же, как и во время обработки запроса, просто в этот момент нет активного запроса. Например, вы можете работать с интерактивной оболочкой Python и взаимодействовать с приложением или запустить приложение из командной строки.</p>

		<p>Контекст приложения - это то, чем управляет локальный контекст current_app.</p>

		<h2>1. Назначение контекста приложения</h2>

		<p>Основная причина существования контекста приложений состоит в том, что в прошлом большая доля функциональности была привязана к контексту запроса за неимением лучшего решения. Тогда одной из целей, учитываемых при проектировании Flask, было обеспечение возможности иметь несколько приложений в рамках одного процесса Python.</p>

		<p>Каким образом код находит "правильное" приложение? В прошлом мы рекомендовали явную передачу приложений, но появились проблемы с библиотеками, которые не были спроектированы с учётом этого.</p>

		<p>Обходной путь решения этой проблемы заключался в том, чтобы использовать посредника current_app, привязанного ссылкой к текущему запросу приложения. Но поскольку создание такого контекста запроса является не оправданно дорогостоящим в случае отсутствия запроса, был введён контекст приложения.</p>

		<h2>2. Создание контекста приложения</h2>

		<p>Для создания контекста приложения есть два способа. Первый из них - неявный: когда поступает контекст запроса, при необходимости также создаётся и контекст приложения. В результате вы можете игнорировать существование контекста приложения до тех пор, пока он вам не понадобится.</p>

		<p>Второй способ - это явное создание контекста при помощи метода app_context():</p>

		<pre class="code">from flask import Flask, current_app

app = Flask(__name__)

with app.app_context():
    # Внутри этого блока current_app указывает на app.
    print current_app.name</pre>

		<p>Контекст приложения также используется функцией url_for() в случае, если было настроено значение параметра конфигурации SERVER_NAME. Это позволяет вам генерировать URL'ы даже при отсутствии запроса.</p>

		<h2>3. Локальность контекста</h2>

		<p>Контекст приложения создаётся и уничтожается при необходимости. Он никогда не перемещается между потоками и не является общим для разных запросов. Поэтому - это идеальное место для хранения информации о подключении к базе данных и т.п. Внутренний объект стека называется flask._app_ctx_stack. Расширения могут хранить дополнительную информацию на самом верхнем уровне, если предполагается, что они выбрали достаточно уникальное имя.</p>

		<p>За дополнительной информацией по теме обратитесь к разделу <a href="http://flask.pocoo.org/docs/extensiondev/">Разработка расширений Flask</a>.</p>

		<h2>4. Примечания переводчика</h2>

		<p><a href="https://flask-russian-docs.readthedocs.org/en/latest/appcontext.html">Этот</a> и другие переводы можно найти на <a href="https://flask-russian-docs.readthedocs.org/">сайте проекта перевода документации по Flask</a>. Автор проекта - Виталий Кузьмин aka ferm32.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Армин Роначер. Контекст приложения Flask, 2012">Написать автору перевода</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
