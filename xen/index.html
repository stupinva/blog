<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="xen,wheezy,lvm2,linux,debian" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2014-06-01 -->
		<title>Памятка по настройке Xen</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Памятка по настройке Xen</h1>

		<p>Xen - довольно распространённая и хорошо зарекомендовавшая себя система виртуализации. В ней можно выделить три главных компонента:</p>

		<ul>
			<li><b>Гипервизор</b> - небольшое ядро, осуществляющее управление памятью и процессором,</li>

			<li><b>dom0</b> - система, находящаяся под управлением гипервизора, но определяющая политику распределения памяти и процессоров, которую и реализует гипервизор,</li>

			<li><b>domU</b> - система, находящаяся под управлением гипервизора.</li>
		</ul>

		<p>dom0, как и гипервизор, в системе может быть только один. domU может быть несколько. Для простоты в статье будем называть dom0 хост-системой, а domU - гостевыми системами, хотя строго говоря - они оба скорее гости, просто один из них имеет право управлять гипервизором.</p>

		<p>Сервисы Xen, работающие в dom0 и осуществляющие управление гипервизором, написаны на Python. Соответственно, файлы конфигурации являются фактически исходными текстами на языке Python.</p>

		<p>Ниже собран мой небольшой опыт работы с этой системой виртуализации. Не описываются настройка репозиториев, настройка сети, фаерволла и другого базового ПО. Описано только то, что имеет непосредственное отношение к настройке виртуализации.</p>

		<h2>1. Настройка гипервизора</h2>

		<p>Устанавливаем пакет xen-linux-system:</p>

		<pre class="console"># apt-get install xen-linux-system</pre>

		<p>Выставляем приоритет загрузки гипервизора Xen из GRUB:</p>

		<pre class="console"># dpkg-divert --divert /etc/grub.d/08_linux_xen --rename /etc/grub.d/20_linux_xen</pre>

		<p>Для отмены приоритета загрузки Xen из GRUB можно выполнить следующую команду:</p>

		<pre class="console"># dpkg-divert --rename --remove /etc/grub.d/20_linux_xen</pre>

		<p>Чтобы настройки GRUB вступили в силу, запустим обновление конфигурации GRUB:</p>

		<pre class="console"># update-grub</pre>

		<h2>2. Настройка хост-системы</h2>

		<p>Образы гостевых систем будем размещать на логических томах LVM2, поэтому сначала установим утилиты для управления логическими томами:</p>

		<pre class="console"># apt-get install lvm2</pre>

		<p>Создадим новый физический том на специально выделенном для этого разделе:</p>

		<pre class="console"># vgcreate vg0 /dev/sda3</pre>

		<p>Установим инструменты для создания образов и управления гостевыми системами:</p>

		<pre class="console"># apt-get install xen-tools</pre>

		<p>Пропишем в файле /etc/xen-tools/xen-tools.cfg опции, задающие настройки создаваемой по умолчанию виртуальной машины:</p>

		<pre class="code"># Использовать для образов гостевых систем физический том VG0
lvm = vg0

# Использовать debootstrap для установки системы на гостевой том
install-method = debootstrap

# Выделить для вновь создаваемой гостевой системы 10 гигабайт на логическом томе
size = 10Gb

# По умолчанию создавать гостевую систему, которой выделено 2 гигибайта оперативной памяти
memory = 2Gb

# По умолчанию создавать гостевую систему, которой выделен 1 гигабайт раздела подкачки
#noswap = 0
swap = 1Gb

# По умолчанию использовать файловую систему ext4
fs = ext4

# Настройки монтирования раздела ext4
ext4_options = noatime,nodiratime,errors=remount-ro

# Настройки задают ветку дистрибутива, версию ядра и загрузочного образа
dist = `xt-guess-suite-and-mirror --suite`
image = sparse
kernel = /boot/vmlinuz-`uname -r`
initrd = /boot/initrd.img-`uname -r`
pygrub = 1
mirror = `xt-guess-suite-and-mirror --mirror`</pre>

		<p>Все гостевые системы будут подключаться к виртуальному сетевому мосту, соединённому с физической сетевой картой. На самом деле сетевой мост является по сути виртуальным коммутатором, поддерживающим протокол STP, но по сложившейся традиции называется сетевым мостом. Установим утилиты для управления сетевым мостом:</p>

		<pre class="console"># apt-get install bridge-utils</pre>

		<p>Настроим интерфейс xenbr0, подсоединив его к физическому сетевому интерфейсу eth0. Для этого впишем в файл /etc/network/interfaces следующие настройки:</p>

		<pre class="code">auto xenbr0
iface xenbr0 inet static
  address 10.0.0.1
  netmask 255.255.255.0
  bridge_ports eth0
  bridge_maxwait 0</pre>

		<h2>3. Создание образа гостевой системы</h2>

		<p>Для создания образа новой гостевой системы с именем ns, настройками по умолчанию, но с двумя выделенными системе ядрами процессора, введём на хост-системе следующую команду:</p>

		<pre class="console"># xen-create-image --hostname ns --ip 10.0.0.2 --netmask 255.255.255.0 --gateway 10.0.0.1 --vcpus 2 --dist wheezy</pre>

		<p>После создания образа будет выведен пароль пользователя root в только что созданной системе. Его необходимо запомнить или записать и поменять при первом запуске созданного образа.</p>

		<p>Теперь можно отредактировать конфигурацию только что созданной гостевой машины /etc/xen/ns.cfg:</p>

		<pre class="code">vif = [ 'script=vif-bridge, bridge=xenbr0' ]</pre>

		<p>При запуске гостевой машины её первый интерфейс будет подключен к мосту хост-машины xenbr0. Если необходимо создать несколько сетевых интерфейсов, можно перечислить их внутри квадратных скобок через запятую.</p>

		<h2>4. Управление гостевыми системами</h2>

		<p>Запуск гостевой машины:</p>

		<pre class="console"># xm create /etc/xen/ns.cfg</pre>

		<p>Просмотр списка активных гостевых машин:</p>

		<pre class="console"># xm list</pre>

		<p>Просмотра потребления ресурсов внутри каждой гостевой машины:</p>

		<pre class="console"># xm top</pre>

		<p>Остановка гостевой машины:</p>

		<pre class="console"># xm shutdown ns</pre>

		<p>Вход на консоль гостевой машины:</p>

		<pre class="console"># xm console ns</pre>

		<p>Для отключения от консоли можно нажать Ctrl и ] К сожалению, эта же комбинация клавиш используется в telnet, поэтому я предпочитаю сразу настроить сеть и SSH, а дальнейшую настройку гостевой системы осуществлять уже через SSH.</p>

		<h2>5. Донастройка гостевых систем</h2>

		<p>Файл конфигурации гостевой системы может выглядеть примерно следующим образом:</p>

		<pre class="code"># Загрузчик pygrub позволяет передавать в ядро настройки,
# подобно тому как это делается при использовании GRUB
bootloader = '/usr/lib/xen-4.1/bin/pygrub'

# Количество процессорных ядер и объём памяти, выделяемый гостевой системе
vcpus       = '2'
memory      = '2048'

root        = '/dev/xvda2 ro'
disk        = [ 'phy:/dev/vg0/ns-disk,xvda2,w', # Образ диска находится на томе LVM2
                'phy:/dev/sda3,xvda3,w' ]       # Том хост-системы монтируется внутри гостевой системы

# Имя гостевой системы
name        = 'ns'

# На гостевой системе будут созданы интерфейсы eth0 и eth1, подключенные
# соответственно к сетевым мостам хост-системы xenbr0 и xenbr1
vif         = [ 'script=vif-bridge, bridge=xenbr0',
                'script=vif-bridge, bridge=xenbr1' ]

# Что делать с гостевой системой, если она решила выключиться или перезагрузиться
on_poweroff = 'destroy'
on_reboot   = 'restart'

# Что делать с гостевой системой, если произошла ошибка на хост-системе
on_crash    = 'restart'

# Отдельно задаём поведение гостевых систем при перезапуске сервиса управления
on_xend_start = 'ignore'
on_xend_stop = 'ignore'</pre>

		<h2>6. Что следует установить в гостевую систему?</h2>

		<p>Я для себя сформировал следующий контрольный список:</p>

		<pre class="console"># apt-get install vim less apt-file resolvconf binutils screen rsync
# apt-get install sysstat tcpdump file dnsutils telnet psmisc 
# apt-get install openntpd sudo postfix bsd-mailx logwatch</pre>

		<p>Не всё из этого необходимо, поэтому вы можете оставить из этого списка то, что вам нужно и дополнить его пакетами по своему вкусу. При установке openntpd и postfix стоит подумать об их настройке.</p>

		<p>Если вам когда-нибудь понадобится воспользоваться консолью гостевой системы, стоит установить пакеты, ответственные за консоль, клавиатуру и локаль:</p>

		<pre class="console"># apt-get install console-setup keyboard-configuration</pre>

		<p>Соответственно, можно задать их настройки при помощи следующих команд:</p>

		<pre class="console"># dpkg-reconfigure console-setup
# dpkg-reconfigure keyboard-configuration
# dpkg-reconfigure locales</pre>

		<p>Ниже приведены пункты конфигурирования, отличающиеся от значений по умолчанию, которые я обычно выбираю для настройки этих пакетов:</p>

		<pre>Keyboard layout: Other
Country of origin for the keyboard: Russian
Keyboard layout: Russian

Encoding to use on the console: UTF-8
Character set to support: Cyrillic - KOI8-R and KOI8-U

Default locale for the systemm environment: ru_RU.UTF-8</pre>

		<h2>7. Отключение сохранения-восстановления гостевых систем</h2>

		<p>При остановке демона xen, а также при выключении и перезагрузке системы, демон по умолчанию пытается сохранить состояние всех гостевых систем в каталог /var/lib/xend/storage, из-за чего может закончиться всё место на диске.</p>

		<p>Изменить это поведение можно в файле /etc/default/xendomains настройкой значения XENDOMAINS_SAVE. Можно указать другой каталог, в котором есть достаточно места для сохранения образов оперативной памяти гостевых систем, а можно полностью отключить сохранение, указав пустое значение:</p>

		<pre class="code">XENDOMAINS_SAVE=</pre>

		<p>Чтобы удалить сохранённые образы памяти гостевых систем, можно воспользоваться следующими командами:</p>

		<pre class="console"># cd /var/lib/xen
# find . -type f -delete</pre>

		<h2>8. Автозапуск виртуальных машин</h2>

		<p>По умолчанию при перезагрузке хост-системы восстанавливается сохранённое состояние гостевых систем. Если мы отключили сохранение и восстановление гостевых систем, то гостевые системы запущены не будут. Чтобы гостевые системы автоматически загружались при загрузке хост-системы, нужно создать каталог автозапуска и поместить внутрь него символические ссылки на конфигурации необходимых гостевых систем:</p>

		<pre class="console"># mkdir /etc/xen/auto
# cd /etc/xen/auto
# ln -s /etc/xen/ns.cfg .</pre>

		<h2>9. Решение проблем</h2>

		<h3>9.1. Ошибка настройки сети</h3>

		<p>Гостевая система долго запускается, а затем выдаёт ошибку настройки сети:</p>

		<pre class="code">"Error: Device 0 (vif) could not be connected. Could not find bridge, and none was specified".</pre>

		<p>В этом случае нужно просто отключить скрипт настройки сети, который запускается для всех гостевых систем. Для этого нужно закомментировать строку в файле /etc/xen/xend-config.sxp на хост-системе:</p>

		<pre class="code">#(vif-script vif-bridge)</pre>

		<h3>9.2. Ошибка запуска xen</h3>

		<p>Если команда xm list выдаёт ошибку:</p>

		<pre class="code">Error: Unable to connect to xend: No such file or directory. Is xend running?</pre>

		<p>При запуске демонов xen при помощи команды /etc/init.d/xen start выводится ошибка:</p>

		<pre class="code">[FAIL] Starting Xen daemons: xenstored xenconsoled xend failed!</pre>

		<p>И в журнале /var/log/xen/xend.log имеется запись вида:</p>

		<pre class="code">[2013-12-06 09:21:27 4789] ERROR (SrvDaemon:349) Exception starting xend (unclosed token: line 1282, column 32)</pre>

		<p>Значит повреждено содержимое хранилища xen в каталоге /var/lib/xend и для запуска демонов xen его необходимо очистить при помощи команд:</p>

		<pre class="console"># cd /var/lib/xend
# find . -type f -delete</pre>

		<p><a href="mailto:vladimir@stupin.su?subject=Памятка по настройке Xen">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
