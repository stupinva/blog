<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="asfxload,midi,alsa,timidity,debian,fluidsynth" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2012-05-18 -->
		<title>Настройка воспроизведения MIDI в Debian GNU/Linux</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка воспроизведения MIDI в Debian GNU/Linux</h1>

		<p>С MIDI я разбирался несколько раз. Первый раз я настраивал воспроизведение MIDI для игры Doom (<a href="../prboom-music-part1/">Музыка в PrBoom</a>). Потом я ставил дополнительные сэмплы для того, чтобы улучшить качество воспроизведения музыки в Doom и заставить звучать те инструменты, сэмплы которых не входили в комплект программного секвенсора timidity (<a href="../prboom-music-part2/">Музыка MIDI - улучшаем звук</a>). Потом я купил подержанную звуковую карту Creative SoundBlaster Live 5.1! и настроил аппаратный её секвенсор.</p>

		<p>Возможно кто-то удивится и не поймёт, зачем мне устаревшая подержанная звуковая карта? Объясняю - преимущество этой звуковой карты заключается в том, что она имеет собственную память объёмом 32 мегабайта. В эту память можно загрузить микропрограммы с эффектами или фильтрами для звука, а можно загрузить сэмплы. Современные звуковые карты во-первых зачастую уже не имеют аппаратных секвенсоров MIDI, т.к. MIDI на компьютерах давно вышел из моды, а во-вторых - используют для своих нужд прямой доступ к оперативной памяти компьютера. С одной стороны это может быть и хорошо, потому что звуковая карта может использовать сэмплы, общий объём которых ограничен только объёмом оперативной памяти компьютера, а с другой стороны это не очень хорошо, т.к. при этом звуковая карта теряет автономность и становится сильно зависимой от пропускной способности шины.</p>

		<p>Мне же иногда хочется играть в старые игры для DOS, которые запускаются в DosBox в режиме частичной эмуляции. В старых играх мне хочется слышать ту MIDI-музыку, которая была сделана специально для игры и была встроена в неё. Но, поскольку мой компьютер староват, вычислительной мощности процессора иногда не хватает на одновременную частичную эмуляцию среды Dos и синтеза звука программным MIDI-секвенсором. В таких случаях звук начинает заикаться, а игра притормаживать. Выхода три: 1. отказаться эстетствовать и не слушать музыку в старых играх, а то и вовсе в них не играть, 2. купить мощный компьютер, что чревато лишними расходами и дополнительными хлопотами, 3. купить подходящую звуковую карту, а заодно узнать что-то новое о настройке аппаратных MIDI-секвенсоров.</p>

		<p>Довелось мне даже испытать работу MIDI-клавиатуры (с интерфейсом USB), которую давал мне друг. Интересно, что она определилась и заработала сходу - мне для этого не понадобилось ставить никаких драйверов, не пришлось делать каких-то настроек. Я просто поставил Rosegarden (аналог Cakewalk для Linux) и клавиатура с ним прекрасно заработала.</p>

		<p>Все эти мои эксперементы сопровождались дополнениями вики-страницы, содержимое которой я сейчас и приведу.</p>

		<h2>1. Список секвенсоров</h2>

		<p>Узнать список доступных MIDI-секвенсоров можно с помощью следующей команды:</p>

		<pre class="console">$ aplaymidi -l</pre>

		<p>У меня эта команда выдаёт следующее:</p>

		<pre class="console">Port    Client name                      Port name
 14:0    Midi Through                     Midi Through Port-0
 16:0    SB Live! 5.1 Dell OEM [SB0228]   EMU10K1 MPU-401 (UART)
 17:0    Emu10k1 WaveTable                Emu10k1 Port 0
 17:1    Emu10k1 WaveTable                Emu10k1 Port 1
 17:2    Emu10k1 WaveTable                Emu10k1 Port 2
 17:3    Emu10k1 WaveTable                Emu10k1 Port 3
 20:0    CA0106                           CA0106 MPU-401 (UART)</pre>

		<p>Аппаратному MIDI-секвенсору соответствуют порты 17:0, 17:1, 17:2, 17:3. Дополнительные его характеристики можно узнать с помощью следующей команды:</p>

		<pre class="console">$ cat /proc/asound/card0/wavetableD1</pre>

		<p>Которая должна выдать примерно следующую информацию:</p>

		<pre class="console">Device: Emu10k1
Ports: 4
Addresses: 17:0 17:1 17:2 17:3
Use Counter: 0
Max Voices: 64
Allocated Voices: 0
Memory Size: 134217728
Memory Available: 134213632
Allocated Blocks: 1
SoundFonts: 0
Instruments: 0
Samples: 0
Locked Instruments: 0
Locked Samples: 0</pre>

		<h2>2. Программный секвенсор timidity</h2>

		<p>При отсутствии аппаратных MIDI-секвенсоров (секвенсоров, имеющихся прямо в звуковой карте) можно установить программный MIDI-секвенсор:</p>

		<pre class="console"># apt-get install timidity</pre>

		<p>Вместе с timidity будет установлен набор семплов (иначе называемых Gravis Ultra Sount Patches или коротко - GUS-патчей) freepats.</p>

		<h2>3. Улучшенные сэмплы в timidity</h2>

		<p>Набор семплов, устанавливаемый freepats, не полный и не отличается высоким качеством, поэтому можно установить дополнительный набор патчей из состава fluidsynth:</p>

		<pre class="console"># apt-get install fluid-soundfont-gm fluid-soundfont-gs</pre>

		<p>В файле /etc/timidity/freepats.cfg добавляем следующие строчки (я добавил в начало):</p>

		<pre class="code">dir /usr/share/sounds/sf2/
soundfont FluidR3_GM.sf2 order=0
soundfont FluidR3_GS.sf2 order=1</pre>

		<p>И перезапускаем секвенсор:</p>

		<pre class="console"># /etc/init.d/timidity restart</pre>

		<h2>4. Программный секвенсор fluidsynth</h2>

		<p>Имеется альтернативный программный MIDI-секвенсор, который называется fluidsynth. Установить его можно следующей командой:</p>

		<pre class="console"># apt-get install fluidsynth</pre>

		<p>Секвенсор fluidsynth не имеет сценария инициализации, поэтому для его запуска необходимо написать простенький сценарий инициализации или запустить его вручную, например так:</p>

		<pre class="console">$ fluidsynth -a alsa -i /usr/share/sounds/sf2/FluidR3_GM.sf2 -i /usr/share/sounds/sf2/FluidR3_GS.sf2 -m alsa_seq -r 44100 -s</pre>

		<h2>5. Аппаратный секвенсор</h2>

		<p>Если в вашей звуковой карте имеется аппаратный MIDI-секвенсор, необходимо подгрузить модуль ядра snd-emu10k1-synth:</p>

		<pre class="console"># modprobe snd-emu10k1-synth</pre>

		<p>Если в выводе lsmod появится подгруженный модуль, значит аппаратный MIDI-секвенсор в вашей звуковой карте есть и для его использования необходимо загрузить в звуковую карту сэмплы.</p>

		<p>Для загрузки семплов в звуковую карту необходимо установить пакет awesfx:</p>

		<pre class="console"># aptitude install awesfx</pre>

		<p>Загрузить сэмплы из пакетов fluid-soundfont-gm и fluid-soundfont-gs можно с помощью команд:</p>

		<pre class="console">$ asfxload /usr/share/sounds/sf2/FluidR3_GM.sf2
$ asfxload -N /usr/share/sounds/sf2/FluidR3_GS.sf2</pre>

		<p>Первая команда загружает сэмплы вместо имеющихся, а вторая - добавляет сэмплы к имеющимся.</p>

		<p>Для автоматической подгрузки модуля ядра при загрузке системы необходимо добавить модуль snd-emu10k1-synth в файл /etc/modules.</p>

		<h2>6. Выбор секвенсора по-умолчанию</h2>

		<p>Для настройка MIDI-секвенсора по умолчанию для определённого пользователя нужно прописать в его файл ~/.bashrc следующие строчки:</p>

		<pre class="code">ALSA_OUTPUT_PORTS="17:0 17:1 17:2 17:3"
export ALSA_OUTPUT_PORTS</pre>

		<p>Предполагается, что оболочкой по умолчанию у пользователя назначен bash. Настройки вступают в силу при входе пользователя. Для временного применения настроек по умолчанию (до конца сеанса пользователя) можно выполнить эти команды прямо из командной строки.</p>

		<h2>7. Воспроизведение музыки</h2>

		<p>Воспроизвести музыку можно с помощью любого проигрывателя, поддерживающего воспроизведение MIDI, например pmidi:</p>

		<pre class="console"># apt-get install pmidi</pre>

		<p>Воспроизведение музыки:</p>

		<pre class="console">$ pmidi track.mid</pre>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка воспроизведения MIDI в Debian GNU/Linux">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
