<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="buster,linux,debian,snmp" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2020-07-26 -->
		<title>Отключение сообщений об ошибках на стандартный ввод-вывод в net-snmp</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Отключение сообщений об ошибках на стандартный ввод-вывод в net-snmp</h1>

		<p>Есть у меня один скрипт на Python, использующий привязки к библиотеке Net-SNMP. Скрипт отмечает результаты своей работы в базе данных и выводит сообщения об ошибках только при каких-то совсем уж неожиданных ошибках, например, при отсутствии связи с этой базой данных. Если же скрипт отработал шататно, он не должен выводить никаких сообщений. Поскольку сркипт регулярно запускался через планировщик задач cron, то при ошибках весь вывод скрипта отправлялся мне по почте. В общем, всё как обычно.</p>

		<p>Раньше скрипт выполнял запросы только по протоколам SNMP первой и второй версии. Когда же в сети появились устройства, доступные только по протоколу SNMP третьей версии, скрипт начал выводить ошибки такого вида:</p>

		<pre class="code">Authentication failed for backup</pre>

		<p>backup - это имя пользователя SNMPv3, под которым не удавалось выполнить SNMP-запросы.</p>

		<p>Поскольку скрипт анализирует результаты запросов SNMP, то эти диагностические сообщение лишь засоряют вывод скрипта. Как оказалось, эти сообщения выводит сама библиотека Net-SNMP и я не нашёл никаких способов для того, чтобы их отключить, например, через конфигурацию /etc/snmp/snmp.conf. Чтобы отключить эти сообщения, потребуется поправить исходный текст библиотеки. Скачаем и распакуем пакет с исходными текстами net-snmp:</p>

		<pre class="console">$ apt-get source net-snmp</pre>

		<p>Наши правки к исходному коду оформим в виде заплатки при помощи инструмента quilt, подробнее о котором я писал в заметке <a href="../quilt/">Использование quilt для подготовки заплат</a>. Создадим новую заплатку:</p>

		<pre class="console">$ quilt new removed-redundant-log-message</pre>

		<p>Добавим в будущую заплатку файл:</p>

		<pre class="console">$ quilt add snmplib/snmpusm.c</pre>

		<p>Открываем файл snmplib/snmpusm.c в текстовом редакторе, находим и удаляем две строчки с вызовом функции snmp_log:</p>

		<pre class="code">            snmp_log(LOG_WARNING, "Authentication failed for %s\n",
                                user-&gt;name);</pre>

		<p>В этом же файле при подобных ошибках функции snmp_log не вызываются и это единственный вызов snmp_log в этом файле. Скорее всего этот вызов функции был оставлен по ошибке, а не удалён вместе с другими подобными вызовами.</p>

		<p>Чтобы изменения в файле snmplib/snmpusm.c попали в заплатку, обновляем заплатку:</p>

		<pre class="console">$ quilt refresh</pre>

		<p>Можно прокомментировать сделанные в пакете изменения и изменить версию пакета:</p>

		<pre class="console">$ dch -i</pre>

		<p>В запустившемся редакторе описываем последние изменения:</p>

		<pre class="code">net-snmp (5.7.3+dfsg-5-stupin1) UNRELEASED; urgency=medium

  * Fixed SNMPv3 time widnow logic to work with D-Link switches
  * Removed redundant log message "Authentication failed from"

 -- Vladimir Stupin &lt;vladimir@stupin.su&gt;  Fri, 15 May 2020 16:01:26 +0500</pre>

		<p>Теперь можно пересобрать deb-пакеты, выполнив команду:</p>

		<pre class="console">$ debuild -us -uc</pre>

		<p>В вышестоящем каталоге появятся готовые deb-пакеты, которые можно установить в систему командой dpkg -i или поместить в репозиторий пакетов при помощи aptly. Почитать об использовании aptly можно в другой моей заметке <a href="../aptly/">Создание своего репозитория Debian при помощи aptly</a>.</p>

		<p>После установки исправлений надоедливые сообщения об ошибках пропали.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Отключение сообщений об ошибках на стандартный ввод-вывод в net-snmp">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
