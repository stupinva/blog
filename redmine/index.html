<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="redmine,nginx,debian,linux,wheezy,uwsgi,php-fpm" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2014-09-28 -->
		<title>Установка Redmine в Debian Wheezy</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Установка Redmine в Debian Wheezy</h1>

		<p>Эту заметку отчасти можно рассматривать как продолжение заметки <a href="../nginx-php-fpm-uwsgi/">Настройка nginx, php5-fpm и uwsgi</a>. Здесь я покажу, как можно запустить <a href="https://ru.wikipedia.org/wiki/Redmine">Redmine</a> под управлением uwsgi.</p>

		<p>Redmine - это система управления проектами, планирования и учёта рабочего времени. Изначально создавалась программистами для программистов, однако на практике может быть полезна различному кругу пользователей. В ней можно вести заявки пользователей на реализацию какой-то новой функциональности, отмечать информацию об обнаруженных ошибках, отмечать процесс разработки и устранения ошибок, вести документацию и т.п.</p>

		<p>Написана эта система на языке Ruby и с использованием очень известного за пределами Ruby-мира веб-фреймворка Rails. Запустить дистрибутивный Redmine мне удалось далеко не с первого раза: сначала появлялась какая-то ошибка обработки UTF-8, которую удалось решить переключением с Ruby1.9.1 на Ruby1.8, потом я долго не мог справиться с неполной передачей данных между веб-сервером и uwsgi, которая решилась указанием специальной опции буферизации uwsgi.</p>

		<h2>1. Установка пакетов</h2>

		<p>Для начала установим необходимые пакеты:</p>

		<pre class="console"># apt-get install redmine redmine-mysql ruby1.8 uwsgi uwsgi-plugin-rack-ruby1.8 nginx-full</pre>

		<p>Как уже понятно из состава установленных пакетов, в качестве СУБД будем использовать MySQL. В процессе установки запустится мастер настройки базы данных. Ниже приведены снимки экрана с его диалоговыми окнами:</p>

		<img src="redmine1.png" />

		<img src="redmine2.png" />

		<img src="redmine3.png" />

		<img src="redmine5.png" />

		<h2>2. Настройка uwsgi</h2>

		<p>Для запуска Redmine под управлением uwsgi создадим файл /etc/uwsgi/apps-available/redmine.ini со следующим содержимым:</p>

		<pre class="code">[uwsgi]

master = true
procname = uwsgi-redmine
procname-master = uwsgi-redmine-master
  
plugin = uwsgi_rack_ruby18
rails = /usr/share/redmine/
env = RAILS_ENV=production
env = RAILS_RELATIVE_URL_ROOT=/redmine
processes = 4
post-buffering = 1</pre>

		<p>Описание опции post-buffering, с помощью которой удалось решить проблему с неполной передачей данных между веб-сервером и uwsgi, найденное на странице <a href="http://uwsgi-docs.readthedocs.org/en/latest/ThingsToKnow.html">Things to know (best practices and “issues”) READ IT !!!</a>:</p>

		<blockquote>If an HTTP request has a body (like a POST request generated by a form), you have to read (consume) it in your application. If you do not do this, the communication socket with your webserver may be clobbered. If you are lazy you can use the post-buffering option that will automatically read data for you. For Rack applications this is automatically enabled.</blockquote>

		<p>Несмотря на то, что тут написано что эта опция автоматически включается для Rack-приложений, на практике мне пришлось включить её вручную. Возможно автоматическое включение опции было добавлено в более поздних версиях uwsgi.</p>

		<p>Переменная окружения RAILS_RELATIVE_URL_ROOT позволяет настроить Redmine для работы из подкаталога веб-сервера. Если вы запускаете Redmine на отдельном виртуальном или выделенном сервере, то эту строку указывать не нужно.</p>

		<p>Осталось включить приложение:</p>

		<pre class="console"># cd /etc/uwsgi/apps-enabled
# ln -s /etc/uwsgi/apps-available/redmine.ini .
# /etc/init.d/uwsgi start redmine</pre>

		<h2>3. Настройка веб-сервера</h2>

		<p>Для начала приведу пример файла конфигурации для настройки Redmine для работы из корня сайта:</p>

		<pre class="code">server {
  listen 80;

  server_name redmine.domain.tld;

  location / {
    alias /usr/share/redmine/public/;
    try_files $uri @redmine;
  }

  location @redmine {
    uwsgi_pass unix:/var/run/uwsgi/app/redmine/socket;
    include uwsgi_params;

    uwsgi_modifier1 7;
  }
}</pre>

		<p>Этот файл представляет собой настройки отдельного сайта, поэтому его нужно поместить в отдельный файл в каталоге для сайтов nginx. В данном случае это будет файл /etc/nginx/sites-available/redmine. Чтобы подключить его использование в nginx, нужно создать символическую ссылку:</p>

		<pre class="console"># cd /etc/nginx/sites-enabled
# ln -s /etc/nginx/sites-available/redmine .</pre>

		<p>Осталось перезагрузить или перезапустить nginx, чтобы настройки нового сайта вступили в силу:</p>

		<pre class="console"># /etc/init.d/nginx restart</pre>

		<p>Можно настроить Redmine для работы из подкаталога /redmine. Для этого нужно вписать следующие настройки в файл конфигурации уже существующего сайта:</p>

		<pre class="code">location /redmine/ {
    alias /usr/share/redmine/public/;
    try_files $uri @redmine;
  }

  location @redmine {
    uwsgi_pass unix:/var/run/uwsgi/app/redmine/socket;
    include uwsgi_params;

    uwsgi_modifier1 7;
  }</pre>

		<p>Осталось перезагрузить nginx, чтобы новые настройки вступили в силу:</p>

		<pre class="console"># /etc/init.d/nginx reload</pre>

		<h2>4. Redmine</h2>

		<p>Теперь можно зайти в Redmine:</p>

		<img src="redmine4.png" />

		<p>В системе уже создан пользователь с логином admin и таким же паролем. Не забудьте сразу же после входа поменять пароль!</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Установка Redmine в Debian Wheezy">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
