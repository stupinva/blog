<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="jessie,sip,debian,linux,asterisk" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2016-03-27 -->
		<title>Шаблоны и настройка звонков между SIP-клиентами в Asterisk</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Шаблоны и настройка звонков между SIP-клиентами в Asterisk</h1>

		<p>Как известно, чтобы съесть слона, достаточно есть его по кусочкам. Сегодня рассмотрим ещё несколько простых тем:</p>

		<ul>
			<li>использование шаблонов для описания SIP-клиентов в файле /etc/asterisk/sip.conf,</li>

			<li>настройка номерного плана /etc/asterisk/extensions.conf, для соединения абонентов друг с другом,</li>

			<li>использование в номерном плане шаблонов номеров и встроенных переменных,</li>

			<li>использование встроенных функций номерного плана и настройку тестовых номеров для проговаривания номер звонящего абонента.</li>
		</ul>

		<h2>1. Использование шаблонов</h2>

		<p>В прошлой заметке <a href="../asterisk-sip-part1/">Настройка SIP-клиента и тестовых номеров в Asterisk</a> у нас получился файл /etc/asterisk/sip.conf со следующим содержимым:</p>

		<pre class="code">[general]
allowguest=no
alwaysauthreject=yes

[1000]
call-limit=1
type=friend
context=phones
host=dynamic
secret=password
deny=0.0.0.0/0.0.0.0
permit=169.254.254.0/24</pre>

		<p>Теперь, чтобы добавить новых SIP-клиентов, можно просто скопировать секцию 1000 и отредактировать её. Если подобных клиентов будет много, то при необходимости поменять одну и ту же настройку у всех клиентов, нужно будет потратить некоторое время на правку настроек каждого клиента. Вместо этого можно создать шаблон, в котором будут указываться общие настройки для определённой группы клиентов. Шаблон потом можно назначить каждому из клиентов. Файл /etc/asterisk/sip.conf будет выглядеть следующим образом:</p>

		<pre class="code">[general]
allowguest=no
alwaysauthreject=yes

[ata](!)
call-limit=1
language=ru
type=friend
context=phones
host=dynamic
deny=0.0.0.0/0.0.0.0
permit=169.254.254.0/24

[1000](ata)
secret=password

[1001](ata)
secret=password2</pre>

		<p>Восклицательный знак в скобках указывает, что эта секция является шаблоном. Если же в скобках указан какой-то другой текст, то он интерпретируется как название шаблона, который нужно использовать как настройки по умолчанию для этой секции. Каждому клиенту можно назначать и более одного шаблона. В этом случае шаблоны перечисляются в скобках через запятую. Например, один шаблон может указывать настройки клиентов в локальной сети, а другой - настройки кодеков для определённых моделей шлюзов. Если я правильно понимаю, то шаблоны не могут быть иерархическими, а при указании нескольких шаблонов, настройки предыдущих шаблонов перекрываются настройками из последующих.</p>

		<p>Как обычно, для вступления новых настроек в силу, выполним соответствующую команду:</p>

		<pre class="console"># asterisk -rx 'sip reload'</pre>

		<h2>2. Звонки между SIP-клиентами</h2>

		<p>Для соединения абонентов между собой в Asterisk существует приложение номерного плана Dial. У этого приложения есть множество различных возможностей и настроек, но сейчас нам достаточно знать, что вызов приложения типа Dial(SIP/1000) означает соединение звонящего с SIP-абонентом с идентификатором 1000. Если у нас есть всего два тестовых абонента, то достаточно настроить в номерном плане в файле /etc/asterisk/extensions.conf всего две записи:</p>

		<pre class="code">exten =&gt; 1000,1,Dial(SIP/1000)

exten =&gt; 1001,1,Dial(SIP/1001)</pre>

		<p>После этого можно перезагрузить номерной план такой командой:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<p>Теперь с одного телефона можно позвонить на другой.</p>

		<h2>3. Шаблоны номеров и переменные</h2>

		<p>У настроек, рассмотренных в предыдущем разделе, есть один большой недостаток - при появлении нового SIP-клиента для него нужно создавать новую запись в номерном плане. Чтобы исправить этот недостаток, воспользуемся шаблонами и предопределённой переменной ${EXTEN}. Шаблоны позволяют не указывать точный номер телефона, а предопределённая переменная ${EXTEN} позволяет передать номер в приложение:</p>

		<pre class="code">exten =&gt; _1XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>Шаблоны номеров начинаются с символа подчёркивания. Далее следуют цифры или подстановочные символы:</p>

		<ul>
			<li>[15-7] - одна из цифр: 1, 5, 6 или 7,</li>

			<li>X - одна цифра от 0 до 9. Является более короткой записью для [0-9],</li>

			<li>Z - одна цифра от 1 до 9. Является более короткой записью для [1-9],</li>

			<li>N - одна цифра от 2 до 9. Является более короткой записью для [2-9],</li>

			<li>. - одно или более соответствий предыдущему подстановочному символу. Например, шаблон _N. будет совпадать с любым количеством цифр от 2 до 9,</li>

			<li>! - ноль и более соответствий предыдущему подстановочному символу. Например, шаблон _1N! будет соответствовать номеру 1 и любым номерам, начинающимися с единицы и продолжающимися цифрами от 2 до 9.</li>
		</ul>

		<p>Переменная ${EXTEN} содержит в себе набранный номер. Из этого номера можно вырезать произвольные фрагменты. Например, ${EXTEN:1} вернёт все цифры, кроме первой. ${EXTEN:1:2} вернёт две цифры после первой.</p>

		<p>Ещё одна важная деталь номерного плана состоит в том, что Asterisk стремится найти наиболее точно заданный шаблон. Например, если задать в номерном плане два шаблона:</p>

		<pre class="code">exten =&gt; _XXXX,1,Playback(tt-monkeyintro)

exten =&gt; _1XXX,1,Dial(SIP/${EXTEN})</pre>

		<p>То первое соответствие будет срабатывать только для тех номеров, которые не начинаются с 1. То есть Asterisk не обращает внимания на порядок перечисления шаблонов и выбирает для номеров, начинающихся с 1 второе правило, хотя первое для таких номеров тоже подходит.</p>

		<p>Итак, осталось перезагрузить номерной план и проверить прохождение звонков с одного номера на другой:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<h2>4. Функции и ещё несколько тестовых номеров</h2>

		<p>Кроме переменных, таких как ${EXTEN}, в Asterisk существуют ещё и функции. Функции вызываются похожим образом, но могут принимать аргументы. Одной из таких функций является функция ${CALLERID()}. Она возвращает информацию о звонящем абоненте. Если указать ей аргумент num, то она вернёт номер звонящего абонента.</p>

		<p>Кроме того, в Asterisk существуют приложения SayDigits() и SayNumber(). Первое произносит цифры, переданные ему в аргументе. Второе умеет произносить целые числа от 0 до 99999999 (8 цифр, числа до 100 миллионов), переданные ему в аргументе.</p>

		<p>Воспользуемся функцией ${CALLERID()} и приложениями SayDigits() и SayNumber() для создания в номерном плане в /etc/asterisk/extensions.conf ещё двух тестовых номеров, с помощью которых можно узнать номер телефона, с которого вы позвонили на соответствующий тестовый номер:</p>

		<pre class="code">exten =&gt; 502,1,SayDigits(${CALLERID(num)})

exten =&gt; 503,1,SayNumber(${CALLERID(num)})</pre>

		<p>Первое приложение кажется не столь полезным, однако оно, в отличие от второго, позволяет точно воспроизводить номера телефонов, начинающихся с одного и более нулей. В этом случае второй тестовый номер опустит старшие нули и воспроизведёт только число, в то время как первый позволит узнать точное количество нулей в начале номера.</p>

		<p>Можно совместить оба приложения в пределах одного тестового номера, так чтобы сначала проговаривался номер, а потом, после небольшой паузы, цифры номера. Заодно воспользуемся сокращением same, которое можно использовать, чтобы не повторять номер в каждой строчке номерного плана:</p>

		<pre class="code">exten =&gt; 504,1,SayNumber(${CALLERID(num)})
same  =&gt;     n,Wait(1)
same  =&gt;     n,SayDigits(${CALLERID(num)})</pre>

		<p>Как обычно, теперь нужно перезагрузить номерной план:</p>

		<pre class="console"># asterisk -rx 'dialplan reload'</pre>

		<p>Эти тестовые номера могут оказаться полезными новым сотрудникам, сотрудникам, временно севшими за чужое рабочее место, и техническому персоналу для диагностики проблем телефонии.</p>

		<h2>5. Полезные ссылки:</h2>

		<ul>
			<li><a href="http://asterisk.ru/knowledgebase/Asterisk+cmd+Dial">База знаний. Команда Dial()</a></li>

			<li><a href="http://asterisk.ru/knowledgebase/Asterisk+func+callerid">База знаний. Функция CALLERID()</a></li>

			<li><a href="http://asterisk.ru/knowledgebase/Asterisk+cmd+SayDigits">База знаний. Команда SayDigits()</a></li>

			<li><a href="http://asterisk.ru/knowledgebase/Asterisk+cmd+SayNumber">База знаний. Команда SayNumber()</a></li>
		</ul>

		<p><a href="mailto:vladimir@stupin.su?subject=Шаблоны и настройка звонков между SIP-клиентами в Asterisk">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
