<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="перевод,ssl,Реми ван Элст,openssl" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2016-11-20 -->
		<title>Реми ван Элст. Шифрование и расшифровывание файлов публичными ключами с помощью OpenSSL из командной строки, 2015</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Реми ван Элст. Шифрование и расшифровывание файлов публичными ключами с помощью OpenSSL из командной строки, 2015</h1>

		<p>Перевод статьи: <a href="https://raymii.org/s/tutorials/Encrypt_and_decrypt_files_to_public_keys_via_the_OpenSSL_Command_Line.html">Encrypt and decrypt files to public keys via the OpenSSL Command Line</a></p>

		<p>Автор: Реми ван Элст (Remy van Elst)</p>

		<p>Этот небольшой рецепт показывает, как использовать openssl из командной строки для шифрования файла публичным ключом и расшифровывания файла. Сначала мы создадим случайный ключ, зашифруем этот случайный ключ публичным ключом другого человека и с помощью этого случайного ключа зашифруем сам файл, используя симметричное шифрование.</p>

		<p>Из-за особенностей алгоритма RSA, с его помощью невозможно шифровать большие файлы. Если создать ключ из <b>n</b> бит, то шифруемый файл не должен быть больше чем (<b>n</b> минус 11) бит. Наиболее эффективное использование RSA - шифрование случайного пароля, с последующим шифрованием файла паролем с помощью алгоритма симметричного шифрования. Если файл больше, чем размер ключа, то команда шифрования завершится ошибкой:</p>

		<pre class="console">RSA operation error: 020:error:0406D06E:rsa routines:RSA_padding_add_PKCS1_type_2:data too large for key size:.\crypto\rsa\rsa_pk1.c:151:</pre>

		<p>Создадим случайный файл и используем его в качестве ключа для шифрования большого файла алгоритмом симметричного шифрования. Этот случайный файл выполнит роль пароля, который мы сообщим. Большой файл зашифруем маленьким файлом, выступающим в роли пароля. Затем отправим зашифрованный файл и зашифрованный ключ получателю, а он сможет расшифровать ключ своим приватным ключом и использовать этот ключ для расшифровывания большого файла.</p>

		<p>Для работы с ключами RSA используются следующие команды:</p>

		<ul>
			<li><b>openssl genrsa</b>: Создание приватных ключей RSA.</li>

			<li><b>openssl rsa</b>: Управление приватными ключами RSA (включая создание публичного ключа из приватного).</li>

			<li><b>openssl rsautl</b>: Шифрование и расшифровывание файлов ключами RSA.</li>
		</ul>

		<p>Ключ - это просто строка случайных байтов. Воспользуемся строкой из 128 байтов, из которых в результате кодирования base64 получится 175 символов. Поскольку 175 символов - это 1400 бит, ключ получится достаточно маленьким, чтобы можно было зашифровать его при помощи RSA.</p>

		<h2>1. Получение публичного ключа</h2>

		<p>Попросите получателя отправить вам его сертификат или публичный ключ. Если он отправил сертификат, можно извлечь из него публичный ключ с помощью следующей команды:</p>

		<pre class="console">openssl rsa -in certificate.pem -out publickey.pem -outform PEM -pubout</pre>

		<h2>2. Создание случайного файла пароля</h2>

		<p>Воспользуемся следующей командой, чтобы создать случайный ключ:</p>

		<pre class="console">openssl rand -base64 128 -out key.bin</pre>

		<p>Делайте это при каждом шифровании файла. Каждый раз используйте новый ключ!</p>

		<h2>3. Шифрование файла случайным ключом</h2>

		<p>Воспользуемся следующей командой, чтобы зашифровать большой файл случайным ключом:</p>

		<pre class="console">openssl enc -aes-256-cbc -salt -in largefile.pdf -out largefile.pdf.enc -pass file:./bin.key</pre>

		<p>Размер файла вырастет ненамного:</p>

		<pre class="console">$ ls -larth
-rw-r--r-- 1 user group 40M Nov 9 21:14 Linux-Voice-Issue-020.pdf
-rw-r--r-- 1 user group 40M Nov 9 22:03 Linux-Voice-Issue-020.pdf.enc</pre>

		<p>Однако, он зашифрован:</p>

		<pre class="console">$ file Linux-Voice-Issue-020.pdf
Linux-Voice-Issue-020.pdf: PDF document, version 1.4

$ file Linux-Voice-Issue-020.pdf.enc
Linux-Voice-Issue-020.pdf.enc: data</pre>

		<h2>4. Шифрование случайного ключа файлом публичного ключа</h2>

		<p>Воспользуемся следующей командой для шифрования файла случайного ключа публичным ключом получателя:</p>

		<pre class="console">openssl rsautl -encrypt -inkey publickey.pem -pubin -in key.bin -out key.bin.enc</pre>

		<p>Теперь можно без опаски отправить получателю <b>key.bin.enc</b> и <b>largefile.pdf.enc</b>.</p>

		<p>Полезно также <a href="../openssl-signing-validation/">подписать оба файла своим публичным ключом</a>.</p>

		<h2>5. Расшифровывание случайного ключа при помощи файла своего приватного ключа</h2>

		<p>Если нужно расшифровать файл, зашифрованный описанным способом, воспользуйтесь следующей командой, указав ей свой приватный ключ (соответствующий публичному ключу, которым был зашифрован случайный ключ) для расшифровывания случайного ключа:</p>

		<pre class="console">openssl rsautl -decrypt -inkey privatekey.pem -in key.bin.enc -out key.bin</pre>

		<p>В результате получим расшифрованный случайный ключ, которым зашифрован полученный файл.</p>

		<h2>6. Расшифровывание большого файла случайным ключом</h2>

		<p>Как только был получен случайный ключ, можно расшифровать расшифрованным ключом зашифрованный файл:</p>

		<pre class="console">openssl enc -d -aes-256-cbc -in largefile.pdf.enc -out largefile.pdf -pass file:./bin.key</pre>

		<p>В результате получим расшифрованный большой файл.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Реми ван Элст. Шифрование и расшифровывание файлов публичными ключами с помощью OpenSSL из командной строки, 2015">Написать автору перевода</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
