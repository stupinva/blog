<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="zswap,jessie,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2017-06-11 -->
		<title>Настройка zswap в Debian</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Настройка zswap в Debian</h1>

		<p>Современные браузеры увеличивают свои требования к объёму оперативной памяти темпами, за которыми сложно поспевать. Я лично не часто меняю компьютер, да и добавить в систему ещё немного модулей оперативной памяти иногда оказывается не самым дешёвым решением, особенно если на материнской плате уже заняты все слоты, а устаревшие модули памяти в магазинах продаются по цене выше, чем модули памяти для новых компьютеров.</p>

		<p>Одним из возможных выходов из этой непростой ситуации может быть использование модуля ядра zswap, который перед выгрузкой страниц в раздел подкачки сначала старается сжать их и оставить в оперативной памяти. Внешне этот эффект проявляется так, что оперативной памяти как будто стало больше и выгрузка страниц в раздел подкачки осуществляется гораздо реже.</p>

		<p>Для сжатия страниц памяти воспользуемся новым алгоритмом сжатия LZ4, который обладает более высокой производительностью по сравнению с предлагаемым по умолчанию алгоритмом сжатия LZO. Несмотря на то, что LZ4 сжимает чуть хуже, он меньше грузит процессор. Таким образом соблюдается более приемлемый баланс между экономией памяти и нагрузкой на процессор.</p>

		<h2>1. Модули ядра для поддержки LZ4</h2>

		<p>Для начала впишем в файл /etc/initramfs-tools/modules модули ядра, реализующие быстрый алгоритм сжатия LZ:</p>

		<pre class="code">lz4
lz4_compress</pre>

		<p>И пересоберём образ загрузочной файловой системы, чтобы в него попали добавленные нами модули:</p>

		<pre class="console"># update-initramfs -u -k all</pre>

		<h2>2. Модуль ядра для сжатия страниц подкачки</h2>

		<p>Теперь прописываем автоматическое включение zswap при загрузке ядра в конфигурации загрузчика GRUB в файле /etc/default/grub. Для этого добавим ряд новых настроек в GRUB_CMDLINE_LINUX_DEFAULT:</p>

		<pre class="code">zswap.enabled=1 zswap.compressor=lz4 zswap.max_pool_percent=80</pre>

		<p>Значение настроек:</p>

		<ul>
			<li>zswap.enabled=1 - включает использование zswap,</li>

			<li>zswap.compressor=lz4 - выбирает более быстрый алгоритм сжатия lz4 вместо алгоритма сжатия по умолчанию lzo,</li>

			<li>zswap.max_pool_percent=80 - разрешает использовать до 80 процентов оперативной памяти для хранения сжатых данных.</li>
		</ul>

		<p>После изменения конфигурации загрузчика обновим его автоматически генерируемые файлы с настройками:</p>

		<pre class="console"># update-grub</pre>

		<p>Всё готово, теперь нужно перезагрузить систему. Очень редкое действие, но этом случае перезагрузка действительно необходимо, т.к. загрузить модули без перезагрузки мне лично не удалось:</p>

		<pre class="console"># reboot</pre>

		<h2>3. Проверка</h2>

		<p>После перезагрузки можно проверить, работает ли модуль и какой алгоритм сжатия используется:</p>

		<pre class="console">$ dmesg | grep zswap:
[    0.830940] zswap: loading zswap
[    0.835122] zswap: using lz4 compressor</pre>

		<h2>4. Использованные материалы</h2>

		<ul>
			<li><a href="http://www.pivpav.ru/post/150">ZSWAP или делаем Linux быстрым</a></li>

			<li><a href="http://www.pivpav.ru/post/154">ZSWAP with LZ4</a></li>

			<li><a href="https://wiki.archlinux.org/index.php/Zswap">Zswap</a></li>
		</ul>

		<p><a href="mailto:vladimir@stupin.su?subject=Настройка zswap в Debian">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
