<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="buster,stretch,zabbix,debian,linux,3.4" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2019-11-10 -->
		<title>Контроль работоспособности DHCP-сервера в Zabbix</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Контроль работоспособности DHCP-сервера в Zabbix</h1>

		<p>Как-то раз на работе потребовалось поставить на контроль DHCP-сервер. Сделать это нужно было, как обычно, срочно. Пока я делал, заказчики постоянно "держали руку на пульсе", интересовались результатами и поторапливали. Пытался воспользоваться различными утилитами командной строки, но в итоге наиболее пригодным вариантом оказалось написание собственного скрипта на python с использованием библиотеки ScaPy, благо в интернете можно найти примеры подобных скриптов. Собирались испытать скрипт на одном DHCP-сервере, а потом поставить на контроль ещё несколько десятков.</p>

		<p>Года через два наткнулся на этот забытый скрипт. Раз уж он никому не нужен, то можно попытаться довести его до ума и поделиться им. Забрал скрипт домой и стал экспериментировать на виртуалках. Пока доводил скрипт до ума, на работе снова возникла необходимость поставить на контроль один DHCP-сервер, никак не связанный с теми, для которых скрипт первоначально писался.</p>

		<h2>1. Принципы работы DHCP</h2>

		<p>Для начала ознакомимся немого с принципами работы DHCP.</p>

		<p>Выдача настроек по DHCP происходит в следующей последовательности:</p>

		<ol>
			<li>клиент, желающий получить настройки, посылает широковещательный запрос DHCPDISCOVERY, при помощи которого пытается обнаружить доступные DHCP-серверы,</li>

			<li>сервер откликается на запрос DHCPDISCOVERY и отвечает пакетом DHCPOFFER, в котором предлагает клиенту использовать определённый IP-адрес,</li>

			<li>клиент отправляет серверу запрос DHCPREQUEST, в котором просит закрепить за ним указанный IP-адрес,</li>

			<li>сервер отвечает клиенту пакетом DHCPACK, в котором подтверждает, что IP-адрес закреплён за клиентом. Если сервер по каким-то причинам не может закрепить за клиентом указанный им IP-адрес, то отвечает пакетом DHCPNAK.</li>
		</ol>

		<p>Для продления аренды ранее выданного сервером IP-адреса клиент использует запросы DHCPREQUEST, указывая в запросе ранее выданный ему IP-адрес.</p>

		<p>Также протоколом предусмотрены пакеты DHCPDECLINE и DHCPINFO.</p>

		<p>При помощи DHCPDECLINE клиент может сообщить серверу, что предложенный им IP-адрес уже используется.</p>

		<p>Если клиенту не нужен IP-адрес от DHCP-сервера, то вместо запроса DHCPREQUEST клиент может отправить запрос DHCPINFORM для запроса дополнительных сетевых параметров. Так же как и в ответ на запрос DHCPREQUEST, на запрос DHCPINFORM сервер отвечает пакетом DHCPACK.</p>

		<p>Если клиент хочет вернуть IP-адрес DHCP-серверу, он может отправить серверу запрос DHCPRELEASE. Если сервер получит такой запрос, он помечает IP-адрес как свободный. Протоколом не предусмотрен ответ на запросы DHCPRELEASE, поэтому невозможно убедиться в том, что сервер получил и обработал запрос.</p>

		<h2>2. Описание скрипта dhcp.py</h2>

		<p>А теперь перейдём к делу. Для контроля работоспособности DHCP-сервера был подготовлен скрипт <a href="dhcp.py">dhcp.py</a>, принимающий следующие аргументы:</p>

		<ul>
			<li>имя сетевого интерфейса, за которым находится контролируемый DHCP-сервер,</li>

			<li>MAC-адрес клиента, который будет использоваться в запросах к DHCP-серверу. По умолчанию - MAC-адрес сетевого интерфейса,</li>

			<li>IP-адрес, который ожидается получить от DHCP-сервера. По умолчанию клиент будет принимать любой IP-адрес,</li>

			<li>IP-адреса DHCP-серверов, ответ от которых ожидается получить. Если на пути между клиентом и DHCP-сервером имеются DHCP-релеи, то тут нужно указывать настоящие IP-адреса серверов, а не IP-адреса релеев. Можно указать несколько IP-адресов, разделив их двоеточиями. По умолчанию принимаются ответы от любых DHCP-серверов,</li>

			<li>время ожидания ответа, по умолчанию составляет 2 секунды.</li>
		</ul>

		<p>Обязательно для указания только имя интерфейса. Все остальные настройки не обязательны и могут быть опущены.</p>

		<p>Алгоритм работы скрипта следующий:</p>

		<ul>
			<li>через указанный интерфейс отправляется запрос DHCPDISCOVERY с указанным MAC-адресом или MAC-адресом интерфейса,</li>

			<li>в течение таймаута принимаются пакеты DHCPOFFER,</li>

			<li>если пакетов DHCPOFFER не поступило, выполнение скрипта прерывается,</li>

			<li>если указан ожидаемый IP-адрес, то проверяется, что в DHCPOFFER предложен именно этот IP-адрес. Если DHCP-сервер предложил другой IP-адрес, то выполнение скрипта прерывается,</li>

			<li>если указан список IP-адресов DHCP-серверов, то проверяется, что в DHCPOFFER указан IP-адрес одного из ожидаемых DHCP-серверов. Если получен ответ от другого DHCP-сервера, то выполнение скрипта прерывается,</li>

			<li>отправляется запрос DHCPREQUEST с просьбой выдать в аренду предложенный IP-адрес,</li>

			<li>в течение таймаута принимаются пакеты DHCPACK,</li>

			<li>если пакетов DHCPACK не поступило, выполнение скрипта прерывается,</li>

			<li>отправляется запрос DHCPRELEASE на возврат арендованного IP-адреса.</li>
		</ul>

		<p>Коды ошибок скрипта, которые он выдаёт на стандартный вывод:</p>

		<ol>
			<li>указанный сетевой интерфейс не существует,</li>

			<li>неправильный MAC-адрес,</li>

			<li>нет ответа DHCPOFFER,</li>

			<li>неправильный пакет DHCPOFFER,</li>

			<li>получен ответ от нежелательного DHCP-сервера,</li>

			<li>предложен нежелательный IP-адрес,</li>

			<li>нет ответа DHCPACK,</li>

			<li>неправильный пакет DHCPACK.</li>
		</ol>

		<p>Для работы скрипту необходимы привилегии пользователя root, но Zabbix работает под простым пользователем, поэтому придётся воспользоваться sudo. Если использовать скрипт dhcp.py как скрипт внешнего опроса, то для его запуска через sudo потребуется создать ещё один скрипт. Но такое решение не кажется мне красивым. Я решил вызывать скрипт dhcp.py через Zabbix-агента, для чего понадобится настроить в конфигурации агента UserParameter, где найдётся место и для sudo.</p>

		<h2>3. Настройка Zabbix-агента</h2>

		<p>Сначала установим пакет sudo, если он ещё не установлен:</p>

		<pre class="console"># apt-get install sudo</pre>

		<p>И выдадим пользователю zabbix, от имени которого работает Zabbix-агент, права запускать скрипт dhcp.py с правами пользователя root:</p>

		<pre class="code">Defaults:zabbix !requiretty
zabbix ALL=(ALL) NOPASSWD:/etc/zabbix/dhcp.py *</pre>

		<p>Теперь положим скрипт <a href="dhcp.py">dhcp.py</a> в каталог /etc/zabbix и выдадим права запускать его:</p>

		<pre class="console"># chmod +x /etc/zabbix/dhcp.py</pre>

		<p>В конфигурации Zabbix-агента в файле /etc/zabbix/zabbix_agentd.conf добавим строчку:</p>

		<pre class="code">UserParameter=dhcp[*],/usr/bin/sudo /etc/zabbix/dhcp.py "$1" "$2" "$3" "$4" "$5"</pre>

		<p>После изменения конфигурации Zabbix-агента, его нужно перезапустить:</p>

		<pre class="console"># systemctl restart zabbix-agent</pre>

		<h2>4. Шаблоны для Zabbix</h2>

		<p>Для того, чтобы в последних данных можно было наглядно видеть результат последней проверки, я подготовил файл для преобразования значений <a href="Valuemap_DHCP.xml">Valuemap_DHCP.xml</a>. В файле созданы следующие преобразования значений:</p>

		<img src="dhcp_valuemap.png" />

		<p>Также я подготовил два варианта шаблона:</p>

		<ul>
			<li><a href="Template_App_DHCP.xml">Template_App_DHCP.xml</a> - шаблон для использования с Zabbix-агентом, работающим в обычном, пассивном режиме,</li>

			<li><a href="Template_App_DHCP_Active.xml">Template_App_DHCP_Active.xml</a> - шаблон для использования с Zabbix-агентом, работающим в активном режиме.</li>
		</ul>

		<p>В шаблоне имеются макросы, при помощи которых можно настроить элемент данных, который контролирует состояние DHCP-сервера. Указано только одно значение по умолчанию для имени интерфейса - eth0, т.к. этот аргумент обязателен для указания.</p>

		<img src="dhcp_macro.png" />

		<p>В шаблоне есть только один элемент данных, который использует макросы из шаблона в качестве своих аргументов по умолчанию:</p>

		<img src="dhcp_items.png" />

		<p>К этому элементу данных присоединено 8 триггеров, два из которых имеют высокую важность, т.к. свидетельствуют о неработоспособности DHCP-сервера или о появлении чужого DHCP-сервера. Остальные триггеры имеют уровень важности "Предупреждение":</p>

		<img src="dhcp_triggers.png" />

		<h2>5. Пример использования</h2>

		<p>Для примера я настроил контроль исправности DHCP-сервера на своём домашнем компьютере. В виртуальную машину с Zabbix проброшен интерфейс ens7, смотрящий в локальную сеть с DHCP-сервером. На интерфейсе отсутствуют сетевые настройки, используется он только для контроля исправности DHCP-сервера. На уровне сетевого узла созданы макросы, переопределяющие значения по умолчанию, определённые в шаблоне:</p>

		<img src="dhcp_hostmacro.png" />

		<p>В последних данных можно увидеть числовое значение результата проверки DHCP-сервера и короткий текст, позволяющий быстро понять, какой именно результат получен:</p>

		<img src="dhcp_lastvalues.png" />

		<h2>6. Использованные материалы</h2>

		<ul>
			<li><a href="http://nets4geeks.blogspot.com/2013/11/scapy-dhcp.html">Практика Scapy: активная диагностика приложений протокола DHCP</a></li>

			<li><a href="https://stackoverflow.com/questions/22720788/dhcp-release-using-scapy/22723643">DHCP release using scapy</a></li>
		</ul>

		<p><a href="mailto:vladimir@stupin.su?subject=Контроль работоспособности DHCP-сервера в Zabbix">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
