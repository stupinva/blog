<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="postgrey,postfix,перевод,linux,debian" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2009-09-17 -->
		<title>chantra. Postfix и Postgrey: Проактивный способ фильтрации спама, 2006</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>chantra. Postfix и Postgrey: Проактивный способ фильтрации спама, 2006</h1>

		<p>Перевод статьи: <a href="http://www.debuntu.org/postfix-and-postgrey-a-proactive-approach-to-spam-filtering">Postfix and Postgrey: A proactive approach to spam filtering</a></p>

		<p>Серый список - это ещё один способ избежать переполнения вашего почтового ящика спамом. Известная программа для борьбы со спамом - это <a href="http://www.debuntu.org/postfix-and-pamassassin-how-to-filter-spam">spamassassin</a>, который фильтрует письма. Серый список не пытается заменить такие программы, он работает как мощный проактивный барьер, который уменьшает общее количество спама, получаемое вашим почтовым сервером.</p>

		<h2>1. Введение</h2>

		<p>Серый список - это хороший способ борьбы со спамом, основная идея которого состоит в том, что почтовые серверы спамеров не соответствуют спецификации стандартов RFC. Главная мысль состоит в том, что почтовый сервер должен пытаться доставить письмо позже, если его не удалось доставить сразу. Отправляя одновременно много писем, спамеры не могут тратить так много ресурсов на повторную отправку писем, если письма не могут быть доставлены сразу. Поэтому если письмо не может быть доставлено с первого раза, они не пытаются отправить его снова.</p>

		<p>Основываясь на этой идее, серый список просто отклоняет любое письмо из недоверенного домена, выдавая код ответа 450, который означает "Я не могу ответить на ваш запрос прямо сейчас, пожалуйста, попробуйте позже".</p>

		<p>Поскольку почтовый сервер спамера обычно не соответствует RFC, он не будет повторять попытки и поэтому вы не получите спам.</p>

		<h2>2. Postgrey</h2>

		<h3>2.1. Введение</h3>

		<p><a href="http://isg.ee.ethz.ch/tools/postgrey/">Postgrey</a> - это <a href="http://www.postfix.org/SMTPD_POLICY_README.html">сервер политики postfix</a>, реализующий серый список.</p>

		<p>Он действительно легко интегрируется в postfix и действительно эффективен.</p>

		<p>Postgrey хранит записи-триплеты: IP_КЛИЕНТА / ОТПРАВИТЕЛЬ / АДРЕСАТ. Если этот триплет появился впервые или он впервые появился менее 5 минут назад, запись помещается в серый список, а письмо отбрасывается с сообщением о временной ошибке. Если тот же триплет появится через 5 минут и до истечения 35 дней, то письмо будет принято.</p>

		<p><i>Отметим, что 5 минут и 35 дней - это значения по умолчанию. Позже я объясню, как их можно поменять.</i></p>

		<h3>2.2. Установка</h3>

		<p>Для Postgrey существуют готовые пакеты в основной поставке Debian/Ubuntu, их очень легко установить. Вам просто нужно запустить:</p>

		<pre class="console">$ sudo apt-get install postgrey</pre>

		<p>На системах подобных Debian, postgrey работает "из коробки". По умолчанию он привязывается к интерфейсу локальной петли (127.0.0.1) на порт 60000. Поэтому, служба postgrey не доступна снаружи.</p>

		<p>Теперь, нам нужно сообщить postfix, что он должен использовать сервер политики postgrey.</p>

		<h2>3. Настройка postfix</h2>

		<p>Как было сказано ранее, интегрировать postgrey в postfix действительно просто (вам потребуется postfix версии 2.1 или выше). Все необходимые настройки вносятся в /etc/postfix/main.cf. Откройте /etc/postfix/main.cf и добавьте check_policy_service inet:127.0.0.1:60000 в конец smtpd_recipient_restrictions. У вас должно получиться что-то вроде этого:</p>

		<pre class="code">smtpd_recipient_restrictions = permit_mynetworks,
  permit_sasl_authenticated,
  reject_unauth_destination,
  check_policy_service inet:127.0.0.1:60000</pre>

		<p>Отметим, что ваши настройки могут быть другими.</p>

		<p>Перезагрузим postfix:</p>

		<pre class="console">$ sudo /etc/init.d/postfix reload</pre>

		<p>и как только вы это сделаете, вы получите работающую политику серого списка и почтовый сервер postfix начнёт временно отклонять поступающие письма. Вы увидите:</p>

		<pre class="code">Nov 23 21:42:10 mymailserver postfix/smtpd[4256]: NOQUEUE: reject: RCPT from 
spammerrelay.com[xxx.xxx.xxx.xxx]: 450 &lt;recipient@spammed.com&gt;: Recipient
address rejected: Greylisted for 300 seconds (see http://isg.ee.ethz.ch/tools
/postgrey/help/spammed.com.html); from=&lt;sender@spammer.com&gt;
to=&lt;recipient@spammed.com&gt; proto=ESMTP helo=&lt;spammerrelay.com&gt;</pre>

		<p>Начиная с этого момента общее количество спама, достигшее вашего почтового ящика кардинально уменьшится.</p>

		<p>Теперь, тем кто хочет подстроить postgrey, настало время заглянуть в него немного глубже.</p>

		<h2>4. Подстройка Postgrey</h2>

		<h3>4.1. Файлы настройки Postgrey</h3>

		<p>Есть два главных файла в каталоге /etc/postgrey: whitelist_clients и whitelist_recipients.</p>

		<p>В файле whitelist_clients (белый список клиентов), вы можете определить список почтовых серверов, которые вы не хотите подвергать фильтрации по серому списку. Например потому, что вы доверяете этим узлам, или потому что это узел, который имеет проблемы с серым списком.</p>

		<p>Адреса клиентов должны быть указаны одним из следующих способов:</p>

		<ul>
			<li>domain.addr : полностью определённое доменное имя</li>

			<li>WWW.XXX.YYY.ZZZ : IP-адрес</li>

			<li>/regex/ : регулярное выражение</li>
		</ul>

		<p>В файле whitelist_recipients (белый список адресатов), вы можете указать список адресатов, на которых не распространяется действие серого списка.</p>

		<p>Адреса получателей можно указать одним из следующих способов:</p>

		<ul>
			<li>domain.addr : полностью определённое доменное имя</li>

			<li>имя@ : каждое "имя" пользователя для любого домена будет обрабатываться как расширенный адрес, например имя+нечто@.*</li>

			<li>name@domain : письма для name@domain как расширенный адрес</li>

			<li>/regex/ : регулярное выражение</li>
		</ul>

		<h3>4.2. Опции демона postgrey</h3>

		<p>Ранее я упомянул о том, что postgrey подвергает письмо фильтрации по серому списку на 5 минут, если его триплет IP_КЛИЕНТА / ОТПРАВИТЕЛЬ / ПОЛУЧАТЕЛЬ встретился первый раз или если последний раз триплет встречался больше, чем 35 дней назад.</p>

		<p>Так вот, эти настройки могут быть изменены при запуске демона postgrey. На системах подобных Debian, эти настройки находятся в /etc/default/postgrey.</p>

		<p>По умолчанию этот файл содержит:</p>

		<pre class="code">POSTGREY_OPTS="--inet=127.0.0.1:60000"</pre>

		<p>Теперь представим, что вы хотите блокировать письма по серому списку на 2 минуты, и позволить известному триплету проходить через серый список, если он удачно преодолел политику серого списка менее чем 20 дней назад. Тогда вам нужно воспользоваться следующими настройками:</p>

		<pre class="code">POSTGREY_OPTS="--inet=127.0.0.1:60000 --delay=120 --max-age=20"</pre>

		<p>Также, postgrey предлагает приятную возможность, которая позволяет помещать в белый список те триплеты, для которых более 5 раз (значение по умолчанию) были успешно приняты письма после прохождения политики серого списка и если клиент последний раз встретился до истечения срока --max-age.</p>

		<p>Значение по умолчанию можно изменить с помощью опции --auto-whitelist-clients. Установив его в 0, вы отключите эту возможность.</p>

		<p>Если вы захотите заменить это значение указанными выше, измените файл /etc/default/postgrey и укажите в опции --auto-whitelist-clients необходимое значение, например:</p>

		<pre class="code">POSTGREY_OPTS="--inet=127.0.0.1:60000 --delay=120 --max-age=20 --auto-whitelist-clients=10"</pre>

		<h2>5. Получение отчётов от postgrey</h2>

		<p>Postgrey отправляет статистику с помощью утилиты postgreyreport. С помощью postgreyreport вы сможете получить отчёт о триплетах, которые не прошли серый список (означает, что разница между первым и последним разом, когда они встретились, меньше --delay=N и поэтому они могут быть спамом).</p>

		<p>Для получения отчёта вы можете воспользоваться следующей командной строкой:</p>

		<pre class="console"># cat /var/log/mail.log | postgreyreport \
  --nosingle_line --check_sender=mx,a --show_tries \
  --separate_by_subnet=":===============================================================================================\n"</pre>

		<p>Она выведет нечто вроде следующего:</p>

		<pre class="code">:===============================================================================================
unknown XXX.XXX.XXX.XXX
1 spammer1@spammer1.com user1@host1.com
1 spammer2@spammer2.com user2@host2.com
1 spammer3@spammer3.com user3@host3.com
:===============================================================================================
unknown YYY.YYY.YYY.YYY
1 spammer4@spammer4.com user4@domain1.com
:===============================================================================================
unknown ZZZ.ZZZ.ZZZ.ZZZ
1 spammer5@spammer5.com user1@host1.com
1 spammer6@spammer6.com user1@host1.com
1 spammer7@spammer7.com user2@host2.com
:===============================================================================================</pre>

		<h2>6. Заключение</h2>

		<p>Postgrey действительно просто установить и вы получаете очень эффективно работающую систему сразу после её включения. Обратной стороной медали является то, что первое письмо от конкретного отправителя дойдёт с задержкой по меньшей мере на 5 минут (или на значение, указанное вами в настройках --delay).</p>

		<p>Если это является для вас проблемой, вы вольны добавить в белый список /etc/postgrey/whitelist_clients доверенные домены отправителей.</p>

		<p>Но в любом случае, даже если вы готовы ждать 5 минут, люди, с которыми вы часто обмениваетесь письмами, скоро попадут в автоматически наполняемый белый список и вы больше не будете терпеть задержки.</p>


		<p><a href="mailto:vladimir@stupin.su?subject=chantra. Postfix и Postgrey: Проактивный способ фильтрации спама, 2006">Написать автору перевода</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
