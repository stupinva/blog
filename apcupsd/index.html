<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="jessie,zabbix,apcupsd,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2015-09-20 -->
		<title>apcupsd и APC Smart-UPS 1500VA</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>apcupsd и APC Smart-UPS 1500VA</h1>

		<p>В прошлом я уже подключал ИБП к компьютеру и воспользовался тогда для контроля за состоянием ИБП системой NUT, о чём и написал в заметке <a href="../nut-eaton/">NUT и Eaton Powerware 5110</a>. В этот раз мне понадобилось подключить к компьютеру ИБП APC Smart-UPS 1500VA. Попробовал по старой памяти настроить для этого NUT, но драйвер usbhid-ups, работающий с этим ИБП через интерфейс USB, при запуске завершался ошибкой сегментации памяти. При этом XFCE издевательски выводил уведомление о полной зарядке батареи в правом верхнем углу экрана, общаясь с ИБП через шину dbus и демон upowerd.</p>

		<p>Попробовал воспользоваться переходником USB-RS232 (COM-порт поддерживается драйвером apcsmart), но после подключения к компьютеру ИБП пискнул и отключился вместе со всей нагрузкой. Собственно, можно было ожидать чего-то подобного, т.к. в конфигурации драйвера apcsmart есть не один вариант кабеля RS232. Стало понятно, что переходник на USB, по всей видимости, не поможет.</p>

		<p>Я знал о существовании apcupsd, но пользоваться им не хотелось из-за его специализированности на ИБП только одного производителя. Но тут деваться стало некуда и я решил всё-таки настроить его.</p>

		<h2>1. Настройка apcupsd</h2>

		<p>Итак, перво-наперво, установим apcupsd:</p>

		<pre class="console"># apt-get install apcupsd</pre>

		<p>Открываем файл /etc/apcupsd/apcupsd.conf и редактируем, выставляя следующие настройки:</p>

		<pre class="code">UPSCABLE usb
UPSTYPE usb
DEVICE

POLLTIME 10 # По умолчанию 60

BATTERYLEVEL 0 # По умолчанию 5%
MINUTES 3
TIMEOUT 0

BEEPSTATE N # Отключаем писк ИБП</pre>

		<p>apcupsd выключает компьютер при наступлении одного из условий:</p>

		<ul>
			<li>уровень заряда батареи в процентах упал до значения меньше указанного в BATTERYLEVEL,</li>

			<li>расчётное время работы от батареи в минутах стало меньше значения, указанного в MINUTES,</li>

			<li>время непрерывной работы от батареи в минутах превысило значение, указанное в TIMEOUT.</li>
		</ul>

		<p>Если какая-либо из этих настроек имеет значение 0, она не учитывается при принятии решения о выключении компьютера.</p>

		<p>Теперь откроем файл /etc/default/apcupsd и включим демон, вписав в файл настройку:</p>

		<pre class="code">ISCONFIGURED=yes</pre>

		<p>Теперь можно включить и запустить демона через systemd:</p>

		<pre class="console"># systemctl enable apcupsd.service
# systemctl start apcupsd.service</pre>

		<p>Поскольку мы не меняли сетевые настройки, демон запустится и будет ожидать подключений на TCP-порту 3551 на локальном IP-адресе 127.0.0.1.</p>

		<p>Узнать состояние ИБП можно с помощью программы-клиента apcaccess. Можно запускать её и от имени обычного пользователя, ведь для установки сетевого подключения не нужно обладать особыми правами, но стоит учитывать, что программа лежит в каталоге /sbin, поэтому для обычного пользователя доступна только при указании полного пути:</p>

		<pre class="console">$ /sbin/apcaccess</pre>

		<p>Программа выводит различные данные ИБП в виде списка имён параметров и их значений. У программы есть опция -u, отключающая отображение единиц измерения. С помощью опции -p можно вывести значение только одного параметра, указав после опции имя параметра. Воспользуемся этим чтобы наблюдать за состоянием ИБП при помощи системы мониторинга Zabbix.</p>

		<h2>2. Настройка Zabbix</h2>

		<p>Предполагается, что на компьютере уже установлен и настроен Zabbix-агент. Добавим в конфигурацию агента "пользовательский параметр". Сделать этом можно либо напрямую отредактировав файл /etc/zabbix/zabbix_agentd.conf, либо создав новый файл в каталоге /etc/zabbix/zabbix_agentd.d/ специально для этого пользовательского параметра. Впишем строчку:</p>

		<pre class="code">UserParameter=ups[*],/sbin/apcaccess -u -p $1</pre>

		<p>Перезапустим Zabbix-агента, чтобы новые настройки вступили в силу:</p>

		<pre class="console"># systemctl restart zabbix-agent.service</pre>

		<p>Я подготовил два варианта шаблонов - <a href="Template_App_APC_Smart_UPS_1500VA_apcupsd.xml">один</a> с элементами данных "Zabbix-агент", а <a href="Template_App_APC_Smart_UPS_1500VA_apcupsd_active.xml">второй</a> - с элементами данных "Zabbix-агент (активный)".</p>

		<p>Фрагмент страницы истории:</p>

		<img src="zabbix_apc_history.png" />

		<p>Фрагмент шаблона со списком триггеров:</p>

		<img src="zabbix_apc_triggers.png" />

		<p>Состав триггеров и приоритеты соответствуют моим нуждам, вы можете настроить их по-другому.</p>

		<p>В ИБП предусмотрен режим "байпас" (более привычное название - шунт), то есть режим передачи напряжения со входа на выход напрямую. Если с напряжением в розетке всё в порядке, то ИБП работает именно в этом режиме, выполняя лишь функцию сетевого фильтра. При выходе напряжения за установленные пределы включается режим стабилизации. Если напряжение пропадает полностью, то ИБП начинает работать от батареи. Работа от батареи сопровождается довольно заметным шумом вентиляторов, с чем можно смириться, т.к. эта ситуация является аварийной, а в нормальном режиме "байпас" вентиляторы не работают.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=apcupsd и APC Smart-UPS 1500VA">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
