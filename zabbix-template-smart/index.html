<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="zabbix,smart,debian,linux" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2017-05-21 -->
		<title>Контроль параметров S.M.A.R.T. жёстких дисков через Zabbix</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Контроль параметров S.M.A.R.T. жёстких дисков через Zabbix</h1>

		<p>Специально для контроля исправности жёстких дисков была придумана технология <a href="https://ru.wikipedia.org/wiki/S.M.A.R.T.">S.M.A.R.T.</a>. Если все жёсткие диски компьютера включены в состав RAID-массива с избыточностью, то следить за параметрами S.M.A.R.T. обычно не имеет особого смысла - о выходе из строя одного из жёстких дисков можно узнать по факту. Однако, не всегда бывает оправдано использовать RAID-массивы. Иногда это бывает малокритичный сервер, на котором не хранится никаких данных и который можно довольно быстро настроить с нуля на новом компьютере. А может быть это один из однотипных серверов, между которыми распределяется общая нагрузка. В таких случаях может оказаться полезным отслеживать состояние жёсткого диска через S.M.A.R.T., чтобы устранить проблему не в режиме аварийно-восстановительных, а в режиме планово-профилактических работ, заранее подготовив замену, с минимальным перерывом в обслуживании и во время наименьшей нагрузки (или её отсутствия).</p>

		<p>Для контроля параметров S.M.A.R.T. на компьютере понадобится настроенный Zabbix-агент, а также установленные пакеты sudo и smartmontools.</p>

		<p>Во-первых, при помощи команды visudo, разрешим пользователям из группы zabbix выполнять команды для контроля состояния диска от имени пользователя root:</p>

		<pre class="code">%zabbix    ALL=(ALL) NOPASSWD:/usr/sbin/smartctl --scan, \
                              /usr/sbin/smartctl -i *, \
                              /usr/sbin/smartctl -H *, \
                              /usr/sbin/smartctl -A *</pre>

		<p>Во-вторых, добавим в файл конфигурации Zabbix-агента /etc/zabbix/zabbix_agentd.conf следующие "пользовательские параметры":</p>

		<pre class="code">UserParameter=smart.list,/usr/bin/sudo /usr/sbin/smartctl --scan | /usr/bin/awk 'BEGIN { printf "{\"data\": ["; } { if (NR != 1) printf ","; printf "{\"{#SMART}\": \"%s\"}", $1; } END { printf "]}"; }'
UserParameter=smart.model[*],/usr/bin/sudo /usr/sbin/smartctl -i $1 2&gt;&amp;1 | /usr/bin/awk -F: '$$1 ~ /^Device Model$/ { gsub(/(^ +| +$)/, "", $$2); print $$2; }'
UserParameter=smart.serial[*],/usr/bin/sudo /usr/sbin/smartctl -i $1 2&gt;&amp;1 | /usr/bin/awk -F: '$$1 ~ /^Serial Number$/ { gsub(/(^ +| +$)/, "", $$2); print $$2; }'
UserParameter=smart.health[*],/usr/bin/sudo /usr/sbin/smartctl -H $1 2&gt;&amp;1 | /usr/bin/awk 'BEGIN { h = 0; } / (OK|PASSED)$/ { h = 1; } END { print h; }'
UserParameter=smart.reallocated[*],/usr/bin/sudo /usr/sbin/smartctl -A $1 2&gt;&amp;1 | /usr/bin/awk '/^  5 / { print $$10; }'
UserParameter=smart.pending[*],/usr/bin/sudo /usr/sbin/smartctl -A $1 2&gt;&amp;1 | /usr/bin/awk '/^197 / { print $$10; }'
UserParameter=smart.temperature[*],/usr/bin/sudo /usr/sbin/smartctl -A $1 2&gt;&amp;1 | /usr/bin/awk '/^194 / { print $$10; }'</pre>

		<p>После внесения изменений в конфигурацию Zabbix-агента, не забудьте его перезапустить:</p>

		<pre class="console"># /etc/init.d/zabbix-agent restart</pre>

		<p>Я подготовил два шаблона для контроля параметров S.M.A.R.T.:</p>

		<ul>
			<li><a href="Template_App_SMART.xml">Template_App_SMART.xml</a> - шаблон с элементами данных типа "Zabbix-агент",</li>

			<li><a href="Template_App_SMART_Active.xml">Template_App_SMART_Active.xml</a> - шаблон с элементами данных типа "Zabbix-агент (активный)".</li>
		</ul>

		<p>В обоих шаблонах имеется элемент данных для низкоуровневого обнаружения, который находит все имеющиеся в системе диски, поддерживающие S.M.A.R.T.:</p>

		<img src="smart_lld.png" />

		<p>Есть прототипы элементов данных, с помощью которых контролируется: статус здоровья диска, количество перемещённых секторов, секторов, ожидающих перемещения, температура жёсткого диска. Значения этих данных для каждого из жёстких дисков снимаются раз в 10 минут. Раз в час для каждого жёсткого диска запрашивается модель и серийный номер - они могут пригодиться, когда понадобится заменить один из жёстких дисков:</p>

		<img src="smart_itemprototypes.png" />

		<p>Имеется три прототипа триггеров, который будут созданы для каждого обнаруженного жёсткого диска. Самый главный триггер срабатывает в том случае, когда S.M.A.R.T. явным образом сообщает о неисправности диска. Два других триггера срабатывают при превышении лимита неисправных секторов или секторов, ожидающих перемещения:</p>

		<img src="smart_triggerprototypes.png" />

		<p>Лимиты для двух последних триггеров можно задать через соответствующие макросы - {$SMART_REALLOCATED_LIMIT} и {$SMART_PENDING_LIMIT}:</p>

		<img src="smart_macros.png" />

		<p>На картинке заданы нулевые лимиты, поэтому триггеры будут срабатывать при появлении хотя бы одного подозрительного сектора на диске. Если вы посчитали, что проблемных секторов не так уж и много, то можно задать новые значения макросов индивидуально в самом наблюдаемом узле Zabbix. К сожалению, нельзя задать разные лимиты для разных жёстких дисков - макросы действуют на все диски в наблюдаемом узле. С другой стороны, если лимит повысили для одного жёсткого диска, то логично что и на другом жёстком диске не стоит бить тревогу, пока этот лимит не будет достигнут.</p>

		<p>S.M.A.R.T. умеет отдавать массу другой информации о состоянии диска. Довольно подробный список параметров есть на уже упомянутой странице в Wikipedia: <a href="https://ru.wikipedia.org/wiki/S.M.A.R.T.">S.M.A.R.T.</a> Не всегда S.M.A.R.T. успевает сообщить о неисправности жёсткого диска до того, как им и в самом деле становится невозможно пользоваться. Именно для этого я и добавил контроль двух выбранных мной параметров - количества перемещённых секторов и количества секторов, ожидающих перемещения. В случае роста этих счётчиков, можно заранее понять, что скоро S.M.A.R.T. может сообщить о неисправности диска. Иногда, правда, жёсткие диски продолжают исправно работать долгие годы, даже если на них уже есть десятки или даже сотни неисправных секторов. Поэтому вместо использования конкретных значений порогов срабатывания триггеров я и предусмотрел в шаблоне макросы, чтобы пороги можно было настраивать по месту. Лучше, всё же, не ждать появления десятков или сотен неисправных секторов, а менять диск заранее.</p>

		<p>Наконец, снимаемые данные выглядят следующим образом:</p>

		<img src="smart_lastdata.png" />

		<p><a href="mailto:vladimir@stupin.su?subject=Контроль параметров S.M.A.R.T. жёстких дисков через Zabbix">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
