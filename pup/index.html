<html>
	<head>
		<meta http-equiv="Content-Type" content="plain/html; charset=UTF-8" />
		<link rel="stylesheet" href="../styles.css" type="text/css" />
		<meta name="keywords" content="pup,c,игры" />
		<meta name="author" content="Владимир Ступин" />
		<!-- 2013-01-20 -->
		<title>Распаковщик и упаковщик игровых ресурсов PUP</title>
	</head>
	<body>
		<p><a href="..">&larr;</a></p>

		<h1>Распаковщик и упаковщик игровых ресурсов PUP</h1>

		<h2>1. Предыстория.</h2>

		<p>В начале 2000-х годах я любил ковыряться в играх и доставать из них различные ресурсы - графику, звуки, модели. Моими главными и единственными инструментами тогда были шестнадцатеричные редакторы pview и hiew, компиляторы Pascal и C/C++. Наковырял я довольно много, правда тогда мне было интересно только доставать из игр ресурсы, но не делать инструменты для редактирования.</p>

		<p>Некоторые форматы файлов были проанализированы поверхностно - на уровне, достаточном для извлечения данных, но не более. Некоторые были проанализированы довольно хорошо, так что я даже смог реализовать не только извлечение данных, но и обратную упаковку.</p>

		<p>Спустя некоторое время я погряз в дебрях ООП, так что на проектирование объектной структуры программы стало уходить столько времени, что я не мог довести до конца ни одной программы. Это было началом "творческой депрессии", в результате которой я надолго забросил программирование.</p>

		<h2>2. История.</h2>

		<p>В сентябре 2010 года я решил тряхнуть стариной и написать программу для распаковки и упаковки файлов с игровыми ресурсами. Чтобы не повторять прошлых ошибок, писать я решил на чистом C, без использования ООП. Я спроектировал плагинную систему и решил реализовать в этой программе поддержку только тех форматов, которые хорошо на неё ложатся.</p>

		<p>К февралю 2011 года я практически завершил разработку программы, планируя добавить поддержку ещё одного формата (IWAD/PWAD). С этим форматом возникли сложности и работа застопорилась. Хотя я периодически вспоминал о программе и пытался доделать поддержку этого формата, в конце концов я нашёл какое-то более интересное занятие и забыл об этой программе.</p>

		<p>Недавно я о ней вспомнил и подумал - не пропадать же добру, может кому пригодится. Попробовал собрать, исправил пару ошибок, из-за которых сборка не шла, удалил зачатки неудавшегося плагина и решил выложить всё это.</p>

		<p>Поскольку к 2010 году я уже пользовался Debian'ом, то программа тоже делалась на нём. Сборка осуществляется с помощью shell-скрипта, для сборки нужны пакеты gcc, zlib1g, zlib1g-dev. Сборка в других системах не тестировалась.</p>

		<p>Кстати, большинство игр прекрасно работает в wine и dosbox'е. Все я не тестировал, но думаю, что на самом деле работают все.</p>

		<h2>3. Программа.</h2>

		<p>Программа называется PUP - Packer/UnPacker (слово pup также можно перевести с английского как "щенок"). Программа имеет несколько режимов работы:</p>

		<ol>
			<li>Если программа запущена без опций, выводится справка по доступным опциям.</li>

			<li>При указании опции --list программа выводит описание всех доступных плагинов.</li>

			<li>
				<p>При указании опции --unpack, программа попытается определить формат указанного ей файла и распакует его содержимое в указанный каталог, а метаданные файла сохранит в указанный файл.</p>

				<p>Если имя файла метаданных не указано, используется имя каталога с добавленным к нему расширением ".txt".</p>

				<p>Если имя каталога не указано, используется имя файла без расширения.</p>

				<p>Чтобы программа не пыталась определить формат файла самостоятельно, можно указать опцию --plugin с указанием определённого формата.</p>
			</li>

			<li>
				<p>При указании опции --pack, программа запакует данные в указанный файл из указанного каталога с использованием метаданных из указанного файла.</p>

				<p>Если имя файла метаданных не указано, используется имя каталога с добавленным к нему расширением ".txt".</p>

				<p>Если имя каталога не указано, используется имя файла без расширения.</p>

				<p>При упаковке обязательно указать опцию --plugin с указанием формата формируемого файла.</p>
			</li>

			<li>
				<p>При указании опции --savemeta, программа пытается определить формат указанного ей файла и сохранить метаданные в указанный файл. Если плагин не содержит метаданных, программа сообщит об этом и завершит работу.</p>

				<p>Если имя файла метаданных не указано, используется имя исходного файла с расширением, заменённым на ".txt".</p>

				<p>Чтобы программа не пыталась определить формат файла самостоятельно, можно указать опцию --plugin с указанием определённого формата.</p>
			</li>

			<li>
				<p>При указании опции --print, программа выводит на стандартный вывод техническую информацию из каталога ресурсов указанного файла (смещение ресурса, его сжатый и исходный размер, название ресурса и т.п.).</p>

				<p>Чтобы программа не пыталась определить формат файла самостоятельно, можно указать опцию --plugin с указанием определённого формата.</p>
			</li>
		</ol>

		<p>Справка программы:</p>

		<pre class="console">$ ./pup
Usage: pup --list
       pup --plugin &lt;plugin&gt; --pack &lt;file&gt; [&lt;dir&gt; [&lt;meta&gt;]]
       pup [--plugin &lt;plugin&gt;] --unpack &lt;file&gt; [&lt;dir&gt; [&lt;meta&gt;]]
       pup [--plugin &lt;plugin&gt;] --savemeta &lt;file&gt; [&lt;meta&gt;]
       pup [--plugin &lt;plugin&gt;] --print &lt;file&gt;
Options:
       --plugin &lt;plugin&gt;   - specify certain plugin
Modes:
       --list     - list of all supported plugins
       --pack &lt;file&gt; [&lt;dir&gt; [&lt;meta&gt;]]  - packing dir to specified file
       --unpack &lt;file&gt; [&lt;dir&gt; [&lt;meta&gt;]]  - unpacking specified file to dir
       --savemeta &lt;file&gt; [&lt;meta&gt;]  - only save metadata to specified metafile
       --print &lt;file&gt;    - print technical information to stdout</pre>

		<p>Список поддерживаемых форматов:</p>

		<pre class="console">$ ./pup --list
Supported plugins:
grp     GRP-files of Duke Nukem 3D, Witchaven, Redneck Rampage, Shadow Warrior
gob     GOB-files of Star Wars: Dark Forces
pak     PAK-files of Dune II: The Building of a Dynasty
viv     VIV-files of the Need For the Speed 3: Hot Pursuit
vpp     VPP-files of Red Faction, The Punisher, Summoner
pack    PAK-files of Quake, Quake II, Half-Life, Heretic 2, MDK 2
pack2   PAK-files of Daikatana
wad2    WAD-file of Quake
wad3    WAD-files of Half-Life
res     RES-file of Comanche 3
dpk4    DPK-file of Starmageddon 2
dat     DAT-files of Fallout
dat2    DAT-files of Fallout 2
rff20   RFF-files of Blood, version 2.0
rff30   RFF-files of Blood, version 3.0
rff31   RFF-files of Blood, version 3.1</pre>

		<p>Программа отлично справляется с определением типа исходного файла, поэтому используемый плагин указывать совершенно не обязательно. Плагин нужно указывать только при упаковке, чтобы программа сформировала файл нужного вам формата.</p>

		<p>Метаданные используются только в формате RFF. Метаданные - это дополнительные информационные поля, сопровождающие каждый упакованный файл. Эти поля никак нельзя восстановить по содержимому самого файла, поэтому при распаковке RFF-файла нужно сохранить эти поля в текстовый файл, а при упаковке - загрузить их из текстового файла.</p>

		<p>Есть много различных упаковщиков и распаковщиков файлов игр. Уникальность моей программы заключается в поддержке форматов pak-файлов Daikatana, res-файлов Comanche 3 и rff-файлов Blood.</p>

		<p>Формат pak-файлов Daikatana и его алгоритм компрессии я анализировал сам. Сам же написал декомпрессор, что было довольно легко, и компрессор, что оказалось значительно сложнее. Я не силён в алгоритмах сжатия, поэтому компрессор работает довольно медленно, однако сжимает он лучше, чем компрессор разработчиков. Распаковка и упаковка была реализована 15 сентября 2002, а более эффективная версия упаковщика -  20 октября 2002.</p>

		<p>Формат res-файлов Comanche 3 я тоже анализировал сам. Сложность анализа этого формата заключалась в том, что имена ресурсов в нём были зашифрованы, так что просто глазами найти имена файлов оказалось непросто.</p>

		<p>Тогда у меня была самописная программа, которая позволяла находить в произвольном файле содержащиеся в нём файлы определённых форматов по их сигнатурам. Например, wav-файлы и avi-файлы находились по сигнатуре RIFF (плюс дополнительные проверки), PCX-файлы находились по характерной для них сигнатуре и т.п. С помощью этой программы я нашёл в res-файле Comanche 3 точки начала нескольких файлов. Рядом с ними я увидел их размеры и какие-то смещения. И ещё были поля с непонятным содержимым. Я написал программу, которая выводила мне каталог всех ресурсов и смогла их распаковать в файлы, имена которых составлялись из порядкового номера ресурса.</p>

		<p>Дальше я заметил в тех непонятных записях, что последние байты часто бывают одинаковыми и сделал предположение, что это - результат шифрования байта со значением 0 операцией XOR. Я подумал, что в конце имени файла обычно бывает его расширение и нашёл ресурсы, формат которых мне известен. Так я восстановил четырёхбайтовый ключ шифрования, который для шифрования 12-байтового имени файла использовался трижды. Первая программа была написана 09 февраля 2003 и умела только распаковывать ресурсы.</p>

		<p>С rff-файлами Blood всё оказалось и проще и сложнее. Информацию об алгоритме шифрования файлов я нашёл в Интернете, однако она подходила не ко всем найденным мной файлам rff. Я нашёл несколько разных версий утилиты BARF для создания новых файлов для Blood и попробовал сформировать ими новые файлы. Так я нашёл три разных формата rff-файлов, распаковку и упаковку которых и реализовал. Однако, игра не захотела работать с родными файлами, обработанными распаковкой и упаковкой. В конце концов я реализовал сохранение и загрузку метаданных rff-файлов при их распаковке и упаковке соответственно. Приём сработал и Blood стал работать с пересобранными файлами.</p>

		<p>С остальными форматами всё было проще. Некоторые я проанализировал сам, о некоторых почитал в интернете.</p>

		<p>Архив с исходными текстами программы можно скачать <a href="https://stupin.su/git/stupin/pup/archive/master.tar.gz">здесь</a>. Там же есть текстовый файлик с именем ideas.txt, в котором я записывал идеи и отмечал этапы разработки программы.</p>

		<p><a href="mailto:vladimir@stupin.su?subject=Распаковщик и упаковщик игровых ресурсов PUP">Написать автору</a></p>

		<p><a href="..">&larr;</a></p>
	</body>
</html>
